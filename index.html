<!doctype html>
<!--
  English Learning Journey — Interactive Learning Platform
  © 2025 A.Cherifi — All Rights Reserved
  
  A comprehensive educational platform for teaching English to children
  Perfect for English-native and Arabic-speaking children learning English
  Features: 11 Learning Stages • Interactive Games • Speech Synthesis • Progress Tracking
-->
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>English Learning Journey — Interactive Learning Platform</title>
  <meta name="description" content="Interactive learning platform for teaching English to children. Perfect for English-native and Arabic-speaking children learning English through an engaging journey." />
  <meta name="author" content="A.Cherifi" />
  <meta name="copyright" content="© 2025 A.Cherifi — All Rights Reserved" />
  <meta name="theme-color" content="#4a90e2" />
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🔤</text></svg>" />
  <link rel="manifest" href="data:application/json,{&quot;name&quot;:&quot;English Learning Journey&quot;,&quot;short_name&quot;:&quot;EnglishJourney&quot;,&quot;start_url&quot;:&quot;.&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;background_color&quot;:&quot;#f7fbff&quot;,&quot;theme_color&quot;:&quot;#4a90e2&quot;}" />
  <style>
    :root{
      --bg:#f8fafc; --card:#fefefe; --accent:#4a90e2; --muted:#6b7280; --success:#10b981;
      --warning:#f59e0b; --error:#ef4444; --info:#3b82f6;
      --radius:14px; --gap:14px; 
      --font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      --font-family-arabic: 'Noto Sans Arabic', 'Arial Unicode MS', sans-serif;
      --shadow: 0 4px 12px rgba(10,10,20,0.04);
      --shadow-hover: 0 6px 20px rgba(10,10,20,0.08);
      --text: #1e293b;
      --card-bg: #fefefe;
      --muted-bg: #f1f5f9;
      --text-primary: #334155;
      --text-secondary: #64748b;
      --primary-color: #3b82f6;
      --button-bg: #f1f5f9;
      --button-text: #1e293b;
      --button-border: #e2e8f0;
      --button-secondary: #64748b;
      --success-bg: #f0fdf4;
      --success-color: #059669;
      --border: #e2e8f0;
      --hover-bg: #f1f5f9;
      --accent-bg: #f0f9ff;
    }
    
    /* Quiz button hover effects for light mode */
    .quiz-button:hover {
      background: var(--primary-color, #4a90e2) !important;
      color: white !important;
      border-color: var(--primary-color, #4a90e2) !important;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(74, 144, 226, 0.3);
    }
    
    *{box-sizing:border-box}
    
    html,body{
      height:100%;margin:0;
      background:linear-gradient(180deg,#f1f5f9, var(--bg)); 
      color:var(--text);
      font-family: var(--font-family);
      line-height: 1.6;
    }
    
    /* Header */
    header{
      background:rgba(254,254,254,0.95);
      -webkit-backdrop-filter:blur(10px);
      backdrop-filter:blur(10px);
      border-bottom:1px solid rgba(0,0,0,0.05);
      border-radius:var(--radius);
      margin-bottom:20px;
    }
    
    .header-top{
      display:flex;align-items:center;justify-content:space-between;
      padding:18px 20px;gap:10px;
    }
    
    /* Horizontal Stage Navigation */
    .stage-nav-container{
      background:var(--muted-bg);
      border-top:1px solid var(--border);
      padding:12px 20px;
      overflow-x:auto;
    }
    
    .progress-section{
      margin-top:12px;
      padding-top:12px;
      border-top:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
      gap:12px;
    }
    
    .achievements{
      font-size:0.9rem;
      color:var(--muted);
    }
    
    .stage-nav{
      display:grid;
      grid-template-columns:repeat(5, 1fr);
      gap:8px;
      min-width:max-content;
    }
    
    /* Responsive adjustments for stage navigation */
    @media (max-width: 1200px) {
      .stage-nav {
        grid-template-columns: repeat(4, 1fr);
      }
    }
    
    @media (max-width: 900px) {
      .stage-nav {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    
    @media (max-width: 600px) {
      .stage-nav {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    .stage-nav-item{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:4px;
      padding:8px 12px;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:8px;
      cursor:pointer;
      transition:all 0.2s ease;
      text-decoration:none;
      color:var(--text);
      font-size:0.8rem;
      min-width:80px;
    }
    
    .stage-nav-item:hover{
      background:var(--hover-bg);
      transform:translateY(-1px);
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
    }
    
    .stage-nav-item.active{
      background:var(--accent);
      color:white;
      border-color:var(--accent);
    }
    
    .stage-nav-item.locked{
      opacity:0.5;
      cursor:not-allowed;
      background:var(--muted-bg);
    }
    
    .stage-nav-item .stage-emoji{
      font-size:1.2rem;
    }
    
    .stage-nav-item .stage-name{
      font-weight:600;
      text-align:center;
      line-height:1.2;
    }
    
    .stage-nav-item .stage-number{
      font-size:0.7rem;
      opacity:0.7;
    }
    
    /* Header Controls Styling */
    .controls{
      display:flex;
      align-items:center;
      gap:16px;
    }
    
    .settings-group{
      display:flex;
      align-items:center;
      gap:12px;
      padding:8px 12px;
      background:var(--muted-bg);
      border-radius:8px;
      border:1px solid var(--border);
    }
    
    .settings-group label{
      margin:0;
      font-size:0.9rem;
    }
    
    .action-buttons{
      display:flex;
      align-items:center;
      gap:8px;
    }
    
    @media (max-width:768px){
      .controls{
        flex-direction:column;
        gap:8px;
        align-items:stretch;
      }
      
      .settings-group{
        justify-content:center;
      }
      
      .action-buttons{
        justify-content:center;
        flex-wrap:wrap;
      }
    }
    
    h1{
      font-size:1.5rem;margin:0;
      background:linear-gradient(135deg, var(--accent), #357abd);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
    }
    
    .container{max-width:1200px;margin:0 auto;padding:12px}
    
    .controls{
      display:flex;gap:10px;align-items:center;
      flex-wrap:wrap;
    }
    
    button{
      background:var(--accent);color:white;border:none;
      padding:10px 16px;border-radius:12px;cursor:pointer;
      font-weight:600;font-size:0.9rem;
      transition:all 0.2s ease;
      box-shadow:0 2px 8px rgba(74,144,226,0.2);
    }
    
    button:hover{
      transform:translateY(-1px);
      box-shadow:0 4px 12px rgba(74,144,226,0.3);
    }
    
    button:active{transform:translateY(0)}
    button:focus{outline:3px solid rgba(74,144,226,0.25)}
    
    button.ghost{
      background:transparent;color:var(--accent);
      border:2px solid var(--accent);
    }
    
    button.ghost:hover{
      background:var(--accent);color:white;
    }
    
    button:disabled{
      opacity:0.5;cursor:not-allowed;
      transform:none !important;
    }
    
    .stage-button.locked{
      opacity:0.4;cursor:not-allowed;
      background:linear-gradient(135deg,#9ca3af,#6b7280);
    }
    
    .stage-button.locked:hover{
      transform:none !important;
      box-shadow:none !important;
    }
    
    /* Main Layout */
    main{
      display:block;padding:20px;
      min-height:calc(100vh - 200px);
    }
    
    .game-area{
      width:100%;
      max-width:1200px;
      margin:0 auto;
    }
    
    /* Responsive Design for Stage Navigation */
    @media (max-width:1200px){
      .stage-nav{
        grid-template-columns:repeat(4, 1fr);
      }
    }
    
    @media (max-width:900px){
      .stage-nav{
        grid-template-columns:repeat(3, 1fr);
      }
    }
    
    @media (max-width:768px){
      .stage-nav{
        grid-template-columns:repeat(2, 1fr);
      }
      .stage-nav-item{
        min-width:70px;
        padding:6px 8px;
        font-size:0.75rem;
      }
      .stage-nav-item .stage-name{
        font-size:0.7rem;
      }
    }
    
    @media (max-width:480px){
      .stage-nav{
        grid-template-columns:repeat(2, 1fr);
      }
      .stage-nav-item{
        min-width:60px;
        padding:4px 6px;
        font-size:0.7rem;
      }
      .stage-nav-item .stage-name{
        font-size:0.65rem;
      }
    }
    
    @media (max-width:1024px){
      main{padding:16px}
    }
    
    @media (max-width:768px){
      main{padding:12px}
    }
    
    .card{
      background:var(--card);border-radius:var(--radius);
      padding:20px;box-shadow:var(--shadow);
      border:1px solid rgba(0,0,0,0.03);
    }
    
    .left .levels{display:flex;flex-direction:column;gap:8px}
    
    /* Letters Grid */
    .letters-grid{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:16px;
    }
    
    @media (max-width:768px){.letters-grid{grid-template-columns:repeat(auto-fit,minmax(120px,1fr))}}
    @media (max-width:480px){.letters-grid{grid-template-columns:repeat(auto-fit,minmax(100px,1fr))}}
    
    .letter-card{
      transition:all 0.3s ease;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
    }
    
    .letter-card:hover{
      transform:translateY(-4px);
      box-shadow:0 6px 20px rgba(0,0,0,0.15);
      border-color:var(--accent) !important;
    }
    
    .letter-card.matched{
      background:linear-gradient(135deg, #e8f5e8, #f0f9ff) !important;
      border-color:var(--success) !important;
    }
    
    .letter-tile{
      display:flex;align-items:center;justify-content:center;
      height:70px;border-radius:12px;font-weight:700;font-size:1.2rem;
      background:linear-gradient(135deg,#4a90e2,#357abd);
      color:white;cursor:pointer;border:2px solid #2c5aa0;
      transition:all 0.3s ease;box-shadow:0 3px 10px rgba(0,0,0,0.15);
      -webkit-user-select:none;
      user-select:none;
    }
    
    .letter-tile:hover{
      transform:translateY(-3px) scale(1.05);
      box-shadow:0 8px 20px rgba(74,144,226,0.4);
      background:linear-gradient(135deg,#5ba0f2,#4a90e2);
    }
    
    .letter-tile:focus{
      outline:3px solid rgba(74,144,226,0.25);
      transform:translateY(-2px);
    }
    
    .letter-tile.locked{
      opacity:0.4;cursor:not-allowed;
      background:linear-gradient(135deg,#9ca3af,#6b7280);
    }
    
    .letter-tile.matched{
      background:linear-gradient(135deg,#10b981,#059669);
      border-color:#10b981;
      animation:successPulse 0.6s ease;
    }
    
    @keyframes successPulse{
      0%,100%{transform:scale(1)}
      50%{transform:scale(1.1)}
    }
    
    /* Game Area */
    .game-area{display:flex;flex-direction:column;gap:16px}
    
    .flashcard{
      display:flex;align-items:center;justify-content:space-between;
      padding:24px;border-radius:16px;
      background:linear-gradient(135deg,#f8fafc,#ffffff);
      border:1px solid rgba(0,0,0,0.05);
      box-shadow:var(--shadow);
    }
    
    .word-build{display:flex;gap:10px;flex-wrap:wrap}
    
    .draggable{
      padding:10px 12px;border-radius:12px;
      background:var(--muted-bg);border:2px dashed var(--border);
      cursor:grab;transition:all 0.2s ease;
      -webkit-user-select:none;
      user-select:none;
      font-weight:500;
      color:var(--text);
    }
    
    .draggable:hover{
      background:var(--hover-bg);transform:scale(1.05);
      border-color:var(--accent);
    }
    
    .draggable:active{cursor:grabbing}
    
    .dropzone{
      min-height:70px;padding:12px;border-radius:12px;
      border:2px dashed #cbd5e1;
      background:linear-gradient(180deg,#fff,#fafcff);
      transition:all 0.3s ease;
    }
    
    .dropzone.drag-over{
      background:linear-gradient(180deg,#f0f9ff,#e0f2fe);
      border-color:var(--accent);
      transform:scale(1.02);
    }
    
    .progress{
      display:flex;align-items:center;gap:10px;
      flex-wrap:wrap;
    }
    
    .badge{
      background:var(--success);color:white;
      padding:6px 10px;border-radius:10px;
      font-weight:600;font-size:0.85rem;
    }
    
    .badge.warning{background:var(--warning)}
    .badge.error{background:var(--error)}
    .badge.info{background:var(--info)}
    
    /* Accessibility */
    .sr-only{
      position:absolute;width:1px;height:1px;
      padding:0;margin:-1px;overflow:hidden;
      clip:rect(0,0,0,0);white-space:nowrap;border:0
    }
    
    /* Focus indicators */
    *:focus{outline:2px solid var(--accent);outline-offset:2px}
    
    /* High contrast mode support */
    @media (prefers-contrast: high) {
      :root {
        --bg: #ffffff;
        --card: #ffffff;
        --accent: #0000ff;
        --muted: #000000;
      }
    }
    
    /* Footer responsive design */
    @media (max-width: 768px) {
      footer .container > div:first-child {
        grid-template-columns: 1fr !important;
        gap: 24px !important;
      }
      
      footer h3 {
        font-size: 1.1rem !important;
      }
      
      footer h4 {
        font-size: 0.95rem !important;
      }
    }
    
    /* Reduced motion support */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
    
    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0f172a;
        --card: #1e293b;
        --muted: #94a3b8;
        --card-bg: #1e293b;
        --secondary-bg: #334155;
        --text-primary: #f1f5f9;
        --text-secondary: #94a3b8;
        --primary-color: #60a5fa;
        --button-bg: #334155;
        --button-text: #f1f5f9;
        --button-border: #475569;
        --button-secondary: #64748b;
        --success-bg: #064e3b;
        --success-color: #10b981;
        --border: #475569;
      }
      
      html, body {
        background: linear-gradient(180deg, #0f172a, var(--bg));
        color: #f8fafc;
      }
      
      /* Dark mode button hover effects */
      button:hover {
        background: var(--button-hover, #4b5563) !important;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      }
      
      /* Quiz button hover effects */
      .quiz-button:hover {
        background: var(--primary-color, #4a90e2) !important;
        color: white !important;
        border-color: var(--primary-color, #4a90e2) !important;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(74, 144, 226, 0.3);
      }
      
      .card {
        border-color: rgba(255,255,255,0.1);
      }
    }
    
    /* Dark mode class for manual toggle */
    .dark-mode {
      --bg: #1a1a1a !important;
      --card: #2d2d2d !important;
      --muted: #a0a0a0 !important;
      --text: #f8fafc !important;
      --card-bg: #2d2d2d !important;
      --muted-bg: #374151 !important;
      --border: #4b5563 !important;
      --hover-bg: #4b5563 !important;
      --accent-bg: #1e3a8a !important;
      --accent: #60a5fa !important;
    }
    
    /* Ensure text visibility in dark mode */
    .dark-mode #currentLabel {
      color: #000000 !important;
      font-weight: 900 !important;
    }
    
    .dark-mode #labelSub {
      color: #000000 !important;
      opacity: 1 !important;
      font-weight: 600 !important;
    }
    
    .dark-mode #transliteration {
      color: #000000 !important;
      opacity: 1 !important;
      font-weight: 500 !important;
    }
    
    /* Ensure card background is white in dark mode for text visibility */
    .dark-mode .card {
      background: #ffffff !important;
      border: 2px solid #e5e7eb !important;
    }
    
    .dark-mode .flashcard {
      background: #ffffff !important;
      border: 2px solid #e5e7eb !important;
    }
    
    .dark-mode html,
    .dark-mode body {
      background: linear-gradient(180deg, #0f172a, var(--bg)) !important;
      color: #f8fafc !important;
    }
    
    .dark-mode .card {
      background: var(--card) !important;
      color: #f8fafc !important;
      border-color: #404040 !important;
    }
    
    .dark-mode h1,
    .dark-mode h2,
    .dark-mode h3,
    .dark-mode h4,
    .dark-mode h5,
    .dark-mode h6 {
      color: #f8fafc !important;
    }
    
    .dark-mode p,
    .dark-mode span,
    .dark-mode div {
      color: #e5e7eb !important;
    }
    
    .dark-mode button {
      background: #374151 !important;
      color: #f8fafc !important;
      border-color: #4b5563 !important;
    }
    
    .dark-mode button:hover {
      background: #4b5563 !important;
    }
    
    .dark-mode input,
    .dark-mode select,
    .dark-mode textarea {
      background: #374151 !important;
      color: #f8fafc !important;
      border-color: #4b5563 !important;
    }
    
    .dark-mode .badge {
      background: #1f2937 !important;
      color: #f8fafc !important;
    }
    
    .dark-mode .ghost {
      color: #9ca3af !important;
    }
    
    .dark-mode .ghost:hover {
      background: #374151 !important;
      color: #f8fafc !important;
    }
    
    .dark-mode header {
      background: rgba(45, 45, 45, 0.95) !important;
      border-bottom-color: rgba(255, 255, 255, 0.1) !important;
    }
    
    .dark-mode .stage-nav-container {
      background: var(--muted-bg) !important;
      border-top-color: var(--border) !important;
    }
    
    .dark-mode .stage-nav-item {
      background: var(--card) !important;
      border-color: var(--border) !important;
      color: var(--text) !important;
    }
    
    .dark-mode .stage-nav-item:hover {
      background: var(--hover-bg) !important;
    }
    
    .dark-mode .stage-nav-item.active {
      background: var(--accent) !important;
      color: white !important;
    }
    
    .dark-mode .stage-nav-item.locked {
      background: var(--muted-bg) !important;
      opacity: 0.5;
    }
    
    .dark-mode .stage-nav-item:hover {
      background: var(--hover-bg) !important;
    }
    
    .dark-mode .stage-nav-item.active {
      background: var(--accent) !important;
      color: white !important;
    }
    
    .dark-mode .stage-nav-item.locked {
      background: var(--muted-bg) !important;
      opacity: 0.5;
    }
    
    .dark-mode .stage-nav-item:hover {
      background: var(--hover-bg) !important;
    }
    
    .dark-mode .stage-nav-item.active {
      background: var(--accent) !important;
      color: white !important;
    }
    
    .dark-mode .stage-nav-item.locked {
      background: var(--muted-bg) !important;
      opacity: 0.5;
    }
    
    .dark-mode .settings-group {
      background: var(--muted-bg) !important;
      border-color: var(--border) !important;
    }
    
    .dark-mode .settings-group label {
      color: var(--text) !important;
    }
    
    .dark-mode .progress-section {
      border-top-color: var(--border) !important;
    }
    
    .dark-mode .achievements {
      color: var(--muted) !important;
    }
    
    /* Dark mode styles for stories */
    .dark-mode .story-card {
      background: var(--card) !important;
      border-color: var(--border) !important;
      color: var(--text) !important;
    }
    
    .dark-mode .story-card h4 {
      color: var(--accent) !important;
    }
    
    .dark-mode .story-card p {
      color: var(--text) !important;
    }
    
    .dark-mode .story-card .level-badge {
      background: var(--accent-bg) !important;
      color: var(--accent) !important;
    }
    
    .dark-mode .stories-container {
      background: transparent !important;
    }
    
    .dark-mode .story-filter {
      background: var(--muted-bg) !important;
      border-color: var(--border) !important;
    }
    
    .dark-mode .story-filter h4 {
      color: var(--accent) !important;
    }
    
    .dark-mode .story-filter button {
      background: var(--muted-bg) !important;
      color: var(--text) !important;
      border-color: var(--border) !important;
    }
    
    .dark-mode .story-filter button.active {
      background: var(--accent) !important;
      color: white !important;
    }
    
    .dark-mode .story-stats {
      background: var(--muted-bg) !important;
    }
    
    .dark-mode .story-stats .stat-item {
      background: var(--card) !important;
      color: var(--text) !important;
    }
    
    .dark-mode .story-stats .stat-number {
      color: var(--accent) !important;
    }
    
    .dark-mode .story-stats .stat-label {
      color: var(--muted) !important;
    }
    
    .dark-mode .story-stats {
      background: var(--muted-bg) !important;
      border-left-color: var(--accent) !important;
    }
    
    .dark-mode .story-stats h4 {
      color: var(--accent) !important;
    }
    
    .dark-mode .story-card button {
      background: var(--accent) !important;
      color: white !important;
    }
    
    .dark-mode .story-card button:hover {
      background: var(--accent) !important;
      opacity: 0.9;
    }
    
    .dark-mode .story-card button:nth-child(2) {
      background: var(--success) !important;
    }
    
    .dark-mode .story-card button:nth-child(3) {
      background: var(--warning) !important;
    }
    
    .dark-mode .story-card button:nth-child(2):hover {
      background: var(--success) !important;
      opacity: 0.9;
    }
    
    .dark-mode .story-card button:nth-child(3):hover {
      background: var(--warning) !important;
      opacity: 0.9;
    }
    
    .dark-mode .story-card button:nth-child(1):hover {
      background: var(--accent) !important;
      opacity: 0.9;
    }
    
    .dark-mode .story-card button:nth-child(1) {
      background: var(--accent) !important;
    }
    
    .dark-mode .story-card button:nth-child(2) {
      background: var(--success) !important;
    }
    
    .dark-mode .story-card button:nth-child(3) {
      background: var(--warning) !important;
    }
    
    .dark-mode .game-area {
      background: var(--card) !important;
      color: var(--text) !important;
    }
    
    /* Dark mode styles for Listening & Speaking */
    .dark-mode .listening-exercises {
      background: transparent !important;
    }
    
    .dark-mode .exercise-section {
      background: var(--card) !important;
      border-color: var(--border) !important;
    }
    
    .dark-mode .exercise-section h4 {
      color: var(--accent) !important;
    }
    
    .dark-mode .exercise-section p {
      color: var(--muted) !important;
    }
    
    .dark-mode .exercise-section span {
      color: var(--text) !important;
    }
    
    .dark-mode .exercise-section div {
      background: var(--muted-bg) !important;
    }
    
    .dark-mode .exercise-section button {
      background: var(--accent) !important;
      color: white !important;
    }
    
    .dark-mode .exercise-section button:hover {
      background: var(--accent) !important;
      opacity: 0.9;
    }
    
    .dark-mode .speaking-tips {
      background: var(--muted-bg) !important;
      border-color: var(--success) !important;
    }
    
    .dark-mode .speaking-tips h4 {
      color: var(--success) !important;
    }
    
    .dark-mode .speaking-tips li {
      color: var(--text) !important;
    }
    
    .dark-mode .exercise-section button {
      background: var(--accent) !important;
      color: white !important;
    }
    
    .dark-mode .exercise-section button:hover {
      background: var(--accent) !important;
      opacity: 0.9;
    }
    
    .dark-mode main {
      background: transparent !important;
    }
    
    /* Dark mode styles for Basic Grammar */
    .dark-mode .grammar-lessons {
      background: transparent !important;
    }
    
    .dark-mode .lesson-card {
      background: var(--card) !important;
      border-color: var(--border) !important;
    }
    
    .dark-mode .lesson-card h4 {
      color: var(--accent) !important;
    }
    
    .dark-mode .lesson-card strong {
      color: var(--accent) !important;
    }
    
    .dark-mode .lesson-card small {
      color: var(--muted) !important;
    }
    
    .dark-mode .lesson-card div {
      background: var(--muted-bg) !important;
      color: var(--text) !important;
    }
    
    .dark-mode .lesson-card .practice-exercise {
      background: var(--accent-bg) !important;
      border-color: var(--accent) !important;
    }
    
    .dark-mode .lesson-card .practice-exercise strong {
      color: var(--accent) !important;
    }
    
    .dark-mode .lesson-card .practice-exercise div {
      color: var(--text) !important;
    }
    
    .dark-mode .lesson-card .practice-exercise button {
      background: var(--primary-color, #60a5fa) !important;
      color: white !important;
    }
    
    .dark-mode .lesson-card .practice-exercise button:hover {
      background: var(--warning, #f59e0b) !important;
    }
    
    .dark-mode .lesson-card .answers-section {
      background: var(--success-bg, #064e3b) !important;
      border-color: var(--success-color, #10b981) !important;
    }

    .dark-mode .challenge-menu,
    .dark-mode .advanced-menu-content {
      background: var(--card) !important;
      border-color: var(--border) !important;
    }

    .dark-mode .challenge-menu button,
    .dark-mode .advanced-menu-content button {
      background: var(--card) !important;
      color: var(--text-primary) !important;
    }

    .dark-mode .challenge-menu button:hover,
    .dark-mode .advanced-menu-content button:hover {
      background: var(--hover-bg) !important;
    }
    
    .dark-mode .lesson-card .answers-section strong {
      color: var(--success-color, #10b981) !important;
    }
    
    .dark-mode .lesson-card .answers-section div {
      color: var(--text) !important;
    }
    
    .dark-mode .grammar-tips {
      background: var(--muted-bg) !important;
      border-color: var(--warning) !important;
    }
    
    .dark-mode .grammar-tips h4 {
      color: var(--warning) !important;
    }
    
    .dark-mode .grammar-tips li {
      color: var(--text) !important;
    }
    
    .dark-mode .lesson-card button {
      background: var(--accent) !important;
      color: white !important;
    }
    
    .dark-mode .lesson-card button:hover {
      background: var(--accent) !important;
      opacity: 0.9;
    }
    
    /* Dark mode styles for Reading Comprehension */
    .dark-mode .reading-passages {
      background: transparent !important;
    }
    
    .dark-mode .passage-card {
      background: var(--card) !important;
      border-color: var(--border) !important;
    }
    
    .dark-mode .passage-card h4 {
      color: var(--accent) !important;
    }
    
    .dark-mode .passage-card span {
      background: var(--accent-bg) !important;
      color: var(--accent) !important;
    }
    
    .dark-mode .passage-card div {
      background: var(--muted-bg) !important;
      color: var(--text) !important;
    }
    
    .dark-mode .passage-card button {
      background: var(--accent) !important;
      color: white !important;
    }
    
    .dark-mode .passage-card button:hover {
      background: var(--accent) !important;
      opacity: 0.9;
    }
    
    .dark-mode .questions-section {
      background: var(--muted-bg) !important;
    }
    
    .dark-mode .questions-section h5 {
      color: var(--success) !important;
    }
    
    .dark-mode .questions-section div {
      background: var(--card) !important;
      color: var(--text) !important;
    }
    
    .dark-mode .questions-section strong {
      color: var(--text) !important;
    }
    
    .dark-mode .questions-section .answer {
      color: var(--muted) !important;
    }
    
    .dark-mode .reading-tips {
      background: var(--muted-bg) !important;
      border-color: var(--info) !important;
    }
    
    .dark-mode .reading-tips h4 {
      color: var(--info) !important;
    }
    
    .dark-mode .reading-tips li {
      color: var(--text) !important;
    }
    
    /* Dark mode styles for Assessment & Certification */
    .dark-mode .assessment-content {
      background: transparent !important;
    }
    
    .dark-mode .assessment-section {
      background: var(--card) !important;
      border-color: var(--border) !important;
    }
    
    .dark-mode .assessment-section h4 {
      color: var(--accent) !important;
    }
    
    .dark-mode .assessment-section p {
      color: var(--text) !important;
    }
    
    .dark-mode .question-card {
      background: var(--muted-bg) !important;
    }
    
    .dark-mode .question-card strong {
      color: var(--text) !important;
    }
    
    .dark-mode .question-card div {
      background: var(--card) !important;
      border-color: var(--border) !important;
      color: var(--text) !important;
    }
    
    .dark-mode .question-card div:hover {
      border-color: var(--accent) !important;
    }
    
    .dark-mode .question-card button {
      background: var(--success) !important;
      color: white !important;
    }
    
    .dark-mode .question-card button:hover {
      background: var(--success) !important;
      opacity: 0.9;
    }
    
    .dark-mode .progress-summary {
      background: var(--muted-bg) !important;
      border-color: var(--accent) !important;
    }
    
    .dark-mode .progress-summary h4 {
      color: var(--accent) !important;
    }
    
    .dark-mode .progress-summary div {
      background: var(--card) !important;
      color: var(--text) !important;
    }
    
    .dark-mode .progress-summary .stat-number {
      color: var(--accent) !important;
    }
    
    .dark-mode .progress-summary .stat-label {
      color: var(--muted) !important;
    }
    
    .dark-mode .certificate {
      background: linear-gradient(135deg, var(--muted-bg), var(--card)) !important;
      border-color: var(--success) !important;
    }
    
    .dark-mode .certificate h3 {
      color: var(--success) !important;
    }
    
    .dark-mode .certificate p {
      color: var(--text) !important;
    }
    
    .dark-mode .certificate div {
      background: var(--card) !important;
    }
    
    .dark-mode .certificate h4 {
      color: var(--accent) !important;
    }
    
    .dark-mode .certificate .certificate-text {
      color: var(--text) !important;
    }
    
    .dark-mode .certificate .signature {
      color: var(--muted) !important;
    }
    
    .dark-mode .next-steps {
      background: var(--muted-bg) !important;
      border-color: var(--warning) !important;
    }
    
    .dark-mode .next-steps h4 {
      color: var(--warning) !important;
    }
    
    .dark-mode .next-steps li {
      color: var(--text) !important;
    }
    
    .dark-mode .next-steps button {
      background: var(--success) !important;
      color: white !important;
    }
    
    .dark-mode .next-steps button:hover {
      background: var(--success) !important;
      opacity: 0.9;
    }
    
    /* Dark mode styles for Practical Conversation */
    .dark-mode .conversation-sections {
      background: transparent !important;
    }
    
    .dark-mode .conversation-section {
      background: var(--card) !important;
      border-color: var(--border) !important;
    }
    
    .dark-mode .conversation-section h4 {
      color: var(--accent) !important;
    }
    
    .dark-mode .conversation-section div {
      background: var(--muted-bg) !important;
    }
    
    .dark-mode .conversation-section strong {
      color: var(--accent) !important;
    }
    
    .dark-mode .conversation-section .arabic-text {
      color: var(--text) !important;
    }
    
    .dark-mode .conversation-section .context-text {
      color: var(--muted) !important;
    }
    
    .dark-mode .conversation-section button {
      background: var(--accent) !important;
      color: white !important;
    }
    
    .dark-mode .conversation-section button:hover {
      background: var(--accent) !important;
      opacity: 0.9;
    }
    
    .dark-mode .conversation-tips {
      background: var(--muted-bg) !important;
      border-color: var(--info) !important;
    }
    
    .dark-mode .conversation-tips h4 {
      color: var(--info) !important;
    }
    
    .dark-mode .conversation-tips li {
      color: var(--text) !important;
    }
    
    /* Dark mode styles for Body Parts */
    .dark-mode .body-parts-content {
      background: transparent !important;
    }
    
    .dark-mode .body-category {
      background: var(--card) !important;
      border-color: var(--border) !important;
    }
    
    .dark-mode .body-category h4 {
      color: var(--accent) !important;
    }
    
    .dark-mode .body-part-card {
      background: var(--muted-bg) !important;
    }
    
    .dark-mode .body-part-card strong {
      color: var(--accent) !important;
    }
    
    .dark-mode .body-part-card .arabic-text {
      color: var(--text) !important;
    }
    
    .dark-mode .body-part-card button {
      background: var(--accent) !important;
      color: white !important;
    }
    
    .dark-mode .body-part-card button:hover {
      background: var(--accent) !important;
      opacity: 0.9;
    }
    
    .dark-mode .body-parts-tips {
      background: var(--muted-bg) !important;
      border-color: var(--info) !important;
    }
    
    .dark-mode .body-parts-tips h4 {
      color: var(--info) !important;
    }
    
    .dark-mode .body-parts-tips li {
      color: var(--text) !important;
    }
    
    /* Dark mode styles for Fruits & Vegetables */
    .dark-mode .fruits-vegetables-content {
      background: transparent !important;
    }
    
    .dark-mode .food-category {
      background: var(--card) !important;
      border-color: var(--border) !important;
    }
    
    .dark-mode .food-category h4 {
      color: var(--accent) !important;
    }
    
    .dark-mode .food-item-card {
      background: var(--muted-bg) !important;
    }
    
    .dark-mode .food-item-card strong {
      color: var(--accent) !important;
    }
    
    .dark-mode .food-item-card .arabic-text {
      color: var(--text) !important;
    }
    
    .dark-mode .food-item-card button {
      background: var(--accent) !important;
      color: white !important;
    }
    
    .dark-mode .food-item-card button:hover {
      background: var(--accent) !important;
      opacity: 0.9;
    }
    
    .dark-mode .food-tips {
      background: var(--muted-bg) !important;
      border-color: var(--info) !important;
    }
    
    .dark-mode .food-tips h4 {
      color: var(--info) !important;
    }
    
    .dark-mode .food-tips li {
      color: var(--text) !important;
    }
    
    /* Dark mode styles for Colors */
    .dark-mode .colors-content {
      background: transparent !important;
    }
    
    .dark-mode .color-category {
      background: var(--card) !important;
      border-color: var(--border) !important;
    }
    
    .dark-mode .color-category h4 {
      color: var(--accent) !important;
    }
    
    .dark-mode .color-item-card {
      background: var(--muted-bg) !important;
    }
    
    .dark-mode .color-item-card strong {
      color: var(--accent) !important;
    }
    
    .dark-mode .color-item-card .arabic-text {
      color: var(--text) !important;
    }
    
    .dark-mode .color-item-card button {
      background: var(--accent) !important;
      color: white !important;
    }
    
    .dark-mode .color-item-card button:hover {
      background: var(--accent) !important;
      opacity: 0.9;
    }
    
    .dark-mode .color-tips {
      background: var(--muted-bg) !important;
      border-color: var(--info) !important;
    }
    
    .dark-mode .color-tips h4 {
      color: var(--info) !important;
    }
    
    .dark-mode .color-tips li {
      color: var(--text) !important;
    }
    
    /* Dark mode styles for Numbers */
    .dark-mode .numbers-content {
      background: transparent !important;
    }
    
    .dark-mode .number-category {
      background: var(--card) !important;
      border-color: var(--border) !important;
    }
    
    .dark-mode .number-category h4 {
      color: var(--accent) !important;
    }
    
    .dark-mode .number-item-card {
      background: var(--muted-bg) !important;
    }
    
    .dark-mode .number-item-card strong {
      color: var(--accent) !important;
    }
    
    .dark-mode .number-item-card .arabic-text {
      color: var(--text) !important;
    }
    
    .dark-mode .number-item-card button {
      background: var(--accent) !important;
      color: white !important;
    }
    
    .dark-mode .number-item-card button:hover {
      background: var(--accent) !important;
      opacity: 0.9;
    }
    
    .dark-mode .number-tips {
      background: var(--muted-bg) !important;
      border-color: var(--info) !important;
    }
    
    .dark-mode .number-tips h4 {
      color: var(--info) !important;
    }
    
    .dark-mode .number-tips li {
      color: var(--text) !important;
    }

    /* Date & Time Stage Styles */
    .date-content {
      display: grid;
      gap: 2rem;
      margin: 2rem 0;
    }

    .date-category {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .date-category h4 {
      color: var(--primary);
      margin-bottom: 1rem;
      font-size: 1.2rem;
      border-bottom: 2px solid var(--primary);
      padding-bottom: 0.5rem;
    }

    .date-items {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
    }

    .date-item-card {
      background: var(--muted-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .date-item-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      border-color: var(--primary);
    }

    .date-main {
      margin-bottom: 1rem;
    }

    .date-english {
      font-size: 1.1rem;
      font-weight: bold;
      color: var(--primary);
      margin-bottom: 0.5rem;
    }

    .date-abbreviation {
      font-size: 0.9rem;
      color: var(--muted);
      font-style: italic;
      margin-bottom: 0.3rem;
    }

    .date-number {
      font-size: 1.2rem;
      font-weight: bold;
      color: var(--accent);
      margin-bottom: 0.3rem;
    }

    .date-format {
      font-size: 0.85rem;
      color: var(--muted);
      background: var(--accent-bg);
      padding: 0.3rem 0.6rem;
      border-radius: 4px;
      display: inline-block;
    }

    .date-speak-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      align-self: flex-start;
    }

    .date-speak-btn:hover {
      background: var(--primary-dark);
      transform: scale(1.05);
    }

    .date-tips {
      background: var(--muted-bg);
      border-radius: 8px;
      padding: 1.5rem;
      margin-top: 2rem;
    }

    .date-tips h4 {
      color: var(--primary);
      margin-bottom: 1rem;
    }

    .date-tips ul {
      list-style: none;
      padding: 0;
    }

    .date-tips li {
      margin-bottom: 0.8rem;
      padding-left: 1.5rem;
      position: relative;
    }

    .date-tips li::before {
      content: "📝";
      position: absolute;
      left: 0;
      top: 0;
    }

    /* Clock Reading Stage Styles */
    .clock-content {
      display: grid;
      gap: 2rem;
      margin: 2rem 0;
    }

    .clock-category {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .clock-category h4 {
      color: var(--primary);
      margin-bottom: 1rem;
      font-size: 1.2rem;
      border-bottom: 2px solid var(--primary);
      padding-bottom: 0.5rem;
    }

    .clock-items {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1rem;
    }

    .clock-item-card {
      background: var(--muted-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .clock-item-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      border-color: var(--primary);
    }

    .clock-main {
      margin-bottom: 1rem;
    }

    .clock-time {
      font-size: 1.4rem;
      font-weight: bold;
      color: var(--accent);
      margin-bottom: 0.5rem;
      font-family: 'Courier New', monospace;
    }

    .clock-english {
      font-size: 1.1rem;
      font-weight: bold;
      color: var(--primary);
      margin-bottom: 0.5rem;
    }

    .clock-type {
      font-size: 0.8rem;
      color: var(--muted);
      background: var(--accent-bg);
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      display: inline-block;
      text-transform: uppercase;
      font-weight: bold;
    }

    .clock-speak-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      align-self: flex-start;
    }

    .clock-speak-btn:hover {
      background: var(--primary-dark);
      transform: scale(1.05);
    }

    .clock-tips {
      background: var(--muted-bg);
      border-radius: 8px;
      padding: 1.5rem;
      margin-top: 2rem;
    }

    .clock-tips h4 {
      color: var(--primary);
      margin-bottom: 1rem;
    }

    .clock-tips ul {
      list-style: none;
      padding: 0;
    }

    .clock-tips li {
      margin-bottom: 0.8rem;
      padding-left: 1.5rem;
      position: relative;
    }

    .clock-tips li::before {
      content: "⏰";
      position: absolute;
      left: 0;
      top: 0;
    }

    /* Dark mode for Date & Clock stages */
    .dark-mode .date-category,
    .dark-mode .clock-category {
      background: var(--card-bg) !important;
      color: var(--text) !important;
    }

    .dark-mode .date-category h4,
    .dark-mode .clock-category h4 {
      color: var(--primary) !important;
    }

    .dark-mode .date-item-card,
    .dark-mode .clock-item-card {
      background: var(--muted-bg) !important;
      border-color: var(--border) !important;
      color: var(--text) !important;
    }

    .dark-mode .date-item-card:hover,
    .dark-mode .clock-item-card:hover {
      border-color: var(--primary) !important;
    }

    .dark-mode .date-english,
    .dark-mode .clock-english {
      color: var(--primary) !important;
    }

    .dark-mode .arabic-text {
      color: var(--text) !important;
    }

    .dark-mode .date-abbreviation,
    .dark-mode .date-format,
    .dark-mode .clock-type {
      color: var(--muted) !important;
      background: var(--accent-bg) !important;
    }

    .dark-mode .date-number,
    .dark-mode .clock-time {
      color: var(--accent) !important;
    }

    .dark-mode .date-speak-btn,
    .dark-mode .clock-speak-btn {
      background: var(--primary) !important;
      color: white !important;
    }

    .dark-mode .date-speak-btn:hover,
    .dark-mode .clock-speak-btn:hover {
      background: var(--primary-dark) !important;
    }

    .dark-mode .date-tips,
    .dark-mode .clock-tips {
      background: var(--muted-bg) !important;
      color: var(--text) !important;
    }

    .dark-mode .date-tips h4,
    .dark-mode .clock-tips h4 {
      color: var(--primary) !important;
    }

    /* Family Stage Styles */
    .family-content {
      display: grid;
      gap: 2rem;
      margin: 2rem 0;
    }

    .family-category {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .family-category h4 {
      color: var(--primary);
      margin-bottom: 1rem;
      font-size: 1.2rem;
      border-bottom: 2px solid var(--primary);
      padding-bottom: 0.5rem;
    }

    .family-items {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
    }

    .family-item-card {
      background: var(--muted-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .family-item-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      border-color: var(--primary);
    }

    .family-main {
      margin-bottom: 1rem;
    }

    .family-emoji {
      font-size: 2rem;
      text-align: center;
      margin-bottom: 0.8rem;
    }

    .family-english {
      font-size: 1.1rem;
      font-weight: bold;
      color: var(--primary);
      margin-bottom: 0.5rem;
    }

    .family-relationship {
      font-size: 0.8rem;
      color: var(--muted);
      background: var(--accent-bg);
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      display: inline-block;
      text-transform: uppercase;
      font-weight: bold;
    }

    .family-speak-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      align-self: flex-start;
    }

    .family-speak-btn:hover {
      background: var(--primary-dark);
      transform: scale(1.05);
    }

    .family-tips {
      background: var(--muted-bg);
      border-radius: 8px;
      padding: 1.5rem;
      margin-top: 2rem;
    }

    .family-tips h4 {
      color: var(--primary);
      margin-bottom: 1rem;
    }

    .family-tips ul {
      list-style: none;
      padding: 0;
    }

    .family-tips li {
      margin-bottom: 0.8rem;
      padding-left: 1.5rem;
      position: relative;
    }

    .family-tips li::before {
      content: "👨‍👩‍👧‍👦";
      position: absolute;
      left: 0;
      top: 0;
    }

    /* Animals Stage Styles */
    .animals-content {
      display: grid;
      gap: 2rem;
      margin: 2rem 0;
    }

    .animals-category {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .animals-category h4 {
      color: var(--primary);
      margin-bottom: 1rem;
      font-size: 1.2rem;
      border-bottom: 2px solid var(--primary);
      padding-bottom: 0.5rem;
    }

    .animals-items {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1rem;
    }

    .animals-item-card {
      background: var(--muted-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .animals-item-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      border-color: var(--primary);
    }

    .animals-main {
      margin-bottom: 1rem;
    }

    .animals-emoji {
      font-size: 2rem;
      text-align: center;
      margin-bottom: 0.8rem;
    }

    .animals-english {
      font-size: 1.1rem;
      font-weight: bold;
      color: var(--primary);
      margin-bottom: 0.5rem;
    }

    .animals-sound {
      font-size: 0.9rem;
      color: var(--accent);
      font-style: italic;
      margin-bottom: 0.3rem;
      font-weight: bold;
    }

    .animals-habitat {
      font-size: 0.8rem;
      color: var(--muted);
      background: var(--accent-bg);
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      display: inline-block;
      text-transform: uppercase;
      font-weight: bold;
    }

    .animals-speak-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      align-self: flex-start;
    }

    .animals-speak-btn:hover {
      background: var(--primary-dark);
      transform: scale(1.05);
    }

    .animals-tips {
      background: var(--muted-bg);
      border-radius: 8px;
      padding: 1.5rem;
      margin-top: 2rem;
    }

    .animals-tips h4 {
      color: var(--primary);
      margin-bottom: 1rem;
    }

    .animals-tips ul {
      list-style: none;
      padding: 0;
    }

    .animals-tips li {
      margin-bottom: 0.8rem;
      padding-left: 1.5rem;
      position: relative;
    }

    .animals-tips li::before {
      content: "🐾";
      position: absolute;
      left: 0;
      top: 0;
    }

    /* School Stage Styles */
    .school-content {
      display: grid;
      gap: 2rem;
      margin: 2rem 0;
    }

    .school-category {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .school-category h4 {
      color: var(--primary);
      margin-bottom: 1rem;
      font-size: 1.2rem;
      border-bottom: 2px solid var(--primary);
      padding-bottom: 0.5rem;
    }

    .school-items {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
    }

    .school-item-card {
      background: var(--muted-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .school-item-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      border-color: var(--primary);
    }

    .school-main {
      margin-bottom: 1rem;
    }

    .school-emoji {
      font-size: 2rem;
      text-align: center;
      margin-bottom: 0.8rem;
    }

    .school-image {
      text-align: center;
      margin-bottom: 0.8rem;
    }

    .school-image img {
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: transform 0.2s ease;
    }

    .school-image img:hover {
      transform: scale(1.05);
    }

    /* Challenge Styles */
    .challenge-progress {
      margin: 20px 0;
    }

    .progress-bar {
      background: #e0e0e0;
      border-radius: 10px;
      height: 12px;
      overflow: hidden;
      margin-bottom: 10px;
    }

    .progress-fill {
      background: linear-gradient(90deg, #4ecdc4, #45b7aa);
      height: 100%;
      width: 0%;
      transition: width 0.3s ease;
    }

    .challenge-stats {
      display: flex;
      gap: 20px;
      justify-content: center;
      font-weight: bold;
    }

    .challenge-letter {
      text-align: center;
      padding: 40px;
    }

    .challenge-controls {
      text-align: center;
      margin-top: 20px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background: linear-gradient(45deg, #4ecdc4, #45b7aa);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(78, 205, 196, 0.3);
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    /* Level Up Animation */
    @keyframes levelUpPulse {
      0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
      50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }

    /* Challenge Dropdown */
    .challenge-dropdown {
      position: relative;
      display: inline-block;
    }

    .challenge-menu {
      display: none;
      position: absolute;
      background: white;
      min-width: 200px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);
      border-radius: 8px;
      z-index: 1000;
      top: 100%;
      right: 0;
      margin-top: 5px;
    }

    .challenge-menu button {
      display: block;
      width: 100%;
      padding: 12px 16px;
      text-align: left;
      border: none;
      background: white;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }

    .challenge-menu button:hover {
      background: #f8f9fa;
    }

    .challenge-dropdown:hover .challenge-menu {
      display: block;
    }

    .advanced-menu {
      position: relative;
      display: inline-block;
    }

    .advanced-menu-content {
      display: none;
      position: absolute;
      background: white;
      min-width: 200px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);
      border-radius: 8px;
      z-index: 1000;
      top: 100%;
      right: 0;
      margin-top: 5px;
    }

    .advanced-menu-content button {
      display: block;
      width: 100%;
      padding: 12px 16px;
      text-align: left;
      border: none;
      background: white;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }

    .advanced-menu-content button:hover {
      background: #f8f9fa;
    }

    .advanced-menu:hover .advanced-menu-content {
      display: block;
    }

    /* Audio Manager Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid #e0e0e0;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
    }

    .modal-body {
      padding: 20px;
    }

    .audio-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .tab-btn {
      padding: 10px 20px;
      border: 1px solid #ddd;
      background: white;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.3s;
    }

    .tab-btn.active {
      background: #4ecdc4;
      color: white;
      border-color: #4ecdc4;
    }

    .audio-tab-content {
      min-height: 200px;
    }

    .audio-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .audio-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      background: #f9f9f9;
    }

    .audio-info {
      display: flex;
      flex-direction: column;
      gap: 10px;
      flex: 1;
    }

    .audio-name {
      font-weight: bold;
      color: #333;
    }

    .audio-actions {
      display: flex;
      gap: 10px;
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 12px;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .no-audio {
      text-align: center;
      color: #666;
      font-style: italic;
      padding: 40px;
    }

    .audio-upload-section {
      margin-top: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .upload-controls {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .upload-controls input,
    .upload-controls select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      flex: 1;
      min-width: 150px;
    }

    #audioFileInput {
      width: 100%;
      margin-bottom: 15px;
      padding: 10px;
      border: 2px dashed #4ecdc4;
      border-radius: 8px;
      background: #f0f9ff;
    }

    .school-english {
      font-size: 1.1rem;
      font-weight: bold;
      color: var(--primary);
      margin-bottom: 0.5rem;
    }

    .school-abbreviation {
      font-size: 0.9rem;
      color: var(--accent);
      font-style: italic;
      margin-bottom: 0.3rem;
    }

    .school-role,
    .school-type,
    .school-activity {
      font-size: 0.8rem;
      color: var(--muted);
      background: var(--accent-bg);
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      display: inline-block;
      margin-right: 0.3rem;
      margin-bottom: 0.3rem;
      text-transform: uppercase;
      font-weight: bold;
    }

    .school-speak-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      align-self: flex-start;
    }

    .school-speak-btn:hover {
      background: var(--primary-dark);
      transform: scale(1.05);
    }

    .school-tips {
      background: var(--muted-bg);
      border-radius: 8px;
      padding: 1.5rem;
      margin-top: 2rem;
    }

    .school-tips h4 {
      color: var(--primary);
      margin-bottom: 1rem;
    }

    .school-tips ul {
      list-style: none;
      padding: 0;
    }

    .school-tips li {
      margin-bottom: 0.8rem;
      padding-left: 1.5rem;
      position: relative;
    }

    .school-tips li::before {
      content: "🏫";
      position: absolute;
      left: 0;
      top: 0;
    }

    /* Dark mode for new stages */
    .dark-mode .family-category,
    .dark-mode .animals-category,
    .dark-mode .school-category {
      background: var(--card-bg) !important;
      color: var(--text) !important;
    }

    .dark-mode .family-category h4,
    .dark-mode .animals-category h4,
    .dark-mode .school-category h4 {
      color: var(--primary) !important;
    }

    .dark-mode .family-item-card,
    .dark-mode .animals-item-card,
    .dark-mode .school-item-card {
      background: var(--muted-bg) !important;
      border-color: var(--border) !important;
      color: var(--text) !important;
    }

    .dark-mode .family-item-card:hover,
    .dark-mode .animals-item-card:hover,
    .dark-mode .school-item-card:hover {
      border-color: var(--primary) !important;
    }

    .dark-mode .family-english,
    .dark-mode .animals-english,
    .dark-mode .school-english {
      color: var(--primary) !important;
    }

    .dark-mode .arabic-text {
      color: var(--text) !important;
    }

    .dark-mode .family-relationship,
    .dark-mode .animals-sound,
    .dark-mode .animals-habitat,
    .dark-mode .school-abbreviation,
    .dark-mode .school-role,
    .dark-mode .school-type,
    .dark-mode .school-activity {
      color: var(--muted) !important;
      background: var(--accent-bg) !important;
    }

    .dark-mode .family-speak-btn,
    .dark-mode .animals-speak-btn,
    .dark-mode .school-speak-btn {
      background: var(--primary) !important;
      color: white !important;
    }

    .dark-mode .family-speak-btn:hover,
    .dark-mode .animals-speak-btn:hover,
    .dark-mode .school-speak-btn:hover {
      background: var(--primary-dark) !important;
    }

    .dark-mode .family-tips,
    .dark-mode .animals-tips,
    .dark-mode .school-tips {
      background: var(--muted-bg) !important;
      color: var(--text) !important;
    }

    .dark-mode .family-tips h4,
    .dark-mode .animals-tips h4,
    .dark-mode .school-tips h4 {
      color: var(--primary) !important;
    }
    
    .dark-mode footer {
      background: rgba(45, 45, 45, 0.5) !important;
      color: #a0a0a0 !important;
    }
    
    .dark-mode .letter-tile {
      background: #374151 !important;
      color: #f8fafc !important;
      border-color: #4b5563 !important;
    }
    
    .dark-mode .letter-tile:hover {
      background: #4b5563 !important;
    }
    
    .dark-mode .stage-button {
      background: #374151 !important;
      color: #f8fafc !important;
      border-color: #4b5563 !important;
    }
    
    .dark-mode .stage-button:hover {
      background: #4b5563 !important;
    }
    
    .dark-mode .stage-button.locked {
      background: #1f2937 !important;
      color: #6b7280 !important;
      opacity: 0.5 !important;
    }
    
    footer{
      padding:20px;text-align:center;
      color:var(--muted);font-size:0.9rem;
      background:rgba(255,255,255,0.5);
      -webkit-backdrop-filter:blur(10px);
      backdrop-filter:blur(10px);
    }
  </style>
</head>
<body>
  <header class="container">
    <div class="header-top">
      <h1>🚀 English Learning Journey — Interactive Learning Platform</h1>
      <div class="controls" role="region" aria-label="Main controls">
        <div class="settings-group">
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
            <input type="checkbox" id="translitCheckbox" aria-describedby="translitHelp">
            <span>🇸🇦</span>
          </label>
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
            <input type="checkbox" id="soundCheckbox" checked aria-describedby="soundHelp">
            <span>🔊</span>
          </label>
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
            <input type="checkbox" id="highContrastCheckbox" aria-describedby="contrastHelp">
            <span>♿</span>
          </label>
        </div>
        <div class="action-buttons">
          <button id="darkModeToggle" title="Toggle dark mode" aria-label="Toggle dark mode">🌙</button>
          <button id="speakAll" title="Play pronunciations for all letters" aria-label="Play all letter pronunciations">🔊 Speak All</button>
          <div class="challenge-dropdown">
            <button id="challengeBtn" title="Start a challenge" aria-label="Start challenge">🎯 Challenges</button>
            <div class="challenge-menu" id="challengeMenu">
              <button onclick="startChallenge('speed', 'easy')">⚡ Speed Challenge</button>
              <button onclick="startChallenge('accuracy', 'easy')">🎯 Accuracy Challenge</button>
              <button onclick="startChallenge('memory', 'easy')">🧠 Memory Challenge</button>
            </div>
          </div>
          <div class="advanced-menu">
            <button id="advancedBtn" title="Advanced options" aria-label="Advanced options">⚙️ More</button>
            <div class="advanced-menu-content" id="advancedMenu">
              <button id="unlockAllStages" title="Unlock all stages for testing" aria-label="Unlock all stages">🔓 Unlock All</button>
              <button id="audioManagerBtn" title="Manage custom audio files" aria-label="Audio Manager">🎵 Audio Manager</button>
              <button id="activateMobileAppAudio" title="Activate audio in mobile app" aria-label="Activate Mobile App Audio" onclick="activateMobileAppAudio()">📲 Activate App Audio</button>
              <button id="resetProgress" class="ghost" title="Reset saved progress" aria-label="Reset all progress">🔄 Reset Progress</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="stage-nav-container">
      <div class="stage-nav" id="stageNavContainer">
        <!-- Stage buttons will be inserted here by JavaScript -->
      </div>
      <div class="progress-section">
        <div id="progressSummary" class="progress" aria-live="polite"></div>
        <div id="achievements" class="achievements"></div>
      </div>
    </div>
  </header>

  <div class="container">
    <main>
      <section class="card game-area" id="gameArea" tabindex="0" role="main" aria-label="Learning activities">
        <div class="flashcard" id="flashcardTop" role="region" aria-label="Current letter information">
          <div>
            <div style="font-size:2rem;font-weight:800;margin-bottom:4px;color:#073642" id="currentLabel" aria-label="Current letter">A</div>
            <div style="color:#073642;font-size:1.1rem;opacity:0.8" id="labelSub">Letter A — "/eɪ/"</div>
            <div id="transliteration" style="color:#073642;font-size:0.9rem;margin-top:4px;font-family:var(--font-family-arabic);opacity:0.7"></div>
          </div>
          <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
            <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
              <button id="playPronounce" aria-label="Pronounce current letter">🔊 Pronounce</button>
              <button id="nextLetter" class="ghost" aria-label="Go to next letter">➡️ Next</button>
            </div>
            <div style="font-size:0.8rem;color:var(--muted);text-align:right">
              <span id="letterProgress">1 of 26</span>
            </div>
          </div>
        </div>

        <div id="stageContent" role="region" aria-label="Learning activities">
          <!-- dynamic content for the selected stage -->
        </div>
      </section>
    </main>

    <footer style="background:var(--card-bg);border-top:1px solid var(--border);padding:24px 0;margin-top:32px;">
      <div class="container">
        <!-- Main Footer Content -->
        <div style="display:grid;grid-template-columns:2fr 1fr 1fr;gap:32px;margin-bottom:24px;">
          
          <!-- Platform Info -->
          <div>
            <h3 style="margin:0 0 12px 0;font-size:1.2rem;font-weight:bold;color:var(--accent);">
              🚀 English Learning Journey
            </h3>
            <p style="margin:0 0 16px 0;font-size:0.9rem;color:var(--muted);line-height:1.5;">
              Interactive learning platform designed for English-native and Arabic-speaking children. 
              Master the English alphabet through fun games, stories, and activities.
            </p>
            <div style="display:flex;gap:16px;flex-wrap:wrap;">
              <span style="font-size:0.8rem;color:var(--muted);">🔊 Speech Synthesis</span>
              <span style="font-size:0.8rem;color:var(--muted);">🎮 Interactive Games</span>
              <span style="font-size:0.8rem;color:var(--muted);">📊 Progress Tracking</span>
              <span style="font-size:0.8rem;color:var(--muted);">♿ Accessibility</span>
            </div>
          </div>
          
          <!-- Quick Links -->
          <div>
            <h4 style="margin:0 0 12px 0;font-size:1rem;font-weight:600;color:var(--text);">
              Learning Stages
            </h4>
            <div style="display:flex;flex-direction:column;gap:6px;">
              <span style="font-size:0.85rem;color:var(--muted);">🔤 Alphabet Basics</span>
              <span style="font-size:0.85rem;color:var(--muted);">🔊 Phonics & Sounds</span>
              <span style="font-size:0.85rem;color:var(--muted);">📚 Words & Vocabulary</span>
              <span style="font-size:0.85rem;color:var(--muted);">📖 Stories & Reading</span>
              <span style="font-size:0.85rem;color:var(--muted);">🎯 Assessment</span>
            </div>
          </div>
          
          <!-- Contact & Copyright -->
          <div>
            <h4 style="margin:0 0 12px 0;font-size:1rem;font-weight:600;color:var(--text);">
              Creator
            </h4>
            <div style="display:flex;flex-direction:column;gap:8px;">
              <p style="margin:0;font-size:0.9rem;font-weight:600;color:var(--accent);">
                A.Cherifi
              </p>
              <p style="margin:0;font-size:0.8rem;color:var(--muted);">
                Created with ❤️ for children's learning
              </p>
              <p style="margin:0;font-size:0.8rem;color:var(--muted);">
                © 2025 All Rights Reserved
              </p>
            </div>
          </div>
        </div>
        
        <!-- Bottom Border -->
        <div style="padding-top:16px;border-top:1px solid var(--border);text-align:center;">
          <p style="font-size:0.8rem;color:var(--muted);margin:0;">
            English Learning Journey • Interactive Educational Platform • Responsive Design
          </p>
        </div>
      </div>
    </footer>
  </div>

  <script>
    // ---------- Data model ----------
    const LETTERS = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
    // Complete words for all letters A-Z with enhanced Arabic support
    const WORDS = {
      A: {word:'Apple', example:'A red apple', translit:'تفاحة', phonetic:'/ˈæpəl/', difficulty:'easy'},
      B: {word:'Bee', example:'A busy bee', translit:'نحلة', phonetic:'/biː/', difficulty:'easy'},
      C: {word:'Cat', example:'A small cat', translit:'قطة', phonetic:'/kæt/', difficulty:'easy'},
      D: {word:'Dog', example:'A happy dog', translit:'كلب', phonetic:'/dɔːɡ/', difficulty:'easy'},
      E: {word:'Egg', example:'A chicken egg', translit:'بيضة', phonetic:'/eɡ/', difficulty:'easy'},
      F: {word:'Fish', example:'A swimming fish', translit:'سمكة', phonetic:'/fɪʃ/', difficulty:'easy'},
      G: {word:'Goat', example:'A white goat', translit:'ماعز', phonetic:'/ɡoʊt/', difficulty:'easy'},
      H: {word:'House', example:'A big house', translit:'منزل', phonetic:'/haʊs/', difficulty:'easy'},
      I: {word:'Ice', example:'Cold ice', translit:'ثلج', phonetic:'/aɪs/', difficulty:'easy'},
      J: {word:'Juice', example:'Orange juice', translit:'عصير', phonetic:'/dʒuːs/', difficulty:'easy'},
      K: {word:'Key', example:'A golden key', translit:'مفتاح', phonetic:'/kiː/', difficulty:'easy'},
      L: {word:'Lion', example:'A strong lion', translit:'أسد', phonetic:'/ˈlaɪən/', difficulty:'easy'},
      M: {word:'Moon', example:'Bright moon', translit:'قمر', phonetic:'/muːn/', difficulty:'easy'},
      N: {word:'Nose', example:'A small nose', translit:'أنف', phonetic:'/noʊz/', difficulty:'easy'},
      O: {word:'Orange', example:'A sweet orange', translit:'برتقال', phonetic:'/ˈɔːrɪndʒ/', difficulty:'easy'},
      P: {word:'Pencil', example:'A sharp pencil', translit:'قلم رصاص', phonetic:'/ˈpensəl/', difficulty:'medium'},
      Q: {word:'Queen', example:'A beautiful queen', translit:'ملكة', phonetic:'/kwiːn/', difficulty:'medium'},
      R: {word:'Rose', example:'A red rose', translit:'وردة', phonetic:'/roʊz/', difficulty:'easy'},
      S: {word:'Sun', example:'Bright sun', translit:'شمس', phonetic:'/sʌn/', difficulty:'easy'},
      T: {word:'Tree', example:'A tall tree', translit:'شجرة', phonetic:'/triː/', difficulty:'easy'},
      U: {word:'Umbrella', example:'A colorful umbrella', translit:'مظلة', phonetic:'/ʌmˈbrelə/', difficulty:'medium'},
      V: {word:'Violin', example:'A musical violin', translit:'كمان', phonetic:'/ˌvaɪəˈlɪn/', difficulty:'hard'},
      W: {word:'Water', example:'Clean water', translit:'ماء', phonetic:'/ˈwɔːtər/', difficulty:'easy'},
      X: {word:'Xylophone', example:'A musical xylophone', translit:'إكسيليفون', phonetic:'/ˈzaɪləfoʊn/', difficulty:'hard'},
      Y: {word:'Yellow', example:'Yellow color', translit:'أصفر', phonetic:'/ˈjeloʊ/', difficulty:'easy'},
      Z: {word:'Zebra', example:'A striped zebra', translit:'حمار وحشي', phonetic:'/ˈziːbrə/', difficulty:'medium'}
    };

    const STAGES = [
      // Foundation Level - الأساسيات
      {id:1,name:'🔤 Alphabet (A–Z)', description:'Learn letters and sounds', emoji:'🔤', difficulty:'beginner'},
      {id:2,name:'🔊 Phonics', description:'Letter sounds and syllables', emoji:'🔊', difficulty:'beginner'},
      {id:3,name:'📝 Words', description:'Basic vocabulary building', emoji:'📝', difficulty:'beginner'},
      
      // Basic Vocabulary - المفردات الأساسية
      {id:4,name:'🎨 Colors', description:'Learn colors in English and Arabic', emoji:'🎨', difficulty:'elementary'},
      {id:5,name:'🔢 Numbers', description:'Learn numbers from 1 to 100', emoji:'🔢', difficulty:'elementary'},
      {id:6,name:'👤 Body Parts', description:'Learn human body parts', emoji:'👤', difficulty:'elementary'},
      {id:7,name:'🍎 Fruits & Vegetables', description:'Learn fruits and vegetables', emoji:'🍎', difficulty:'elementary'},
      {id:8,name:'🐾 Animals', description:'Learn animals and their sounds', emoji:'🐾', difficulty:'elementary'},
      {id:9,name:'👨‍👩‍👧‍👦 Family & Relatives', description:'Learn family members and relatives', emoji:'👨‍👩‍👧‍👦', difficulty:'elementary'},
      {id:10,name:'🏫 School & Education', description:'Learn school objects and subjects', emoji:'🏫', difficulty:'elementary'},
      
      // Time & Date - الوقت والتاريخ
      {id:11,name:'📅 Date & Time', description:'Learn days, months, and dates', emoji:'📅', difficulty:'elementary'},
      {id:12,name:'🕐 Clock Reading', description:'Learn to read time and clocks', emoji:'🕐', difficulty:'elementary'},
      
      // Language Skills - مهارات اللغة
      {id:13,name:'📖 Sentences', description:'Short sentence construction', emoji:'📖', difficulty:'elementary'},
      {id:14,name:'📚 Short Stories', description:'Reading with comprehension', emoji:'📚', difficulty:'elementary'},
      {id:15,name:'🎤 Listening & Speaking', description:'Audio and pronunciation', emoji:'🎤', difficulty:'elementary'},
      {id:16,name:'📋 Basic Grammar', description:'Simple grammar rules', emoji:'📋', difficulty:'intermediate'},
      {id:17,name:'📖 Reading Comprehension', description:'Understanding texts', emoji:'📖', difficulty:'intermediate'},
      {id:18,name:'✍️ Writing & Spelling', description:'Writing and spelling practice', emoji:'✍️', difficulty:'intermediate'},
      {id:19,name:'💬 Practical Conversation', description:'Real-world dialogues', emoji:'💬', difficulty:'intermediate'},
      
      // Assessment - التقييم
      {id:20,name:'🎮 Assessment & Certification', description:'Tests and achievements', emoji:'🎮', difficulty:'all'}
    ];

    // ---------- Persistence ----------
    const STORAGE_KEY = 'alphabet_adventure_v2';
    let state = {
      unlockedStages: [1], // Start with only first stage
      currentStage: 1,
      currentLetterIndex: 0,
      points: 0,
      badges: [],
      audioContextInitialized: false, // For mobile audio support
      lettersMastered: {},
      achievements: [],
      totalTimeSpent: 0,
      sessionStartTime: Date.now(),
      level: 1,
      experience: 0,
      levelThresholds: [0, 100, 250, 500, 800, 1200, 1700, 2300, 3000, 4000, 5000],
      streak: 0,
      lastActivityDate: null,
      preferences: {
        soundEnabled: true,
        arabicTranslit: false,
        highContrast: false,
        darkMode: false
      },
      progress: {
        stagesCompleted: 0,
        lettersLearned: 0,
        wordsLearned: 0,
        gamesPlayed: 0,
        totalStages: 20,
        completionRate: 0,
        averageScore: 0,
        studyStreak: 0,
        totalStudyTime: 0
      },
      customAudio: {
        letters: {}, // Custom audio for letters
        words: {},   // Custom audio for words
        sounds: {}   // Custom sound effects
      }
    };

    function loadState(){
      try{const s=localStorage.getItem(STORAGE_KEY); if(s){Object.assign(state, JSON.parse(s));}}
      catch(e){console.warn('Could not load state',e)}
    }
    function saveState(){localStorage.setItem(STORAGE_KEY,JSON.stringify(state)); updateUI();}

    // ---------- Level System Functions ----------
    function addExperience(amount) {
      state.experience += amount;
      checkLevelUp();
      updateProgress();
    }

    function checkLevelUp() {
      const currentLevel = state.level;
      const nextThreshold = state.levelThresholds[state.level] || Infinity;
      
      if (state.experience >= nextThreshold) {
        state.level++;
        showLevelUpNotification();
        unlockNewStages();
        addAchievement(`Level ${state.level}`, `Reached level ${state.level}!`);
      }
    }

    function showLevelUpNotification() {
      showNotification(`🎉 Level Up! You're now level ${state.level}!`, 'success');
      
      // Show level up animation
      const levelUpDiv = document.createElement('div');
      levelUpDiv.innerHTML = `
        <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                    background: linear-gradient(45deg, #ff6b6b, #4ecdc4); color: white; 
                    padding: 30px; border-radius: 20px; text-align: center; z-index: 10000;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.3); animation: levelUpPulse 2s ease-in-out;">
          <h2 style="margin: 0; font-size: 2.5rem;">🎉 LEVEL UP! 🎉</h2>
          <p style="margin: 10px 0; font-size: 1.5rem;">You're now level ${state.level}!</p>
          <p style="margin: 0; font-size: 1rem;">Keep learning to unlock more stages!</p>
        </div>
      `;
      
      document.body.appendChild(levelUpDiv);
      setTimeout(() => {
        document.body.removeChild(levelUpDiv);
      }, 3000);
    }

    function unlockNewStages() {
      const stagesToUnlock = Math.min(state.level * 2, 20);
      for (let i = 1; i <= stagesToUnlock; i++) {
        if (!state.unlockedStages.includes(i)) {
          state.unlockedStages.push(i);
        }
      }
    }

    function updateProgress() {
      state.progress.completionRate = (state.progress.stagesCompleted / state.progress.totalStages) * 100;
      state.progress.totalStudyTime = state.totalTimeSpent;
    }

    function addAchievement(title, description) {
      const achievement = {
        id: Date.now(),
        title: title,
        description: description,
        date: new Date().toISOString(),
        icon: '🏆'
      };
      
      if (!state.achievements.find(a => a.title === title)) {
        state.achievements.push(achievement);
        showNotification(`🏆 Achievement Unlocked: ${title}`, 'info');
      }
    }

    function updateStreak() {
      const today = new Date().toDateString();
      const lastActivity = state.lastActivityDate ? new Date(state.lastActivityDate).toDateString() : null;
      
      if (lastActivity === today) {
        // Already studied today
        return;
      } else if (lastActivity === new Date(Date.now() - 86400000).toDateString()) {
        // Studied yesterday, continue streak
        state.streak++;
      } else {
        // Streak broken
        state.streak = 1;
      }
      
      state.lastActivityDate = new Date().toISOString();
      
      if (state.streak > 0 && state.streak % 7 === 0) {
        addAchievement(`7-Day Streak`, `Studied for ${state.streak} days in a row!`);
      }
    }

    // ---------- Challenge System ----------
    function startChallenge(type, difficulty = 'easy') {
      const challenges = {
        speed: {
          easy: { time: 60, target: 10, description: 'Complete 10 letters in 60 seconds' },
          medium: { time: 45, target: 15, description: 'Complete 15 letters in 45 seconds' },
          hard: { time: 30, target: 20, description: 'Complete 20 letters in 30 seconds' }
        },
        accuracy: {
          easy: { questions: 10, target: 80, description: 'Get 80% accuracy in 10 questions' },
          medium: { questions: 15, target: 85, description: 'Get 85% accuracy in 15 questions' },
          hard: { questions: 20, target: 90, description: 'Get 90% accuracy in 20 questions' }
        },
        memory: {
          easy: { items: 5, description: 'Remember 5 items in sequence' },
          medium: { items: 8, description: 'Remember 8 items in sequence' },
          hard: { items: 12, description: 'Remember 12 items in sequence' }
        }
      };

      const challenge = challenges[type][difficulty];
      if (!challenge) return;

      showNotification(`🎯 Challenge Started: ${challenge.description}`, 'info');
      
      // Store challenge state
      state.currentChallenge = {
        type: type,
        difficulty: difficulty,
        config: challenge,
        startTime: Date.now(),
        score: 0,
        completed: false
      };

      // Start challenge UI
      renderChallenge();
    }

    function renderChallenge() {
      if (!state.currentChallenge) return;

      const challenge = state.currentChallenge;
      stageContent.innerHTML = `
        <div class="card">
          <h3>🎯 Challenge: ${challenge.type.toUpperCase()}</h3>
          <p>${challenge.config.description}</p>
          <div class="challenge-progress">
            <div class="progress-bar">
              <div class="progress-fill" id="challengeProgress"></div>
            </div>
            <div class="challenge-stats">
              <span>Score: <span id="challengeScore">0</span></span>
              <span>Time: <span id="challengeTime">${challenge.config.time || '∞'}</span>s</span>
            </div>
          </div>
          <div id="challengeContent"></div>
          <div class="challenge-controls">
            <button onclick="endChallenge()" class="btn btn-secondary">End Challenge</button>
          </div>
        </div>
      `;

      // Start challenge logic based on type
      switch (challenge.type) {
        case 'speed':
          startSpeedChallenge();
          break;
        case 'accuracy':
          startAccuracyChallenge();
          break;
        case 'memory':
          startMemoryChallenge();
          break;
      }
    }

    function startSpeedChallenge() {
      const challenge = state.currentChallenge;
      let timeLeft = challenge.config.time;
      let completed = 0;
      
      const timer = setInterval(() => {
        timeLeft--;
        document.getElementById('challengeTime').textContent = timeLeft;
        
        if (timeLeft <= 0) {
          clearInterval(timer);
          endChallenge();
        }
      }, 1000);

      // Show letters to complete
      const letters = LETTERS.slice(0, challenge.config.target);
      let currentLetterIndex = 0;
      
      const showNextLetter = () => {
        if (currentLetterIndex >= letters.length) {
          clearInterval(timer);
          state.currentChallenge.completed = true;
          addExperience(50);
          showNotification('🎉 Challenge Completed! +50 XP', 'success');
          endChallenge();
          return;
        }
        
        const letter = letters[currentLetterIndex];
        document.getElementById('challengeContent').innerHTML = `
          <div class="challenge-letter">
            <h2 style="font-size: 4rem; text-align: center;">${letter}</h2>
            <p style="text-align: center;">Click when you're ready for the next letter</p>
            <button onclick="nextLetter()" class="btn btn-primary">Next Letter</button>
          </div>
        `;
      };

      window.nextLetter = () => {
        completed++;
        currentLetterIndex++;
        document.getElementById('challengeScore').textContent = completed;
        showNextLetter();
      };

      showNextLetter();
    }

    function endChallenge() {
      if (state.currentChallenge) {
        const challenge = state.currentChallenge;
        const timeSpent = (Date.now() - challenge.startTime) / 1000;
        
        showNotification(`Challenge ended! Score: ${challenge.score || 0}`, 'info');
        state.currentChallenge = null;
        
        // Return to current stage
        renderSpecificStage(state.currentStage);
      }
    }

    // ---------- Custom Audio Management ----------
    function showAudioManager() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content audio-manager">
          <div class="modal-header">
            <h3>🎵 Audio Manager - مدير الملفات الصوتية</h3>
            <button class="close-btn" onclick="closeModal()">&times;</button>
          </div>
          <div class="modal-body">
            <div class="audio-tabs">
              <button class="tab-btn active" onclick="switchAudioTab('letters')">Letters - الحروف</button>
              <button class="tab-btn" onclick="switchAudioTab('words')">Words - الكلمات</button>
              <button class="tab-btn" onclick="switchAudioTab('sounds')">Sound Effects - المؤثرات</button>
            </div>
            
            <div id="audioTabContent" class="audio-tab-content">
              <!-- Content will be loaded here -->
            </div>
            
            <div class="audio-upload-section">
              <h4>Upload New Audio - رفع ملف صوتي جديد</h4>
              <input type="file" id="audioFileInput" accept="audio/*" multiple>
              <div class="upload-controls">
                <select id="audioTypeSelect">
                  <option value="letters">Letter Audio - صوت الحرف</option>
                  <option value="words">Word Audio - صوت الكلمة</option>
                  <option value="sounds">Sound Effect - مؤثر صوتي</option>
                </select>
                <input type="text" id="audioNameInput" placeholder="Audio name - اسم الملف">
                <button onclick="uploadAudio()" class="btn btn-primary">Upload - رفع</button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      loadAudioTab('letters');
    }

    function switchAudioTab(tab) {
      // Update tab buttons
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      
      loadAudioTab(tab);
    }

    function loadAudioTab(tab) {
      const content = document.getElementById('audioTabContent');
      const audioData = state.customAudio[tab] || {};
      
      let html = `<div class="audio-list">`;
      
      if (Object.keys(audioData).length === 0) {
        html += `<p class="no-audio">No custom audio files uploaded yet.</p>`;
      } else {
        Object.entries(audioData).forEach(([name, audioUrl]) => {
          html += `
            <div class="audio-item">
              <div class="audio-info">
                <span class="audio-name">${name}</span>
                <audio controls>
                  <source src="${audioUrl}" type="audio/mpeg">
                  Your browser does not support the audio element.
                </audio>
              </div>
              <div class="audio-actions">
                <button onclick="playCustomAudio('${tab}', '${name}')" class="btn btn-sm">▶️ Play</button>
                <button onclick="deleteCustomAudio('${tab}', '${name}')" class="btn btn-sm btn-danger">🗑️ Delete</button>
              </div>
            </div>
          `;
        });
      }
      
      html += `</div>`;
      content.innerHTML = html;
    }

    function uploadAudio() {
      const fileInput = document.getElementById('audioFileInput');
      const typeSelect = document.getElementById('audioTypeSelect');
      const nameInput = document.getElementById('audioNameInput');
      
      if (!fileInput.files.length || !nameInput.value) {
        showNotification('Please select a file and enter a name', 'error');
        return;
      }
      
      const file = fileInput.files[0];
      const type = typeSelect.value;
      const name = nameInput.value;
      
      // Convert file to base64 URL
      const reader = new FileReader();
      reader.onload = function(e) {
        if (!state.customAudio[type]) {
          state.customAudio[type] = {};
        }
        
        state.customAudio[type][name] = e.target.result;
        saveState();
        
        showNotification(`Audio "${name}" uploaded successfully!`, 'success');
        loadAudioTab(type);
        
        // Clear form
        fileInput.value = '';
        nameInput.value = '';
      };
      
      reader.readAsDataURL(file);
    }

    function playCustomAudio(type, name) {
      const audioUrl = state.customAudio[type]?.[name];
      if (audioUrl) {
        const audio = new Audio(audioUrl);
        audio.play().catch(e => {
          showNotification('Error playing audio file', 'error');
        });
      }
    }

    function deleteCustomAudio(type, name) {
      if (confirm(`Are you sure you want to delete "${name}"?`)) {
        delete state.customAudio[type][name];
        saveState();
        loadAudioTab(type);
        showNotification(`Audio "${name}" deleted`, 'info');
      }
    }

    function closeModal() {
      const modal = document.querySelector('.modal-overlay');
      if (modal) {
        document.body.removeChild(modal);
      }
    }

    // Mobile audio context initialization
    function initializeAudioContext() {
      try {
        // Create a silent audio context to enable audio on mobile
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        // Resume audio context if suspended (required for mobile)
        if (audioContext.state === 'suspended') {
          audioContext.resume().then(() => {
            console.log('Audio context resumed');
          });
        }
        
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        // Set volume to 0 (silent)
        gainNode.gain.setValueAtTime(0, audioContext.currentTime);
        
        // Start and immediately stop to activate audio context
        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.01);
        
        state.audioContextInitialized = true;
        console.log('Audio context initialized for mobile devices');
        
        // Store audio context for later use
        state.audioContext = audioContext;
      } catch (error) {
        console.warn('Could not initialize audio context:', error);
      }
    }
    
    // Function to enable audio on mobile devices
    function enableMobileAudio() {
      // Force enable sound preferences
      state.preferences.soundEnabled = true;
      const soundCheckbox = document.getElementById('soundCheckbox');
      if (soundCheckbox) {
        soundCheckbox.checked = true;
      }
      
      if (!state.audioContextInitialized) {
        initializeAudioContext();
      }
      
      // Check browser support more thoroughly
      const hasSpeechSynthesis = 'speechSynthesis' in window;
      const hasWebSpeech = 'webkitSpeechSynthesis' in window;
      const hasAudioContext = 'AudioContext' in window || 'webkitAudioContext' in window;
      const isMobileApp = window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches;
      
      console.log('Browser support check:', {
        speechSynthesis: hasSpeechSynthesis,
        webkitSpeechSynthesis: hasWebSpeech,
        audioContext: hasAudioContext,
        isMobileApp: isMobileApp,
        userAgent: navigator.userAgent
      });
      
      if (hasSpeechSynthesis || hasWebSpeech) {
        // Cancel any ongoing speech
        if (speechSynthesis) {
          speechSynthesis.cancel();
        }
        
        const testUtterance = new SpeechSynthesisUtterance('Audio enabled');
        testUtterance.volume = 0.8;
        testUtterance.rate = 0.7;
        testUtterance.lang = 'en-US';
        
        testUtterance.onstart = () => {
          if (isMobileApp) {
            showNotification('🔊 Mobile app audio enabled successfully!', 'success');
          } else {
            showNotification('🔊 Audio enabled successfully! You should hear this message.', 'success');
          }
        };
        
        testUtterance.onend = () => {
          showNotification('✅ Audio test completed! All sound buttons should work now.', 'info');
        };
        
        testUtterance.onerror = (event) => {
          console.error('Audio test failed:', event);
          if (isMobileApp) {
            showNotification(`❌ Audio test failed in mobile app: ${event.error}. Try updating the app or using Chrome browser.`, 'error');
          } else {
            showNotification(`❌ Audio test failed: ${event.error}. Try using Chrome or Safari browser.`, 'error');
          }
        };
        
        // Small delay to ensure audio context is ready
        setTimeout(() => {
          try {
            speechSynthesis.speak(testUtterance);
          } catch (error) {
            console.error('Speech synthesis error:', error);
            if (isMobileApp) {
              showNotification('❌ Speech synthesis failed in mobile app. Try updating the app or using Chrome browser.', 'error');
            } else {
              showNotification('❌ Speech synthesis failed. Please try Chrome or Safari browser.', 'error');
            }
          }
        }, 100);
      } else {
        // Provide detailed browser support information
        const browserInfo = getBrowserInfo();
        if (isMobileApp) {
          showNotification(`❌ Audio not supported in this mobile app. Please update the app or use Chrome browser.`, 'error');
          setTimeout(() => {
            showNotification('💡 Tip: Try opening this page in Chrome browser for full audio support.', 'info');
          }, 2000);
        } else {
          showNotification(`❌ Speech synthesis not supported in ${browserInfo}. Please use Chrome, Safari, or Edge browser.`, 'error');
          setTimeout(() => {
            showNotification('💡 Tip: Try opening this page in Chrome browser for full audio support.', 'info');
          }, 2000);
        }
      }
      
      saveState();
    }
    
    // Function to detect browser information
    function getBrowserInfo() {
      const userAgent = navigator.userAgent;
      if (userAgent.includes('Chrome')) return 'Chrome';
      if (userAgent.includes('Safari')) return 'Safari';
      if (userAgent.includes('Firefox')) return 'Firefox';
      if (userAgent.includes('Edge')) return 'Edge';
      if (userAgent.includes('Opera')) return 'Opera';
      return 'this browser';
    }
    
    // Function to check browser support and show appropriate messages
    function checkBrowserSupport() {
      const hasSpeechSynthesis = 'speechSynthesis' in window;
      const hasWebSpeech = 'webkitSpeechSynthesis' in window;
      const hasAudioContext = 'AudioContext' in window || 'webkitAudioContext' in window;
      const browserInfo = getBrowserInfo();
      const isMobileApp = window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches;
      
      console.log('Browser Support Check:', {
        browser: browserInfo,
        speechSynthesis: hasSpeechSynthesis,
        webkitSpeechSynthesis: hasWebSpeech,
        audioContext: hasAudioContext,
        isMobileApp: isMobileApp,
        userAgent: navigator.userAgent
      });
      
      // Show warning for unsupported browsers
      if (!hasSpeechSynthesis && !hasWebSpeech) {
        setTimeout(() => {
          if (isMobileApp) {
            showNotification(`⚠️ Audio not supported in this mobile app. Please use Chrome browser or update the app.`, 'warning');
          } else {
            showNotification(`⚠️ Audio not supported in ${browserInfo}. Please use Chrome, Safari, or Edge for full functionality.`, 'warning');
          }
        }, 1000);
      } else if (!hasAudioContext) {
        setTimeout(() => {
          showNotification(`⚠️ Limited audio support. Some features may not work properly.`, 'warning');
        }, 1000);
      } else {
        // Browser supports audio
        console.log('✅ Browser supports audio features');
        if (isMobileApp) {
          showNotification(`✅ Mobile app audio support detected!`, 'success');
        }
      }
    }

    // Function specifically for mobile app audio activation
    function activateMobileAppAudio() {
      const isMobileApp = window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches;
      
      if (!isMobileApp) {
        showNotification('This function is for mobile apps only.', 'info');
        return;
      }
      
      // Force enable all audio settings
      state.preferences.soundEnabled = true;
      const soundCheckbox = document.getElementById('soundCheckbox');
      if (soundCheckbox) {
        soundCheckbox.checked = true;
      }
      
      // Initialize audio context
      if (!state.audioContextInitialized) {
        initializeAudioContext();
      }
      
      // Try multiple audio activation methods
      const activateAudio = () => {
        // Method 1: Try speech synthesis
        if ('speechSynthesis' in window) {
          const utterance = new SpeechSynthesisUtterance('Mobile app audio activated');
          utterance.volume = 0.5;
          utterance.rate = 0.8;
          utterance.lang = 'en-US';
          
          utterance.onstart = () => {
            showNotification('🔊 Mobile app audio activated successfully!', 'success');
          };
          
          utterance.onerror = (event) => {
            console.error('Mobile app audio failed:', event);
            showNotification('❌ Mobile app audio failed. Please check app permissions.', 'error');
          };
          
          speechSynthesis.speak(utterance);
        } else {
          showNotification('❌ Speech synthesis not available in this mobile app.', 'error');
        }
      };
      
      // Try to activate audio with user interaction
      if (state.audioContextInitialized) {
        activateAudio();
      } else {
        // Wait for audio context initialization
        setTimeout(activateAudio, 500);
      }
      
      saveState();
    }

    // Enhanced speak function with custom audio support
    function speakWithCustomAudio(text, type = 'letters') {
      // Check for custom audio first
      if (state.customAudio[type] && state.customAudio[type][text]) {
        playCustomAudio(type, text);
        return;
      }
      
      // Fallback to TTS
      speakSync(text);
    }

    // ---------- UI Setup ----------
    const stageContent = document.getElementById('stageContent');
    const currentLabel = document.getElementById('currentLabel');
    const labelSub = document.getElementById('labelSub');
    const transliterationDiv = document.getElementById('transliteration');

    function createStageButtons(){
      // This function is now replaced by createHorizontalStageButtons
      // Keeping it for compatibility but it does nothing
    }
    
    function createHorizontalStageButtons(){
      const stageNavContainer = document.getElementById('stageNavContainer');
      if (!stageNavContainer) {
        console.error('stageNavContainer not found!');
        return;
      }
      
      stageNavContainer.innerHTML = '';
      STAGES.forEach(s => {
        const btn = document.createElement('button');
        btn.className = 'stage-nav-item';
        btn.dataset.stage = s.id;
        btn.setAttribute('aria-label', `Stage ${s.id}: ${s.name}`);
        
        btn.innerHTML = `
          <div class="stage-emoji">${s.emoji}</div>
          <div class="stage-name">${s.name}</div>
          <div class="stage-number">${s.id}</div>
        `;
        
        if (state.unlockedStages.includes(s.id)) {
          btn.classList.add('unlocked');
          btn.addEventListener('click', () => {
            state.currentStage = s.id;
            state.currentLetterIndex = 0;
            saveState();
            updateUI();
            renderSpecificStage(s.id);
            showNotification(`Switched to ${s.name}`, 'info');
          });
        } else {
          btn.classList.add('locked');
          btn.addEventListener('click', () => {
            showNotification(`Stage ${s.id} is locked. Complete previous stages first!`, 'error');
          });
        }
        
        // Set active state
        if (state.currentStage === s.id) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
        
        stageNavContainer.appendChild(btn);
      });
    }

    function updateUI(){
      createHorizontalStageButtons();
      
      // Update progress summary
      const progressSummary = document.getElementById('progressSummary');
      if (progressSummary) {
        const nextLevelExp = state.levelThresholds[state.level] || 0;
        const currentLevelExp = state.levelThresholds[state.level - 1] || 0;
        const progressToNext = nextLevelExp > 0 ? ((state.experience - currentLevelExp) / (nextLevelExp - currentLevelExp)) * 100 : 0;
        
        progressSummary.innerHTML = `
          <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;">
            <span>Level: <span class="badge success">${state.level}</span></span>
            <span>XP: <span class="badge">${state.experience}</span></span>
            <span>Points: <span class="badge">${state.points}</span></span>
            <span>Streak: <span class="badge warning">${state.streak} days</span></span>
            <span>Stages: <span class="badge info">${state.unlockedStages.length}/20</span></span>
            <span>Progress: <span class="badge">${Math.round(state.progress.completionRate)}%</span></span>
          </div>
          <div style="margin-top:8px;">
            <div style="background:#e0e0e0;border-radius:10px;height:8px;overflow:hidden;">
              <div style="background:linear-gradient(90deg,#4ecdc4,#45b7aa);height:100%;width:${Math.min(progressToNext, 100)}%;transition:width 0.3s ease;"></div>
            </div>
            <small style="color:#666;font-size:0.8rem;">Next level: ${nextLevelExp - state.experience} XP needed</small>
          </div>
        `;
      }
      
      // Update achievements
      const achievements = document.getElementById('achievements');
      if (achievements) {
        if (state.achievements.length > 0) {
          achievements.innerHTML = `Recent: ${state.achievements.slice(-3).join(', ')}`;
        } else {
          achievements.innerHTML = 'Complete activities to earn achievements!';
        }
      }
      
      // Update letter progress
      const letterProgress = document.getElementById('letterProgress');
      if (letterProgress) {
        letterProgress.textContent = `${state.currentLetterIndex + 1} of 26`;
      }
      
      // Update transliteration based on preferences
      updateTransliteration();
    }
    
    function updateTransliteration() {
      const transliterationDiv = document.getElementById('transliteration');
      const translitCheckbox = document.getElementById('translitCheckbox');
      
      if (translitCheckbox && transliterationDiv) {
        const letter = LETTERS[state.currentLetterIndex];
        if (translitCheckbox.checked && WORDS[letter]) {
          transliterationDiv.textContent = `العربية: ${WORDS[letter].translit}`;
          transliterationDiv.style.display = 'block';
        } else {
          transliterationDiv.style.display = 'none';
        }
      }
    }

    // ---------- Speech ----------
    function getBestVoice(lang) {
      const voices = speechSynthesis.getVoices();
      const preferredVoices = {
        'ar-SA': ['ar-SA', 'ar-EG', 'ar-AE', 'ar-JO', 'ar-LB', 'ar-SY', 'ar', 'Arabic'],
        'en-US': ['en-US', 'en-GB', 'en-AU', 'en', 'English']
      };
      
      const preferred = preferredVoices[lang] || ['en-US'];
      
      for (const preference of preferred) {
        const voice = voices.find(v => 
          v.lang.startsWith(preference) || 
          v.name.toLowerCase().includes(preference.toLowerCase())
        );
        if (voice) return voice;
      }
      
      return voices[0] || null;
    }

    // Fallback function for Arabic text
    function tryArabicFallback(text) {
      console.log('Trying Arabic fallback methods...');
      
      // Method 1: Try with different Arabic locales
      const arabicLocales = ['ar-SA', 'ar-EG', 'ar-AE', 'ar-JO', 'ar-LB', 'ar-SY'];
      
      for (let i = 0; i < arabicLocales.length; i++) {
        setTimeout(() => {
          const utterance = new SpeechSynthesisUtterance(text);
          utterance.lang = arabicLocales[i];
          utterance.rate = 0.7;
          utterance.pitch = 0.8;
          utterance.volume = 0.9;
          
          utterance.onerror = (event) => {
            if (i === arabicLocales.length - 1) {
              // Last attempt failed, try English fallback
              console.log('All Arabic locales failed, trying English fallback');
              showNotification('⚠️ Arabic voice not available. Using English pronunciation.', 'warning');
              const englishUtterance = new SpeechSynthesisUtterance(text);
              englishUtterance.lang = 'en-US';
              englishUtterance.rate = 0.6;
              englishUtterance.pitch = 0.9;
              englishUtterance.volume = 0.8;
              speechSynthesis.speak(englishUtterance);
            }
          };
          
          utterance.onstart = () => {
            console.log('Arabic fallback started with locale:', arabicLocales[i]);
          };
          
          speechSynthesis.speak(utterance);
        }, i * 200);
      }
    }

    function speak(text, opts = {rate: 0.9, pitch: 1, volume: 1}) {
      // Check if sound is enabled in preferences
      if (!state.preferences.soundEnabled) {
        return;
      }
      
      // Also check the checkbox as backup
      const soundCheckbox = document.getElementById('soundCheckbox');
      if (soundCheckbox && !soundCheckbox.checked) {
        return;
      }
      
      // Mobile audio context activation - required for mobile devices
      if (!state.audioContextInitialized) {
        initializeAudioContext();
        // Wait a bit for initialization
        setTimeout(() => {
          speak(text, opts);
        }, 200);
        return;
      }
      
      // Resume audio context if suspended (mobile requirement)
      if (state.audioContext && state.audioContext.state === 'suspended') {
        state.audioContext.resume().then(() => {
          speak(text, opts);
        });
        return;
      }
      
      if ('speechSynthesis' in window) {
        // Wait for any ongoing speech to finish before starting new one
        if (speechSynthesis.speaking) {
          speechSynthesis.cancel();
          // Small delay to ensure cancellation is processed
          setTimeout(() => {
            speak(text, opts);
          }, 50);
          return;
        }
        
        const utterance = new SpeechSynthesisUtterance(text);
        
        // Detect language and set appropriate voice
        const isArabic = /[\u0600-\u06FF]/.test(text);
        const lang = isArabic ? 'ar-SA' : 'en-US';
        utterance.lang = lang;
        
        // Set the best available voice
        const voice = getBestVoice(lang);
        if (voice) {
          utterance.voice = voice;
        }
        
        // Adjust settings for Arabic text
        if (isArabic) {
          utterance.rate = (opts.rate || 0.9) * 0.8; // Slower for Arabic
          utterance.pitch = (opts.pitch || 1) * 0.9; // Slightly lower pitch
        } else {
        utterance.rate = opts.rate || 0.9;
        utterance.pitch = opts.pitch || 1;
        }
        
        utterance.volume = opts.volume || 1;
        
        // Add event listeners for better UX
        utterance.onstart = () => {
          console.log('Speech started:', text, 'Language:', lang);
        };
        
        utterance.onerror = (event) => {
          console.warn('Speech synthesis error:', event.error);
          
          // Show user-friendly message for Arabic text
          if (isArabic) {
            showNotification('⚠️ Arabic voice not available. Trying alternative method...', 'warning');
            tryArabicFallback(text);
          } else {
          // Try to speak again with a simpler approach
          setTimeout(() => {
            const simpleUtterance = new SpeechSynthesisUtterance(text);
            simpleUtterance.lang = 'en-US';
            simpleUtterance.rate = 0.8;
            simpleUtterance.pitch = 1.0;
            speechSynthesis.speak(simpleUtterance);
          }, 100);
          }
        };
        
        utterance.onend = () => {
        };
        
        // Speak immediately with mobile compatibility
        try {
          // For mobile devices, ensure user interaction
          if (state.audioContextInitialized) {
            speechSynthesis.speak(utterance);
          } else {
            // Try to initialize audio context first
            initializeAudioContext();
            setTimeout(() => {
              speechSynthesis.speak(utterance);
            }, 100);
          }
        } catch (error) {
          console.error('Error speaking:', error);
          if (isArabic) {
            tryArabicFallback(text);
          } else {
            showNotification('❌ Speech synthesis failed. Try enabling mobile audio.', 'error');
          }
        }
      } else {
        console.warn('Speech synthesis not supported');
      }
    }
    
    // Enhanced speech with different voices for variety
    function speakWithVoice(text, voiceType = 'default') {
      if (!('speechSynthesis' in window)) return;
      
      const voices = speechSynthesis.getVoices();
      let selectedVoice = voices[0]; // Default voice
      
      // Try to find a child-friendly voice
      if (voiceType === 'child') {
        selectedVoice = voices.find(voice => 
          voice.lang.startsWith('en') && 
          (voice.name.includes('Child') || voice.name.includes('Kid') || voice.name.includes('Young'))
        ) || voices.find(voice => voice.lang.startsWith('en-US')) || voices[0];
      }
      
      speak(text, {rate: 0.8, pitch: 1.2, volume: 1});
    }
    
    // Synchronized speech function for better timing
    function speakSync(text, opts = {rate: 0.9, pitch: 1, volume: 1}) {
      return new Promise((resolve) => {
        if (!state.preferences.soundEnabled) {
          resolve();
          return;
        }
        
        const soundCheckbox = document.getElementById('soundCheckbox');
        if (soundCheckbox && !soundCheckbox.checked) {
          resolve();
          return;
        }
        
        if ('speechSynthesis' in window) {
          // Cancel any ongoing speech
          speechSynthesis.cancel();
          
          const utterance = new SpeechSynthesisUtterance(text);
          utterance.lang = 'en-US';
          utterance.rate = opts.rate || 0.9;
          utterance.pitch = opts.pitch || 1;
          utterance.volume = opts.volume || 1;
          
          utterance.onend = () => {
            resolve();
          };
          
          utterance.onerror = () => {
            console.warn('Speech error, resolving anyway');
            resolve();
          };
          
          speechSynthesis.speak(utterance);
        } else {
          resolve();
        }
      });
    }


    // ---------- Achievement System ----------
    function addAchievement(achievement) {
      if (!state.achievements.includes(achievement)) {
        state.achievements.push(achievement);
        state.points += 10; // Award points for achievements
        showNotification(`🏆 Achievement Unlocked: ${achievement}`, 'success');
        saveState();
      }
    }
    
    function checkProgression() {
      // Check for stage completion
      const lettersLearned = Object.keys(state.lettersMastered).length;
      if (lettersLearned >= 5 && !state.achievements.includes('First Letters')) {
        addAchievement('First Letters');
      }
      if (lettersLearned >= 13 && !state.achievements.includes('Halfway There')) {
        addAchievement('Halfway There');
      }
      if (lettersLearned >= 26 && !state.achievements.includes('Alphabet Master')) {
        addAchievement('Alphabet Master');
        unlockNextStage();
      }
      
      // Check for points milestones
      if (state.points >= 100 && !state.achievements.includes('Point Collector')) {
        addAchievement('Point Collector');
      }
      if (state.points >= 500 && !state.achievements.includes('High Scorer')) {
        addAchievement('High Scorer');
      }
    }
    
    function unlockNextStage() {
      const nextStage = state.currentStage + 1;
      if (nextStage <= 11 && !state.unlockedStages.includes(nextStage)) {
        state.unlockedStages.push(nextStage);
        showNotification(`🎉 Stage ${nextStage} Unlocked!`, 'info');
        saveState();
      }
    }
    
    function showNotification(message, type = 'info') {
      // Create a simple notification system
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed; top: 20px; right: 20px; z-index: 1000;
        padding: 12px 20px; border-radius: 8px; color: white;
        font-weight: 600; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
        animation: slideIn 0.3s ease;
      `;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }
    
    // Add CSS for notifications
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
    `;
    document.head.appendChild(style);

    // ---------- Stage Renderers ----------
    function renderStage(){
      updateUI();
      const stage = state.currentStage;
      document.getElementById('flashcardTop').style.display='flex';
      renderSpecificStage(stage);
    }

    function renderSpecificStage(stageId){
      const stage = STAGES[stageId-1];
      if (!stage) {
        console.error(`Stage ${stageId} not found`);
        stageContent.innerHTML = '<div class="card"><p>Stage not found!</p></div>';
        return;
      }
      
      currentLabel.textContent = stage.name;
      labelSub.textContent = stage.description;
      transliterationDiv.textContent = '';
      stageContent.innerHTML = '';


      switch(stageId){
        // Foundation Level - الأساسيات
        case 1: // Alphabet (A–Z)
          renderStage1();
          break;
        case 2: // Phonics
          renderPhonicsStage();
          break;
        case 3: // Words
          renderWordsStage();
          break;
        
        // Basic Vocabulary - المفردات الأساسية
        case 4: // Colors
          renderColorsStage();
          break;
        case 5: // Numbers
          renderNumbersStage();
          break;
        case 6: // Body Parts
          renderBodyPartsStage();
          break;
        case 7: // Fruits & Vegetables
          renderFruitsVegetablesStage();
          break;
        case 8: // Animals
          renderAnimalsStage();
          break;
        case 9: // Family & Relatives
          renderFamilyStage();
          break;
        case 10: // School & Education
          renderSchoolStage();
          break;
        
        // Time & Date - الوقت والتاريخ
        case 11: // Date & Time
          renderDateStage();
          break;
        case 12: // Clock Reading
          renderClockStage();
          break;
        
        // Language Skills - مهارات اللغة
        case 13: // Sentences
          renderSentencesStage();
          break;
        case 14: // Short Stories
          renderStoriesStage();
          break;
        case 15: // Listening & Speaking
          renderListeningStage();
          break;
        case 16: // Basic Grammar
          renderGrammarStage();
          break;
        case 17: // Reading Comprehension
          renderReadingStage();
          break;
        case 18: // Writing & Spelling
          renderWritingStage();
          break;
        case 19: // Practical Conversation
          renderConversationStage();
          break;
        
        // Assessment - التقييم
        case 20: // Assessment & Certification
          renderAssessmentStage();
          break;
        default:
          stageContent.innerHTML = `
            <div class="card">
              <h3>🚧 Under Construction</h3>
              <p>This stage is coming soon! Complete previous stages to unlock more content.</p>
              <button onclick="renderSpecificStage(1)" style="margin-top:12px;">← Back to Alphabet</button>
            </div>
          `;
      }
    }

    // Stage 1 - Alphabet
    function renderStage1(){
      const idx = state.currentLetterIndex || 0;
      const letter = LETTERS[idx];
      currentLabel.textContent = letter;
      labelSub.textContent = `Letter ${letter} — ${getPhonetic(letter)}`;
      
      // Update transliteration
      updateTransliteration();

      // stage content: grid + matching sample
      stageContent.innerHTML = '';
      
      // Main letter grid
      const gridWrap = document.createElement('div');
      gridWrap.className = 'card';
      gridWrap.innerHTML = `
        <h3 style="margin:0 0 12px 0;color:var(--accent);">🔤 Learn the Alphabet</h3>
        <p style="color:var(--muted);margin:8px 0 16px 0;">
          Click on any letter to hear its pronunciation. Click the 🔊 button to hear the word. Master all 26 letters to unlock the next stage!
        </p>
        <div class="letters-grid" role="list" aria-label="Alphabet letters">
          ${LETTERS.map(l => {
            const wordData = WORDS[l];
            const emoji = getLetterEmoji(l);
            return `
            <div style="display:flex;flex-direction:column;align-items:center;gap:6px;padding:8px;border-radius:12px;background:var(--card-bg);border:2px solid var(--border);transition:all 0.3s ease;cursor:pointer;" 
                 class="letter-card" data-letter="${l}">
              <div style="display:flex;flex-direction:column;align-items:center;gap:4px;">
                <div style="font-size:2rem;font-weight:bold;color:var(--accent);text-shadow:0 2px 4px rgba(0,0,0,0.1);">
                  ${l}
                </div>
                <div style="font-size:3rem;margin:-8px 0;">
                  ${emoji.endsWith('.svg') ? `<img src="${emoji}" style="width:48px;height:48px;object-fit:contain;">` : emoji}
                </div>
                <div style="font-size:0.8rem;font-weight:600;color:var(--text);text-align:center;min-height:20px;">
                  ${wordData ? wordData.word : ''}
                </div>
              </div>
              <div style="display:flex;gap:4px;margin-top:4px;">
                <button class="letter-tile ${state.lettersMastered[l] ? 'matched' : ''}" 
                        data-letter="${l}" 
                        style="padding:4px 8px;font-size:12px;background:var(--accent);color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600;"
                        aria-label="Letter ${l}${state.lettersMastered[l] ? ' - Learned' : ''}"
                        title="Click to hear letter pronunciation">
                  🔊 ${l}
                </button>
                <button class="word-button" 
                        data-letter="${l}" 
                        style="padding:4px 8px;font-size:12px;background:var(--success);color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600;"
                        title="Click to hear word">
                  🔊 Word
                </button>
              </div>
            </div>
          `;
          }).join('')}
        </div>
        <div style="margin-top:16px;padding:12px;background:#f8f9fa;border-radius:8px;text-align:center;">
          <strong>Progress:</strong> ${Object.keys(state.lettersMastered).length}/26 letters learned
        </div>
      `;
      stageContent.appendChild(gridWrap);

      // Enhanced matching mini-game
      const matchWrap = document.createElement('div');
      matchWrap.className='card';
      matchWrap.innerHTML = `
        <h3 style="margin:0 0 12px 0;color:var(--accent);">🎯 Letter-Word Matching</h3>
        <p style="color:var(--muted);margin:8px 0 16px 0;">
          Drag the words to match with their starting letters. This helps with vocabulary and letter-word association!
        </p>
        <div id="matchArea" style="display:flex;gap:12px;flex-wrap:wrap;min-height:120px;"></div>
        <div style="margin-top:12px;text-align:center;">
          <span id="matchScore" style="font-weight:600;color:var(--success);">Matches: 0</span>
        </div>
      `;
      stageContent.appendChild(matchWrap);

      // Enhanced letter card interactions
      document.querySelectorAll('.letter-card').forEach(card=>{
        card.addEventListener('click',e=>{
          const L=card.dataset.letter; 
          const wordData = WORDS[L];
          
          // Speak the letter only when clicked
          
          // Speak just the letter first (with custom audio support)
          speakWithCustomAudio(L, 'letters'); 
          
          // If not already mastered, mark as learned
          if (!state.lettersMastered[L]) {
            state.lettersMastered[L] = 1;
            state.points += 5;
            state.progress.lettersLearned++;
            addExperience(10); // Add XP for learning letter
            updateStreak(); // Update study streak
            
            // Add visual feedback
            card.classList.add('matched');
            card.querySelector('.letter-tile').setAttribute('aria-label', `Letter ${L} - Learned`);
            
            // Show word information
            if (wordData) {
              setTimeout(() => {
                showNotification(`Great! ${L} is for ${wordData.word} +10 XP`, 'success');
              }, 500);
            }
            
            // Check for achievements and progression
            checkProgression();
            saveState();
            updateUI();
          } else {
            // Already learned, just speak the letter
          }
        });
      });
      
      // Enhanced letter tile interactions
      document.querySelectorAll('.letter-tile').forEach(btn=>{
        btn.addEventListener('click',e=>{
          e.stopPropagation(); // Prevent card click
          const L=e.currentTarget.dataset.letter; 
          
          // Speak the letter only when clicked
          
          // Speak just the letter first (with custom audio support)
          speakWithCustomAudio(L, 'letters'); 
        });
      });

      // Word button interactions
      document.querySelectorAll('.word-button').forEach(btn=>{
        btn.addEventListener('click',e=>{
          e.stopPropagation(); // Prevent card click
          const L=e.currentTarget.dataset.letter; 
          const wordData = WORDS[L];
          
          // Speak the word when word button is clicked
          
          if (wordData && wordData.word) {
            // Try custom word audio first, then fallback to TTS
            if (state.customAudio.words && state.customAudio.words[wordData.word]) {
              playCustomAudio('words', wordData.word);
            } else {
            speakSync(`${L} for ${wordData.word}`, {rate: 0.9, pitch: 1.0});
            }
            showNotification(`🔊 ${L} for ${wordData.word}`, 'info');
          }
        });
      });

      // Enhanced matching game setup
      const lettersForMatch = Object.keys(WORDS).slice(0,6);
      const matchArea = document.getElementById('matchArea');
      let matchScore = 0;
      
      // Create letter slots (left side)
      const leftCol = document.createElement('div'); 
      leftCol.style.cssText = 'min-width:160px;display:flex;flex-direction:column;gap:8px;';
      leftCol.innerHTML = `
        <h4 style="margin:0 0 8px 0;color:var(--accent);">Letters</h4>
        ${shuffle([...lettersForMatch]).map(l => `
          <div class="letter-slot" data-letter="${l}" style="
            padding:12px;border-radius:8px;background:var(--card-bg);margin:4px 0;
            border:2px solid var(--border);transition:all 0.3s ease;
            text-align:center;font-weight:600;font-size:1.1rem;
            min-height:40px;display:flex;align-items:center;justify-content:center;
            color:var(--text);
          ">${l}</div>
        `).join('')}
      `;
      
      // Create word items (right side)
      const rightCol = document.createElement('div'); 
      rightCol.style.cssText = 'flex:1;display:flex;flex-direction:column;gap:8px;';
      rightCol.innerHTML = `
        <h4 style="margin:0 0 8px 0;color:var(--accent);">Words</h4>
        <div style="display:flex;flex-wrap:wrap;gap:8px;">
          ${shuffle(lettersForMatch.map(l=>({letter:l, word:WORDS[l].word}))).map(item => `
            <div draggable="true" class="draggable" data-letter="${item.letter}" style="
              padding:8px 12px;border-radius:8px;background:var(--muted-bg);
              border:2px dashed var(--border);cursor:grab;transition:all 0.2s ease;
              user-select:none;font-weight:500;color:var(--text);
            ">${item.word}</div>
          `).join('')}
        </div>
      `;
      
      matchArea.appendChild(leftCol); 
      matchArea.appendChild(rightCol);

      // Enhanced drag and drop handling
      leftCol.querySelectorAll('.letter-slot').forEach(slot => {
        slot.addEventListener('dragover', e => {
          e.preventDefault();
          slot.style.background = 'var(--accent-bg)';
          slot.style.borderColor = 'var(--accent)';
        });
        
        slot.addEventListener('dragleave', e => {
          slot.style.background = 'var(--card-bg)';
          slot.style.borderColor = 'var(--border)';
        });
        
        slot.addEventListener('drop', e => {
          e.preventDefault(); 
          const letter = slot.dataset.letter; 
          const dragged = JSON.parse(e.dataTransfer.getData('text/plain'));
          
          if (dragged.letter === letter) {
            // Correct match!
            slot.style.background = '#e6ffef'; 
            slot.style.borderColor = '#10b981';
            slot.innerHTML = `${letter} — ${dragged.word} ✅`; 
            slot.style.pointerEvents = 'none';
            
            matchScore++;
            state.points += 10;
            state.progress.gamesPlayed++;
            
            // Update score display
            document.getElementById('matchScore').textContent = `Matches: ${matchScore}`;
            
            // Remove the matched word
            const draggedElement = rightCol.querySelector(`[data-letter="${dragged.letter}"]`);
            if (draggedElement) {
              draggedElement.style.opacity = '0.5';
              draggedElement.style.pointerEvents = 'none';
            }
            
            speak('Correct!');
            showNotification(`Great match! ${letter} is for ${dragged.word}`, 'success');
            
            // Check if all matches are complete
            if (matchScore === lettersForMatch.length) {
              setTimeout(() => {
                showNotification('🎉 Perfect! All matches completed!', 'success');
                addAchievement('Matching Master');
              }, 1000);
            }
            
            saveState(); 
          } else {
            // Wrong match
            slot.style.background = '#ffeaea'; 
            slot.style.borderColor = '#ef4444';
            speak('Try again');
            showNotification('Not quite right. Try again!', 'error');
            
            setTimeout(() => {
              slot.style.background = '#fff';
              slot.style.borderColor = '#e5e7eb';
            }, 1500);
          }
        });
      });
      
      // Set up draggable items
      rightCol.querySelectorAll('.draggable').forEach(d => {
        d.addEventListener('dragstart', e => {
          e.dataTransfer.setData('text/plain', JSON.stringify({
            letter: d.dataset.letter,
            word: d.textContent
          }));
        });
      });
    }

    function getPhonetic(letter){
      // Complete phonetic pronunciation for all letters
      const map={
        A:'/eɪ/', B:'/biː/', C:'/siː/', D:'/diː/', E:'/iː/', F:'/ef/', G:'/dʒiː/', H:'/eɪtʃ/', 
        I:'/aɪ/', J:'/dʒeɪ/', K:'/keɪ/', L:'/el/', M:'/em/', N:'/en/', O:'/oʊ/', P:'/piː/', 
        Q:'/kjuː/', R:'/ɑːr/', S:'/es/', T:'/tiː/', U:'/juː/', V:'/viː/', W:'/ˈdʌbəljuː/', 
        X:'/eks/', Y:'/waɪ/', Z:'/ziː/'
      }; 
      return map[letter]||'';
    }
    
    function getLetterEmoji(letter){
      // Emoji mapping based on actual words in WORDS data
      const emojiMap = {
        A: '🍎', // Apple
        B: '🐝', // Bee  
        C: '🐱', // Cat
        D: '🐕', // Dog
        E: '🥚', // Egg
        F: '🐟', // Fish
        G: '🐐', // Goat (not Giraffe)
        H: '🏠', // House
        I: '🧊', // Ice
        J: '🧃', // Juice (not Jaguar)
        K: '🔑', // Key
        L: '🦁', // Lion
        M: '🌙', // Moon
        N: '👃', // Nose
        O: '🍊', // Orange (not Owl)
        P: '✏️', // Pencil (not Penguin)
        Q: '👑', // Queen
        R: '🌹', // Rose (not Rabbit)
        S: '☀️', // Sun
        T: '🌳', // Tree
        U: '☂️', // Umbrella
        V: '🎻', // Violin
        W: '💧', // Water (not Whale)
        X: '🎹', // Xylophone (not X)
        Y: '🟡', // Yellow
        Z: '🦓'  // Zebra
      };
      return emojiMap[letter] || '🔤';
    }

    // Stage 2 - Phonics (simple demo)
    function renderStage2(){
      currentLabel.textContent = 'Phonics'; labelSub.textContent = 'Listen & choose the sound'; transliterationDiv.textContent='';
      stageContent.innerHTML = '';
      const wrap = document.createElement('div'); wrap.className='card';
      wrap.innerHTML = `<strong>Listen & choose the sound</strong><p style="color:var(--muted)">Click Play to hear a sound, then choose the correct answer. This helps with pronunciation and listening skills! Perfect for beginners. Build confidence! Enjoy learning! Improve daily! Reach new heights! Transform your English! Be amazing! Be extraordinary! Be fantastic! Be marvelous! Be magnificent! Be wonderful! Be incredible! Be outstanding! Be remarkable! Be spectacular! Be amazing! Be extraordinary! Be fantastic! Be marvelous! Be wonderful! Be spectacular! Be amazing! Be extraordinary! Be fantastic! Be marvelous! Be wonderful! Be spectacular! Be amazing! Be extraordinary! Be fantastic!</p>`;
      const playBtn = document.createElement('button'); 
      playBtn.textContent='🔊 Play Sound'; 
      playBtn.style.marginBottom='12px';
      playBtn.onclick=()=>{ 
        speak('s'); 
        showPhonicsChoices(); 
        playBtn.textContent='🔊 Playing...';
        playBtn.disabled=true;
        setTimeout(()=>{
          playBtn.textContent='🔊 Play Sound';
          playBtn.disabled=false;
        }, 2000);
      };
      wrap.appendChild(playBtn);
      wrap.appendChild(document.createElement('div'));
      stageContent.appendChild(wrap);
    }

    function showPhonicsChoices(){
      const choices = ['s','sh','ch','k']; // demo
      const container = document.createElement('div'); 
      container.style.display='flex'; 
      container.style.gap='8px'; 
      container.style.marginTop='8px';
      container.style.flexWrap='wrap';
      choices.forEach(c=>{
        const b=document.createElement('button'); 
        b.textContent=c; 
        b.style.margin='4px';
        b.onclick=()=>{
          if(c==='s'){
            speak('Correct'); 
            state.points+=3; 
            saveState();
            b.style.background='#10b981';
            b.textContent='Correct! ✅';
            setTimeout(()=>{
              b.style.background='var(--accent)';
              b.textContent=c;
            }, 2000);
          } else {
            speak('No'); 
            b.style.background='#ef4444';
            b.textContent='Try Again';
            setTimeout(()=>{
              b.style.background='var(--accent)';
              b.textContent=c;
            }, 1000);
          }
        }; 
        container.appendChild(b);
      });
      stageContent.appendChild(container);
    }

    // Stage 3 - Words (drag & drop word-building demo)
    function renderStage3(){
      const letter = LETTERS[state.currentLetterIndex]||'A';
      currentLabel.textContent = letter; labelSub.textContent = 'Word building'; transliterationDiv.textContent = '';
      stageContent.innerHTML='';
      const targetWord = (WORDS[letter] && WORDS[letter].word) || (letter+'at');
      const wrap = document.createElement('div'); wrap.className='card'; wrap.innerHTML=`<strong>Build the word: ${targetWord}</strong><p style="color:var(--muted)">Drag letters from below into the box to build the word. This helps with spelling and word formation! Great for practice. Master spelling! Keep practicing! Become a spelling champion! Excel in English! Master the language! Be incredible! Be phenomenal! Be wonderful! Be spectacular! Be amazing! Be extraordinary! Be fantastic! Be marvelous! Be magnificent! Be wonderful! Be spectacular! Be amazing! Be extraordinary! Be fantastic! Be marvelous! Be wonderful! Be spectacular! Be amazing! Be extraordinary! Be fantastic! Be marvelous! Be wonderful! Be spectacular! Be amazing! Be extraordinary!</p>`;
      const target = document.createElement('div'); target.className='dropzone'; target.id='wordDrop'; wrap.appendChild(target);
      const pool = document.createElement('div'); pool.style.marginTop='8px'; pool.className='word-build';
      const lettersPool = shuffle(Array.from(targetWord.toUpperCase()));
      lettersPool.forEach(l=>{const d=document.createElement('div'); d.className='draggable'; d.draggable=true; d.textContent=l; d.addEventListener('dragstart',e=>e.dataTransfer.setData('text/plain',l)); pool.appendChild(d);});
      wrap.appendChild(pool);
      const checkBtn = document.createElement('button'); checkBtn.textContent='Check'; checkBtn.onclick=()=>{
        const built = Array.from(document.getElementById('wordDrop').querySelectorAll('.draggable')).map(x=>x.textContent).join('');
        if(built===targetWord.toUpperCase()){
          speak('Well done'); 
          state.points+=10; 
          state.lettersMastered[letter]=true; 
          saveState(); 
          checkBtn.textContent='Correct! ✅';
          checkBtn.style.background='#10b981';
          setTimeout(()=>{
            checkBtn.textContent='Check';
            checkBtn.style.background='var(--accent)';
          }, 2000);
        }else{ 
          speak('Try again'); 
          checkBtn.textContent='Try Again';
          checkBtn.style.background='#ef4444';
          setTimeout(()=>{
            checkBtn.textContent='Check';
            checkBtn.style.background='var(--accent)';
          }, 1000);
        }
      };
      wrap.appendChild(checkBtn);
      stageContent.appendChild(wrap);

      // DnD behaviours
      const wordDrop = document.getElementById('wordDrop');
      wordDrop.addEventListener('dragover',e=>{
        e.preventDefault();
        wordDrop.style.background='#f0f9ff';
      });
      wordDrop.addEventListener('dragleave',e=>{
        wordDrop.style.background='linear-gradient(180deg,#fff,#fafcff)';
      });
      wordDrop.addEventListener('drop',e=>{ 
        e.preventDefault(); 
        wordDrop.style.background='linear-gradient(180deg,#fff,#fafcff)';
        const ch=e.dataTransfer.getData('text/plain'); 
        const node=document.createElement('div'); 
        node.className='draggable'; 
        node.textContent=ch; 
        node.draggable=true; 
        node.style.margin='4px';
        wordDrop.appendChild(node); 
        node.addEventListener('dragstart',ev=>ev.dataTransfer.setData('text/plain',ev.target.textContent));
        
        // Remove from original pool
        const originalElement = pool.querySelector(`[draggable="true"]:not([style*="margin"])`);
        if(originalElement) originalElement.remove();
      });
    }

    function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];} return a; }

    // Enhanced placeholder for other stages
    function renderPlaceholder(stageId){
      const stage = STAGES[stageId-1];
      currentLabel.textContent = stage?.name || `Stage ${stageId}`;
      labelSub.textContent = stage?.description || 'Coming soon';
      transliterationDiv.textContent = '';
      
      stageContent.innerHTML = `
        <div class="card">
          <h3 style="margin:0 0 12px 0;color:var(--accent);">${stage?.emoji || '🚧'} ${stage?.name || `Stage ${stageId}`}</h3>
          <p style="color:var(--muted);margin:8px 0 16px 0;">
            This stage is currently under development. Complete the previous stages to unlock more content!
          </p>
          <div style="padding:12px;background:#f8f9fa;border-radius:8px;margin:16px 0;">
            <strong>Coming Soon:</strong> This stage will include advanced features like interactive games, 
            audio narration, assessments, and more learning activities.
          </div>
          <button onclick="renderSpecificStage(1)" style="margin-top:12px;">← Back to Alphabet</button>
        </div>
      `;
    }

    // Stage 2 - Phonics
    function renderPhonicsStage(){
      stageContent.innerHTML = `
        <div class="card">
          <h3>Phonics Learning</h3>
          <p>Learn letter sounds and pronunciation patterns.</p>
          <div class="phonics-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px;margin-top:16px;">
            ${LETTERS.map(letter => `
              <div class="phonics-card" style="padding:12px;border:2px solid #e5e7eb;border-radius:8px;text-align:center;cursor:pointer;" onclick="speak('${letter}')">
                <div style="font-size:24px;font-weight:bold;color:#4a90e2;">${letter}</div>
                <div style="font-size:14px;color:#666;margin-top:4px;">${getPhonetic(letter)}</div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    // Stage 3 - Words
    function renderWordsStage(){
      stageContent.innerHTML = `
        <div class="card">
          <h3>Vocabulary Building</h3>
          <p>Learn new words and their meanings.</p>
          <div class="words-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-top:16px;">
            ${Object.entries(WORDS).map(([letter, data]) => `
              <div class="word-card" style="padding:12px;border:2px solid #e5e7eb;border-radius:8px;">
                <div style="font-size:20px;font-weight:bold;color:#4a90e2;">${letter}</div>
                <div style="font-size:18px;margin:8px 0;">${data.word}</div>
                <div style="font-size:14px;color:#666;">${data.example}</div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    // Stage 4 - Sentences
    function renderSentencesStage(){
      const sentences = [
        "The cat is on the mat.",
        "I like to read books.",
        "She plays with her toys.",
        "We eat dinner together.",
        "The sun shines brightly.",
        "Birds fly in the sky.",
        "I love my family.",
        "The dog runs fast.",
        "We learn new things.",
        "The moon is beautiful."
      ];
      
      stageContent.innerHTML = `
        <div class="card">
          <h3>Sentence Building</h3>
          <p>Practice reading and understanding simple sentences.</p>
          <div class="sentences-list" style="margin-top:16px;">
            ${sentences.map((sentence, index) => `
              <div class="sentence-item" style="padding:12px;margin:8px 0;border:2px solid #e5e7eb;border-radius:8px;cursor:pointer;" onclick="speak('${sentence}')">
                <div style="font-size:16px;margin-bottom:4px;">${sentence}</div>
                <button style="padding:4px 8px;background:#4a90e2;color:white;border:none;border-radius:4px;cursor:pointer;">🔊 Listen</button>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    // Stage 5 - Short Stories
    function renderStoriesStage(){
      const stories = [
        {
          title: "The Little Cat",
          content: "Once upon a time, there was a little cat named Whiskers. Whiskers was very happy and playful. She liked to play with a red ball in the garden. Every morning, Whiskers would run fast and jump high to catch the ball. She was a very good cat and everyone loved her.",
          level: "Beginner",
          emoji: "🐱"
        },
        {
          title: "The Magic Garden",
          content: "In a beautiful garden, there lived many colorful flowers. The sun shone brightly every day, and the flowers danced in the gentle breeze. A little girl named Emma visited the garden every afternoon. She would water the flowers and sing sweet songs to them. The flowers seemed to smile back at her.",
          level: "Intermediate",
          emoji: "🌸"
        },
        {
          title: "The Brave Little Mouse",
          content: "There was a small mouse named Max who lived in a cozy little house. One day, Max heard a loud noise coming from the kitchen. He was scared, but he decided to be brave and investigate. When he went to the kitchen, he found that a big pot had fallen down. Max pushed it back to its place and saved the day!",
          level: "Advanced",
          emoji: "🐭"
        },
        {
          title: "The Rainbow Bridge",
          content: "After the rain, a beautiful rainbow appeared in the sky. A little boy named Tom looked up and saw seven colors: red, orange, yellow, green, blue, indigo, and violet. He imagined walking on the rainbow bridge to reach the clouds. Tom waved at the rainbow and made a wish for happiness.",
          level: "Beginner",
          emoji: "🌈"
        },
        {
          title: "The Lost Puppy",
          content: "Sarah found a small puppy crying near her house. The puppy looked sad and hungry. Sarah gave it some milk and a warm blanket. She asked her parents if she could keep the puppy. They said yes! Sarah named the puppy Buddy, and they became best friends forever.",
          level: "Beginner",
          emoji: "🐶"
        },
        {
          title: "The Flying Kite",
          content: "On a windy day, Jake went to the park with his new kite. The kite was red and blue with a long tail. Jake ran fast to make the kite fly high in the sky. The kite danced with the wind and looked like a bird flying. Jake was very happy and proud of his flying kite.",
          level: "Beginner",
          emoji: "🪁"
        },
        {
          title: "The Birthday Party",
          content: "It was Lisa's birthday, and she invited all her friends to a party. There was a big cake with pink frosting and seven candles. Lisa's friends brought presents wrapped in colorful paper. They played games, sang happy birthday, and ate delicious cake. It was the best birthday ever!",
          level: "Intermediate",
          emoji: "🎂"
        },
        {
          title: "The Magic Book",
          content: "In the library, Alex found an old book with golden letters on the cover. When he opened the book, the pages started glowing with bright light. Suddenly, characters from the story came to life! A brave knight, a wise wizard, and a friendly dragon appeared. Alex had the most amazing adventure in the magic book.",
          level: "Intermediate",
          emoji: "📚"
        },
        {
          title: "The Space Adventure",
          content: "Emma dreamed of visiting the moon. One night, a spaceship landed in her backyard. A friendly alien invited her to explore space. They flew past stars, planets, and comets. Emma saw Earth from far away - it looked like a blue marble. When she woke up, she knew her dream had been real.",
          level: "Advanced",
          emoji: "🚀"
        },
        {
          title: "The Helpful Robot",
          content: "In the future, there was a robot named Robo who helped people every day. Robo could clean houses, cook meals, and even tell jokes. One day, Robo's battery was running low, and he needed help. A kind girl named Maya charged his battery and taught him about friendship. Robo learned that helping others makes everyone happy.",
          level: "Advanced",
          emoji: "🤖"
        },
        {
          title: "The Ocean Explorer",
          content: "Marina loved the ocean and wanted to see what was under the water. She put on her diving suit and went deep into the sea. She saw colorful fish, dancing seaweed, and a friendly dolphin. The dolphin showed her a hidden treasure chest. Marina learned that the ocean is full of wonderful surprises.",
          level: "Intermediate",
          emoji: "🐠"
        },
        {
          title: "The Kind Elephant",
          content: "Ellie the elephant was the biggest animal in the forest, but she was also the kindest. When a small bird fell from its nest, Ellie used her trunk to lift it back up. When the river was too deep for other animals to cross, Ellie let them walk across her back. Everyone loved Ellie because she always helped others.",
          level: "Beginner",
          emoji: "🐘"
        }
      ];
      
      stageContent.innerHTML = `
        <div class="card">
          <h3>📚 Short Stories Collection - مجموعة القصص القصيرة</h3>
          <p>Read and listen to engaging stories with different difficulty levels. - اقرأ واستمع إلى قصص ممتعة بمستويات صعوبة مختلفة.</p>
          
          <!-- Story Filter -->
          <div class="story-filter" style="margin:16px 0;padding:12px;background:#f8f9fa;border-radius:8px;">
            <h4 style="margin:0 0 8px 0;color:#4a90e2;">Filter by Level - تصفية حسب المستوى:</h4>
            <div style="display:flex;gap:8px;flex-wrap:wrap;">
              <button onclick="filterStories('all')" id="filter-all" class="active" style="padding:6px 12px;background:#4a90e2;color:white;border:none;border-radius:16px;cursor:pointer;font-size:12px;">All - الكل</button>
              <button onclick="filterStories('Beginner')" id="filter-beginner" style="padding:6px 12px;background:#e5e7eb;color:#666;border:none;border-radius:16px;cursor:pointer;font-size:12px;">Beginner - مبتدئ</button>
              <button onclick="filterStories('Advanced')" id="filter-advanced" style="padding:6px 12px;background:#e5e7eb;color:#666;border:none;border-radius:16px;cursor:pointer;font-size:12px;">Advanced - متقدم</button>
            </div>
          </div>
          
          <div class="stories-container" id="stories-container" style="margin-top:16px;">
            ${stories.map((story, index) => `
              <div class="story-card" data-level="${story.level}" style="padding:20px;margin:16px 0;border:2px solid #e5e7eb;border-radius:12px;background:white;box-shadow:0 2px 8px rgba(0,0,0,0.1);transition:transform 0.2s;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                  <div style="display:flex;align-items:center;gap:8px;">
                    <span style="font-size:24px;">${story.emoji}</span>
                    <h4 style="margin:0;color:#4a90e2;font-size:18px;">${story.title}</h4>
                </div>
                  <span class="level-badge" style="background:#e3f2fd;color:#1976d2;padding:6px 12px;border-radius:16px;font-size:12px;font-weight:bold;">${story.level}</span>
                </div>
                <p style="line-height:1.7;margin-bottom:16px;color:#555;font-size:15px;">${story.content}</p>
                <div style="display:flex;gap:10px;flex-wrap:wrap;">
                  <button onclick="speak('${story.content.replace(/'/g, "\\'")}')" style="padding:10px 16px;background:#4a90e2;color:white;border:none;border-radius:8px;cursor:pointer;font-size:14px;display:flex;align-items:center;gap:6px;">
                    🔊 Listen - استمع
                  </button>
                  <button onclick="startStoryQuiz('${story.title}', '${story.content.replace(/'/g, "\\'")}')" style="padding:10px 16px;background:#10b981;color:white;border:none;border-radius:8px;cursor:pointer;font-size:14px;display:flex;align-items:center;gap:6px;">
                    ❓ Quiz - اختبار
                  </button>
                </div>
              </div>
            `).join('')}
          </div>
          
          <!-- Story Statistics -->
          <div class="story-stats" style="margin-top:20px;padding:16px;background:#f0f8ff;border-radius:8px;border-left:4px solid #4a90e2;">
            <h4 style="margin:0 0 8px 0;color:#4a90e2;">📊 Story Statistics - إحصائيات القصص</h4>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px;margin-top:8px;">
              <div class="stat-item" style="text-align:center;padding:8px;background:white;border-radius:6px;">
                <div class="stat-number" style="font-size:24px;font-weight:bold;color:#4a90e2;">${stories.length}</div>
                <div class="stat-label" style="font-size:12px;color:#666;">Total Stories</div>
              </div>
              <div class="stat-item" style="text-align:center;padding:8px;background:white;border-radius:6px;">
                <div class="stat-number" style="font-size:24px;font-weight:bold;color:#10b981;">${stories.filter(s => s.level === 'Beginner').length}</div>
                <div class="stat-label" style="font-size:12px;color:#666;">Beginner</div>
              </div>
              <div class="stat-item" style="text-align:center;padding:8px;background:white;border-radius:6px;">
                <div class="stat-number" style="font-size:24px;font-weight:bold;color:#f59e0b;">${stories.filter(s => s.level === 'Intermediate').length}</div>
                <div class="stat-label" style="font-size:12px;color:#666;">Intermediate</div>
              </div>
              <div class="stat-item" style="text-align:center;padding:8px;background:white;border-radius:6px;">
                <div class="stat-number" style="font-size:24px;font-weight:bold;color:#ef4444;">${stories.filter(s => s.level === 'Advanced').length}</div>
                <div class="stat-label" style="font-size:12px;color:#666;">Advanced</div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Story filtering function
    function filterStories(level) {
      const stories = document.querySelectorAll('.story-card');
      const filterButtons = document.querySelectorAll('[id^="filter-"]');
      
      // Update button styles
      filterButtons.forEach(btn => {
        btn.style.background = '#e5e7eb';
        btn.style.color = '#666';
        btn.classList.remove('active');
      });
      
      const activeButton = document.getElementById(`filter-${level.toLowerCase()}`);
      if (activeButton) {
        activeButton.style.background = '#4a90e2';
        activeButton.style.color = 'white';
        activeButton.classList.add('active');
      }
      
      // Filter stories
      stories.forEach(story => {
        if (level === 'all' || story.dataset.level === level) {
          story.style.display = 'block';
          story.style.animation = 'fadeIn 0.3s ease-in';
        } else {
          story.style.display = 'none';
        }
      });
      
      showNotification(`📚 Showing ${level} stories - عرض قصص ${level}`, 'info');
    }

    // Story quiz function
    function startStoryQuiz(title, content) {
      const questions = generateStoryQuestions(title, content);
      let currentQuestion = 0;
      let score = 0;
      
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      `;
      
      function showQuestion() {
        if (currentQuestion >= questions.length) {
          showResults();
          return;
        }
        
        const q = questions[currentQuestion];
        modal.innerHTML = `
          <div style="background: var(--card-bg, white); padding: 30px; border-radius: 15px; max-width: 600px; width: 90%; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <h3 style="color: var(--primary-color, #4a90e2); margin-bottom: 20px;">📚 Story Quiz: ${title}</h3>
            <div style="background: var(--secondary-bg, #f8f9fa); padding: 20px; border-radius: 10px; margin: 20px 0;">
              <h4 style="color: var(--text-primary, #1976d2); margin-bottom: 15px;">Question ${currentQuestion + 1} of ${questions.length}</h4>
              <p style="font-size: 18px; margin-bottom: 20px; color: var(--text-primary, #333); font-weight: 600; background: var(--card-bg, white); padding: 15px; border-radius: 8px; border-left: 4px solid var(--primary-color, #4a90e2);">${q.question}</p>
              <div style="display: grid; gap: 10px; margin-top: 20px;">
                ${q.options.map((option, index) => `
                  <button class="quiz-button" onclick="selectAnswer(${index})" style="padding: 12px; background: var(--card-bg, white); color: var(--text-primary, #333); border: 2px solid var(--border, #e5e7eb); border-radius: 8px; cursor: pointer; font-size: 16px; text-align: left; transition: all 0.3s ease; font-weight: 500; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    ${String.fromCharCode(65 + index)}. ${option}
                  </button>
                `).join('')}
              </div>
            </div>
            <div style="margin-top: 20px;">
              <button onclick="closeQuiz()" style="background: var(--button-secondary, #666); color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; margin-right: 10px;">Close</button>
              <span style="color: var(--text-secondary, #666);">Score: ${score}/${currentQuestion}</span>
            </div>
          </div>
        `;
      }
      
      function selectAnswer(selectedIndex) {
        const q = questions[currentQuestion];
        if (selectedIndex === q.correct) {
          score++;
          showNotification('✅ Correct! - صحيح!', 'success');
        } else {
          showNotification(`❌ Wrong! The correct answer is: ${q.options[q.correct]} - خطأ! الإجابة الصحيحة هي: ${q.options[q.correct]}`, 'error');
        }
        
        currentQuestion++;
        setTimeout(showQuestion, 1500);
      }
      
      function showResults() {
        const percentage = Math.round((score / questions.length) * 100);
        modal.innerHTML = `
          <div style="background: var(--card-bg, white); padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <h3 style="color: var(--primary-color, #4a90e2); margin-bottom: 20px;">🎉 Quiz Complete!</h3>
            <div style="font-size: 48px; margin: 20px 0;">${percentage >= 70 ? '🏆' : percentage >= 50 ? '👍' : '📚'}</div>
            <h4 style="color: var(--text-primary, #1976d2); margin-bottom: 15px;">Your Score: ${score}/${questions.length} (${percentage}%)</h4>
            <p style="color: var(--text-secondary, #666); margin-bottom: 20px;">
              ${percentage >= 70 ? 'Excellent work! - عمل ممتاز!' : 
                percentage >= 50 ? 'Good job! - عمل جيد!' : 
                'Keep practicing! - استمر في الممارسة!'}
            </p>
            <button onclick="closeQuiz()" style="background: var(--primary-color, #4a90e2); color: white; border: none; padding: 12px 24px; border-radius: 25px; cursor: pointer; font-size: 16px;">Close - إغلاق</button>
          </div>
        `;
      }
      
      window.selectAnswer = selectAnswer;
      window.closeQuiz = () => {
        document.body.removeChild(modal);
        delete window.selectAnswer;
        delete window.closeQuiz;
      };
      
      document.body.appendChild(modal);
      showQuestion();
    }

    // Generate questions for stories
    function generateStoryQuestions(title, content) {
      const words = content.toLowerCase().split(/\s+/);
      const questions = [];
      
      // Question 1: Main character
      if (content.includes('named')) {
        const nameMatch = content.match(/named (\w+)/i);
        if (nameMatch) {
          questions.push({
            question: `What is the main character's name in "${title}"?`,
            options: [nameMatch[1], 'Sarah', 'Tom', 'Emma'],
            correct: 0
          });
        }
      }
      
      // Question 2: Setting
      if (content.includes('garden') || content.includes('house') || content.includes('park')) {
        const settings = ['garden', 'house', 'park', 'forest', 'ocean', 'space'];
        const foundSetting = settings.find(s => content.toLowerCase().includes(s));
        if (foundSetting) {
          questions.push({
            question: `Where does the story "${title}" take place?`,
            options: [foundSetting, 'school', 'library', 'store'],
            correct: 0
          });
        }
      }
      
      // Question 3: Action
      if (content.includes('play') || content.includes('run') || content.includes('fly')) {
        const actions = ['play', 'run', 'fly', 'jump', 'dance', 'sing'];
        const foundAction = actions.find(a => content.toLowerCase().includes(a));
        if (foundAction) {
          questions.push({
            question: `What does the main character do in "${title}"?`,
            options: [foundAction, 'sleep', 'eat', 'read'],
            correct: 0
          });
        }
      }
      
      // Question 4: Color or object
      if (content.includes('red') || content.includes('blue') || content.includes('ball') || content.includes('kite')) {
        const objects = ['red', 'blue', 'ball', 'kite', 'cake', 'book'];
        const foundObject = objects.find(o => content.toLowerCase().includes(o));
        if (foundObject) {
          questions.push({
            question: `What color or object is mentioned in "${title}"?`,
            options: [foundObject, 'green', 'yellow', 'toy'],
            correct: 0
          });
        }
      }
      
      // Question 5: Feeling
      if (content.includes('happy') || content.includes('sad') || content.includes('scared')) {
        const feelings = ['happy', 'sad', 'scared', 'excited', 'proud'];
        const foundFeeling = feelings.find(f => content.toLowerCase().includes(f));
        if (foundFeeling) {
          questions.push({
            question: `How does the main character feel in "${title}"?`,
            options: [foundFeeling, 'angry', 'tired', 'confused'],
            correct: 0
          });
        }
      }
      
      return questions.length > 0 ? questions : [{
        question: `What is the main theme of "${title}"?`,
        options: ['Adventure', 'Friendship', 'Learning', 'Family'],
        correct: 0
      }];
    }

    // Story details function
    function showStoryDetails(title, content, level) {
      const wordCount = content.split(/\s+/).length;
      const sentenceCount = content.split(/[.!?]+/).filter(s => s.trim().length > 0).length;
      const avgWordsPerSentence = Math.round(wordCount / sentenceCount);
      
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      `;
      
      modal.innerHTML = `
        <div style="background: var(--card-bg, white); padding: 30px; border-radius: 15px; max-width: 600px; width: 90%; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
          <h3 style="color: var(--primary-color, #4a90e2); margin-bottom: 20px;">📖 Story Details - تفاصيل القصة</h3>
          <div style="background: var(--secondary-bg, #f8f9fa); padding: 20px; border-radius: 10px; margin: 20px 0; text-align: left;">
            <h4 style="color: var(--text-primary, #1976d2); margin-bottom: 15px;">${title}</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 15px 0;">
              <div style="text-align: center; padding: 10px; background: var(--card-bg, white); border-radius: 8px;">
                <div style="font-size: 24px; font-weight: bold; color: var(--primary-color, #4a90e2);">${level}</div>
                <div style="font-size: 12px; color: var(--text-secondary, #666);">Difficulty Level</div>
              </div>
              <div style="text-align: center; padding: 10px; background: var(--card-bg, white); border-radius: 8px;">
                <div style="font-size: 24px; font-weight: bold; color: #10b981;">${wordCount}</div>
                <div style="font-size: 12px; color: var(--text-secondary, #666);">Words</div>
              </div>
              <div style="text-align: center; padding: 10px; background: var(--card-bg, white); border-radius: 8px;">
                <div style="font-size: 24px; font-weight: bold; color: #f59e0b;">${sentenceCount}</div>
                <div style="font-size: 12px; color: var(--text-secondary, #666);">Sentences</div>
              </div>
              <div style="text-align: center; padding: 10px; background: var(--card-bg, white); border-radius: 8px;">
                <div style="font-size: 24px; font-weight: bold; color: #ef4444;">${avgWordsPerSentence}</div>
                <div style="font-size: 12px; color: var(--text-secondary, #666);">Avg Words/Sentence</div>
              </div>
            </div>
            <div style="margin-top: 15px; padding: 15px; background: var(--success-bg, #e8f5e8); border-radius: 8px;">
              <h5 style="color: var(--text-primary, #1976d2); margin-bottom: 10px;">Reading Time Estimate - تقدير وقت القراءة:</h5>
              <p style="margin: 0; color: var(--text-secondary, #666);">Approximately ${Math.ceil(wordCount / 200)} minutes for average readers - حوالي ${Math.ceil(wordCount / 200)} دقيقة للقراء العاديين</p>
            </div>
          </div>
          <button onclick="closeDetails()" style="background: var(--primary-color, #4a90e2); color: white; border: none; padding: 12px 24px; border-radius: 25px; cursor: pointer; font-size: 16px;">Close - إغلاق</button>
        </div>
      `;
      
      window.closeDetails = () => {
        document.body.removeChild(modal);
        delete window.closeDetails;
      };
      
      document.body.appendChild(modal);
    }

    // Stage 6 - Listening & Speaking
    function renderListeningStage(){
      const exercises = [
        {
          title: "Basic Greetings",
          phrases: [
            "Hello, how are you today?",
            "Good morning, nice to meet you!",
            "I am fine, thank you very much!",
            "What is your name?",
            "My name is Sarah, and you?"
          ]
        },
        {
          title: "Daily Conversations",
          phrases: [
            "What time is it?",
            "It's three o'clock in the afternoon.",
            "Where do you live?",
            "I live in a beautiful house.",
            "What do you like to do for fun?"
          ]
        },
        {
          title: "Shopping & Food",
          phrases: [
            "How much does this cost?",
            "I would like to buy some apples.",
            "Do you have any milk?",
            "Yes, we have fresh milk today.",
            "Thank you, have a great day!"
          ]
        },
        {
          title: "Family & Friends",
          phrases: [
            "This is my family photo.",
            "I have two brothers and one sister.",
            "My father is a teacher.",
            "My mother works in a hospital.",
            "We love to spend time together."
          ]
        }
      ];
      
      stageContent.innerHTML = `
        <div class="card">
          <h3>Listening & Speaking Practice</h3>
          <p>Improve your listening and speaking skills with interactive exercises.</p>
          <div class="listening-exercises" style="margin-top:16px;">
            ${exercises.map((exercise, index) => `
              <div class="exercise-section" style="padding:16px;margin:12px 0;border:2px solid #e5e7eb;border-radius:8px;">
                <h4 style="color:#4a90e2;margin-bottom:12px;">${exercise.title}</h4>
                <p style="margin-bottom:12px;color:#666;">Click each phrase to listen, then repeat it out loud:</p>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:8px;">
                  ${exercise.phrases.map(phrase => `
                    <div style="display:flex;align-items:center;gap:8px;padding:8px;background:#f8f9fa;border-radius:6px;">
                      <button onclick="speak('${phrase}')" style="padding:6px 12px;background:#4a90e2;color:white;border:none;border-radius:4px;cursor:pointer;flex-shrink:0;">🔊</button>
                      <span style="font-size:14px;">${phrase}</span>
                    </div>
                  `).join('')}
                </div>
              </div>
            `).join('')}
            <div class="speaking-tips" style="padding:16px;margin:12px 0;border:2px solid #10b981;border-radius:8px;background:#f0fdf4;">
              <h4 style="color:#10b981;margin-bottom:8px;">💡 Speaking Tips</h4>
              <ul style="margin:0;padding-left:20px;color:#666;">
                <li>Speak slowly and clearly</li>
                <li>Pay attention to pronunciation</li>
                <li>Practice with a friend or family member</li>
                <li>Record yourself speaking and listen back</li>
              </ul>
            </div>
          </div>
        </div>
      `;
    }

    // Stage 7 - Basic Grammar
    function renderGrammarStage(){
      const lessons = [
        {
          title: "Articles (a, an, the)",
          rules: [
            {rule: "a", example: "a cat, a dog, a book", explanation: "used before consonant sounds"},
            {rule: "an", example: "an apple, an egg, an umbrella", explanation: "used before vowel sounds"},
            {rule: "the", example: "the book, the car, the sun", explanation: "used for specific things"}
          ],
          practice: [
            "I have ___ cat and ___ dog.",
            "She is ___ honest person.",
            "___ sun shines brightly today."
          ],
          answers: [
            "I have a cat and a dog.",
            "She is an honest person.",
            "The sun shines brightly today."
          ]
        },
        {
          title: "Simple Present Tense",
          rules: [
            {rule: "I/You/We/They + verb", example: "I play, You work, We study", explanation: "base form of verb"},
            {rule: "He/She/It + verb + s", example: "He plays, She works, It studies", explanation: "add 's' to the verb"},
            {rule: "Negative: don't/doesn't", example: "I don't play, She doesn't work", explanation: "use don't/doesn't + base verb"}
          ],
          practice: [
            "I ___ (play) football every day.",
            "She ___ (read) books in the library.",
            "They ___ (not like) vegetables."
          ],
          answers: [
            "I play football every day.",
            "She reads books in the library.",
            "They don't like vegetables."
          ]
        },
        {
          title: "Plural Nouns",
          rules: [
            {rule: "Add -s", example: "cat → cats, book → books", explanation: "most nouns"},
            {rule: "Add -es", example: "box → boxes, bus → buses", explanation: "nouns ending in s, sh, ch, x, z"},
            {rule: "Change y to ies", example: "baby → babies, city → cities", explanation: "nouns ending in consonant + y"}
          ],
          practice: [
            "One cat, two ___",
            "One box, three ___",
            "One baby, many ___"
          ],
          answers: [
            "One cat, two cats",
            "One box, three boxes",
            "One baby, many babies"
          ]
        },
        {
          title: "Possessive Adjectives",
          rules: [
            {rule: "my", example: "my book, my car", explanation: "belonging to me"},
            {rule: "your", example: "your house, your dog", explanation: "belonging to you"},
            {rule: "his/her/its", example: "his pen, her bag, its tail", explanation: "belonging to him/her/it"},
            {rule: "our/their", example: "our school, their friends", explanation: "belonging to us/them"}
          ],
          practice: [
            "This is ___ (my) book.",
            "That is ___ (her) bicycle.",
            "These are ___ (our) toys."
          ],
          answers: [
            "This is my book.",
            "That is her bicycle.",
            "These are our toys."
          ]
        }
      ];
      
      stageContent.innerHTML = `
        <div class="card">
          <h3>Basic Grammar Lessons</h3>
          <p>Learn fundamental grammar rules with examples and practice exercises.</p>
          <div class="grammar-lessons" style="margin-top:16px;">
            ${lessons.map((lesson, index) => `
              <div class="lesson-card" style="padding:16px;margin:12px 0;border:2px solid #e5e7eb;border-radius:8px;">
                <h4 style="color:#4a90e2;margin-bottom:12px;">Lesson ${index + 1}: ${lesson.title}</h4>
                <div style="margin-bottom:12px;">
                  ${lesson.rules.map(rule => `
                    <div style="padding:8px;margin:4px 0;background:#f8f9fa;border-radius:4px;">
                      <strong style="color:#1976d2;">${rule.rule}</strong> - ${rule.example}
                      <br><small style="color:#666;">${rule.explanation}</small>
                    </div>
                  `).join('')}
                </div>
                <div class="practice-exercise" style="background:#e3f2fd;padding:12px;border-radius:6px;margin-top:12px;">
                  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                    <strong style="color:#1976d2;">Practice Exercise:</strong>
                    <button onclick="toggleAnswers(${index})" id="answerBtn${index}" style="background:#4a90e2;color:white;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:12px;">
                      Show Answers - إظهار الحلول
                    </button>
                  </div>
                  <div style="margin-top:8px;">
                    ${lesson.practice.map(exercise => `
                      <div style="margin:4px 0;font-family:monospace;">${exercise}</div>
                    `).join('')}
                  </div>
                  <div id="answers${index}" class="answers-section" style="display:none;margin-top:12px;padding:8px;background:#e8f5e8;border-radius:4px;border-left:3px solid #10b981;">
                    <strong style="color:#2e7d32;font-size:14px;">Answers - الحلول:</strong>
                    <div style="margin-top:6px;">
                      ${lesson.answers.map(answer => `
                        <div style="margin:3px 0;font-family:monospace;color:#2e7d32;">${answer}</div>
                      `).join('')}
                    </div>
                  </div>
                </div>
              </div>
            `).join('')}
            <div class="grammar-tips" style="padding:16px;margin:12px 0;border:2px solid #ff9800;border-radius:8px;background:#fff3e0;">
              <h4 style="color:#ff9800;margin-bottom:8px;">📚 Grammar Tips</h4>
              <ul style="margin:0;padding-left:20px;color:#666;">
                <li>Practice with real sentences</li>
                <li>Read books to see grammar in context</li>
                <li>Write your own examples</li>
                <li>Don't worry about making mistakes - learn from them!</li>
              </ul>
            </div>
          </div>
        </div>
      `;
    }

    // Function to toggle answers visibility
    function toggleAnswers(lessonIndex) {
      const answersDiv = document.getElementById(`answers${lessonIndex}`);
      const button = document.getElementById(`answerBtn${lessonIndex}`);
      
      if (answersDiv.style.display === 'none') {
        answersDiv.style.display = 'block';
        button.textContent = 'Hide Answers - إخفاء الحلول';
        button.style.background = '#f59e0b';
      } else {
        answersDiv.style.display = 'none';
        button.textContent = 'Show Answers - إظهار الحلول';
        button.style.background = '#4a90e2';
      }
    }

    // Make toggleAnswers globally available
    window.toggleAnswers = toggleAnswers;

    // Stage 8 - Reading Comprehension
    function renderReadingStage(){
      const passages = [
        {
          title: "My Pet Dog",
          content: "I have a pet dog named Max. Max is brown and white. He likes to play with a ball in our backyard. Max is very friendly and loves children. He wags his tail when he sees me coming home from school. Every morning, I take Max for a walk in the park. I love my dog very much because he is always happy to see me.",
          questions: [
            {q: "What is the dog's name?", a: "Max"},
            {q: "What color is Max?", a: "Brown and white"},
            {q: "What does Max like to play with?", a: "A ball"},
            {q: "Where does the boy take Max for a walk?", a: "In the park"},
            {q: "When does Max wag his tail?", a: "When he sees the boy coming home"}
          ],
          level: "Beginner"
        },
        {
          title: "The Magic Garden",
          content: "In a small village, there was a beautiful garden that belonged to an old woman named Mrs. Green. The garden was famous for its magical flowers that changed colors every season. In spring, the flowers were pink and yellow. In summer, they turned bright red and orange. In autumn, they became golden and brown. In winter, they sparkled like diamonds in the snow. People from all over the village came to see this amazing garden.",
          questions: [
            {q: "Who owned the magic garden?", a: "Mrs. Green"},
            {q: "What was special about the flowers?", a: "They changed colors every season"},
            {q: "What colors were the flowers in spring?", a: "Pink and yellow"},
            {q: "What did the flowers look like in winter?", a: "They sparkled like diamonds"},
            {q: "Why did people visit the garden?", a: "To see the amazing flowers"}
          ],
          level: "Intermediate"
        },
        {
          title: "The Brave Little Mouse",
          content: "There was a small mouse named Max who lived in a cozy little house behind the kitchen wall. One day, Max heard a loud crash coming from the kitchen. He was scared, but he knew he had to be brave and investigate. When he peeked through a small hole in the wall, he saw that a big pot had fallen from the shelf and was blocking the door. Max thought quickly and decided to push the pot away. It was heavy, but he kept trying until he moved it. The family was so grateful that they left cheese for Max every day.",
          questions: [
            {q: "Where did Max live?", a: "Behind the kitchen wall"},
            {q: "What sound did Max hear?", a: "A loud crash"},
            {q: "What had fallen in the kitchen?", a: "A big pot"},
            {q: "What was the pot blocking?", a: "The door"},
            {q: "What did the family do to thank Max?", a: "They left cheese for him every day"}
          ],
          level: "Advanced"
        }
      ];
      
      stageContent.innerHTML = `
        <div class="card">
          <h3>Reading Comprehension</h3>
          <p>Practice reading and understanding texts with comprehension questions.</p>
          <div class="reading-passages" style="margin-top:16px;">
            ${passages.map((passage, index) => `
              <div class="passage-card" style="padding:16px;margin:12px 0;border:2px solid #e5e7eb;border-radius:8px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                  <h4 style="margin:0;color:#4a90e2;">${passage.title}</h4>
                  <span style="background:#e3f2fd;color:#1976d2;padding:4px 8px;border-radius:12px;font-size:12px;">${passage.level}</span>
                </div>
                <div style="background:#f8f9fa;padding:12px;border-radius:6px;margin-bottom:12px;line-height:1.6;">
                  ${passage.content}
                </div>
                <button onclick="speak('${passage.content}')" style="padding:8px 16px;background:#4a90e2;color:white;border:none;border-radius:6px;cursor:pointer;margin-bottom:12px;">🔊 Listen to Story</button>
                <div class="questions-section" style="background:#e8f5e8;padding:12px;border-radius:6px;">
                  <h5 style="color:#2e7d32;margin-bottom:8px;">Comprehension Questions:</h5>
                  ${passage.questions.map((q, qIndex) => `
                    <div style="margin:8px 0;padding:8px;background:white;border-radius:4px;">
                      <strong>${qIndex + 1}. ${q.q}</strong>
                      <div class="answer" style="margin-top:4px;color:#666;">Answer: ${q.a}</div>
                    </div>
                  `).join('')}
                </div>
              </div>
            `).join('')}
            <div class="reading-tips" style="padding:16px;margin:12px 0;border:2px solid #9c27b0;border-radius:8px;background:#f3e5f5;">
              <h4 style="color:#9c27b0;margin-bottom:8px;">📖 Reading Tips</h4>
              <ul style="margin:0;padding-left:20px;color:#666;">
                <li>Read the passage slowly and carefully</li>
                <li>Look for key words in the questions</li>
                <li>Answer in your own words first, then check</li>
                <li>Practice reading different types of texts</li>
              </ul>
            </div>
          </div>
        </div>
      `;
    }

    // Stage 9 - Writing & Spelling
    function renderWritingStage(){
      const exercises = [
        {
          title: "Letter Formation",
          description: "Practice writing uppercase and lowercase letters",
          letters: ["A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M", "N", "O", "P", "Q", "R", "S", "T", "U", "V", "W", "X", "Y", "Z"]
        },
        {
          title: "Basic Words",
          description: "Listen and spell common words",
          words: [
            {word: "cat", hint: "A small furry animal"},
            {word: "dog", hint: "A loyal pet"},
            {word: "book", hint: "You read this"},
            {word: "house", hint: "Where you live"},
            {word: "tree", hint: "Tall plant with leaves"},
            {word: "water", hint: "Clear liquid we drink"},
            {word: "happy", hint: "Feeling good"},
            {word: "friend", hint: "Someone you like"}
          ]
        },
        {
          title: "Sentence Writing",
          description: "Complete the sentences with the correct words",
          sentences: [
            "I have a ___ (cat/dog) at home.",
            "The ___ (book/tree) is very tall.",
            "My ___ (friend/family) is coming to visit.",
            "I like to ___ (read/play) books.",
            "The ___ (water/sun) is shining brightly."
          ]
        }
      ];
      
      stageContent.innerHTML = `
        <div class="card">
          <h3>Writing & Spelling Practice</h3>
          <p>Improve your writing skills and spelling with interactive exercises.</p>
          <div class="writing-exercises" style="margin-top:16px;">
            ${exercises.map((exercise, index) => `
              <div class="exercise-section" style="padding:16px;margin:12px 0;border:2px solid #e5e7eb;border-radius:8px;">
                <h4 style="color:#4a90e2;margin-bottom:8px;">${exercise.title}</h4>
                <p style="color:#666;margin-bottom:12px;">${exercise.description}</p>
                ${exercise.letters ? `
                  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(40px,1fr));gap:8px;margin-bottom:12px;">
                    ${exercise.letters.map(letter => `
                      <div style="padding:8px;text-align:center;background:#f8f9fa;border:2px solid #e5e7eb;border-radius:6px;cursor:pointer;" onclick="speak('${letter}')">
                        <div style="font-size:18px;font-weight:bold;">${letter}</div>
                        <div style="font-size:12px;color:#666;">${letter.toLowerCase()}</div>
                      </div>
                    `).join('')}
                  </div>
                ` : ''}
                ${exercise.words ? `
                  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:8px;">
                    ${exercise.words.map(wordObj => `
                      <div style="padding:12px;background:#f8f9fa;border-radius:6px;">
                        <div style="margin-bottom:8px;">
                          <button onclick="speak('${wordObj.word}')" style="padding:6px 12px;background:#4a90e2;color:white;border:none;border-radius:4px;cursor:pointer;margin-right:8px;">🔊</button>
                          <strong>${wordObj.word}</strong>
                        </div>
                        <div style="font-size:12px;color:#666;">${wordObj.hint}</div>
                        <div style="margin-top:8px;font-family:monospace;background:white;padding:4px;border-radius:4px;border:1px solid #ddd;">
                          _ _ _ _ _
                        </div>
                      </div>
                    `).join('')}
                  </div>
                ` : ''}
                ${exercise.sentences ? `
                  <div style="margin-top:12px;">
                    ${exercise.sentences.map(sentence => `
                      <div style="margin:8px 0;padding:8px;background:#f8f9fa;border-radius:4px;font-family:monospace;">
                        ${sentence}
                      </div>
                    `).join('')}
                  </div>
                ` : ''}
              </div>
            `).join('')}
            <div style="padding:16px;margin:12px 0;border:2px solid #ff5722;border-radius:8px;background:#fff3e0;">
              <h4 style="color:#ff5722;margin-bottom:8px;">✏️ Writing Tips</h4>
              <ul style="margin:0;padding-left:20px;color:#666;">
                <li>Practice writing letters in the air first</li>
                <li>Use lined paper for better letter formation</li>
                <li>Start with uppercase letters, then lowercase</li>
                <li>Take your time and write slowly</li>
                <li>Practice spelling words out loud</li>
              </ul>
            </div>
          </div>
        </div>
      `;
    }

    // Stage 10 - Practical Conversation
    function renderConversationStage(){
      const conversations = [
        {
          title: "Greetings & Introductions",
          phrases: [
            {english: "Hello! How are you?", arabic: "مرحبا! كيف حالك؟", context: "Meeting someone new"},
            {english: "Good morning! Nice to meet you!", arabic: "صباح الخير! تشرفنا!", context: "First meeting"},
            {english: "What's your name?", arabic: "ما اسمك؟", context: "Getting to know someone"},
            {english: "My name is Sarah. And you?", arabic: "اسمي سارة. وأنت؟", context: "Introducing yourself"},
            {english: "Where are you from?", arabic: "من أين أنت؟", context: "Asking about origin"},
            {english: "I'm from Algeria. How about you?", arabic: "أنا من الجزائر. وأنت؟", context: "Sharing your origin"}
          ]
        },
        {
          title: "Daily Activities",
          phrases: [
            {english: "What do you do for work?", arabic: "ماذا تعمل؟", context: "Asking about job"},
            {english: "I'm a teacher. What about you?", arabic: "أنا معلمة. وأنت؟", context: "Sharing your job"},
            {english: "What time do you wake up?", arabic: "في أي ساعة تستيقظ؟", context: "Daily routine"},
            {english: "I wake up at 7 AM every day.", arabic: "أستيقظ في السابعة صباحاً كل يوم", context: "Describing routine"},
            {english: "What do you like to do for fun?", arabic: "ماذا تحب أن تفعل للترفيه؟", context: "Asking about hobbies"},
            {english: "I like reading books and watching movies.", arabic: "أحب قراءة الكتب ومشاهدة الأفلام", context: "Sharing hobbies"}
          ]
        },
        {
          title: "Shopping & Food",
          phrases: [
            {english: "How much does this cost?", arabic: "كم ثمن هذا؟", context: "Shopping"},
            {english: "It costs 50 dollars.", arabic: "ثمنه 50 دولار", context: "Giving price"},
            {english: "Do you have any milk?", arabic: "هل لديكم حليب؟", context: "Grocery shopping"},
            {english: "Yes, we have fresh milk today.", arabic: "نعم، لدينا حليب طازج اليوم", context: "Shop response"},
            {english: "I would like to buy some apples.", arabic: "أريد أن أشتري بعض التفاح", context: "Making purchase"},
            {english: "Thank you, have a great day!", arabic: "شكراً لك، أتمنى لك يوماً سعيداً!", context: "Ending conversation"}
          ]
        },
        {
          title: "Family & Friends",
          phrases: [
            {english: "This is my family photo.", arabic: "هذه صورة عائلتي", context: "Showing photos"},
            {english: "I have two brothers and one sister.", arabic: "لدي أخوان وأخت واحدة", context: "Describing family"},
            {english: "My father is a doctor.", arabic: "والدي طبيب", context: "Talking about parents"},
            {english: "My mother works in a school.", arabic: "والدتي تعمل في مدرسة", context: "Describing mother's job"},
            {english: "We love to spend time together.", arabic: "نحب قضاء الوقت معاً", context: "Family activities"},
            {english: "Do you have any siblings?", arabic: "هل لديك إخوة أو أخوات؟", context: "Asking about family"}
          ]
        }
      ];
      
      stageContent.innerHTML = `
        <div class="card">
          <h3>Practical Conversation Practice</h3>
          <p>Learn common phrases and conversation starters for real-life situations.</p>
          <div class="conversation-sections" style="margin-top:16px;">
            ${conversations.map((section, index) => `
              <div class="conversation-section" style="padding:16px;margin:12px 0;border:2px solid #e5e7eb;border-radius:8px;">
                <h4 style="color:#4a90e2;margin-bottom:12px;">${section.title}</h4>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:12px;">
                  ${section.phrases.map(phrase => `
                    <div style="padding:12px;background:#f8f9fa;border-radius:6px;">
                      <div style="margin-bottom:8px;">
                        <strong style="color:#1976d2;">${phrase.english}</strong>
                        <button onclick="speak('${phrase.english}')" style="padding:4px 8px;background:#4a90e2;color:white;border:none;border-radius:4px;cursor:pointer;margin-left:8px;font-size:12px;">🔊</button>
                      </div>
                      <div class="arabic-text" style="color:#666;font-size:14px;margin-bottom:4px;">${phrase.arabic}</div>
                      <div class="context-text" style="color:#999;font-size:12px;font-style:italic;">${phrase.context}</div>
                    </div>
                  `).join('')}
                </div>
              </div>
            `).join('')}
            <div class="conversation-tips" style="padding:16px;margin:12px 0;border:2px solid #673ab7;border-radius:8px;background:#f3e5f5;">
              <h4 style="color:#673ab7;margin-bottom:8px;">💬 Conversation Tips</h4>
              <ul style="margin:0;padding-left:20px;color:#666;">
                <li>Practice with a friend or family member</li>
                <li>Don't worry about making mistakes</li>
                <li>Listen carefully to the pronunciation</li>
                <li>Use body language and gestures</li>
                <li>Start with simple phrases and build up</li>
              </ul>
            </div>
          </div>
        </div>
      `;
    }

    // Stage 11 - Body Parts
    function renderBodyPartsStage(){
      const bodyParts = [
        {
          category: "Head & Face",
          parts: [
            {english: "Head", arabic: "الرأس", emoji: "👤"},
            {english: "Eye", arabic: "العين", emoji: "👁️"},
            {english: "Ear", arabic: "الأذن", emoji: "👂"},
            {english: "Nose", arabic: "الأنف", emoji: "👃"},
            {english: "Mouth", arabic: "الفم", emoji: "👄"},
            {english: "Tooth", arabic: "السن", emoji: "🦷"},
            {english: "Tongue", arabic: "اللسان", emoji: "👅"},
            {english: "Hair", arabic: "الشعر", emoji: "💇"}
          ]
        },
        {
          category: "Upper Body",
          parts: [
            {english: "Neck", arabic: "الرقبة", emoji: "👤"},
            {english: "Shoulder", arabic: "الكتف", emoji: "🤷"},
            {english: "Arm", arabic: "الذراع", emoji: "💪"},
            {english: "Elbow", arabic: "المرفق", emoji: "🦾"},
            {english: "Hand", arabic: "اليد", emoji: "✋"},
            {english: "Finger", arabic: "الإصبع", emoji: "👆"},
            {english: "Chest", arabic: "الصدر", emoji: "🫁"},
            {english: "Back", arabic: "الظهر", emoji: "🫂"}
          ]
        },
        {
          category: "Lower Body",
          parts: [
            {english: "Stomach", arabic: "المعدة", emoji: "🫃"},
            {english: "Leg", arabic: "الساق", emoji: "🦵"},
            {english: "Knee", arabic: "الركبة", emoji: "🦿"},
            {english: "Foot", arabic: "القدم", emoji: "🦶"},
            {english: "Toe", arabic: "إصبع القدم", emoji: "🦶"}
          ]
        }
      ];
      
      stageContent.innerHTML = `
        <div class="card">
          <h3>👤 Body Parts Learning</h3>
          <p>Learn the names of human body parts in English and Arabic with visual aids.</p>
          <div class="body-parts-content" style="margin-top:16px;">
            ${bodyParts.map((category, index) => `
              <div class="body-category" style="padding:16px;margin:12px 0;border:2px solid #e5e7eb;border-radius:8px;">
                <h4 style="color:#4a90e2;margin-bottom:12px;">${category.category}</h4>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;">
                  ${category.parts.map(part => `
                    <div class="body-part-card" style="padding:12px;background:#f8f9fa;border-radius:6px;text-align:center;">
                      <div style="font-size:48px;margin-bottom:8px;">
                        ${part.emoji.endsWith('.svg') ? `<img src="${part.emoji}" style="width:48px;height:48px;object-fit:contain;">` : part.emoji}
                      </div>
                      <div style="margin-bottom:8px;">
                        <strong style="color:#1976d2;font-size:18px;">${part.english}</strong>
                        <button onclick="speak('${part.english}')" style="padding:4px 8px;background:#4a90e2;color:white;border:none;border-radius:4px;cursor:pointer;margin-left:8px;font-size:12px;">🔊</button>
                      </div>
                      <div class="arabic-text" style="color:#666;font-size:16px;margin-bottom:4px;">${part.arabic}</div>
                    </div>
                  `).join('')}
                </div>
              </div>
            `).join('')}
            
            <div class="body-parts-tips" style="padding:16px;margin:12px 0;border:2px solid #673ab7;border-radius:8px;background:#f3e5f5;">
              <h4 style="color:#673ab7;margin-bottom:8px;">💡 Learning Tips</h4>
              <ul style="margin:0;padding-left:20px;color:#666;">
                <li>Point to each body part as you learn it</li>
                <li>Practice with a friend or family member</li>
                <li>Use the pronunciation buttons to hear correct sounds</li>
                <li>Try to describe what each body part does</li>
                <li>Practice both English and Arabic names</li>
              </ul>
            </div>
          </div>
        </div>
      `;
    }

    // Stage 12 - Fruits & Vegetables
    function renderFruitsVegetablesStage(){
      const fruitsVegetables = [
        {
          category: "Fruits",
          items: [
            {english: "Apple", arabic: "التفاح", emoji: "🍎"},
            {english: "Banana", arabic: "الموز", emoji: "🍌"},
            {english: "Orange", arabic: "البرتقال", emoji: "🍊"},
            {english: "Grape", arabic: "العنب", emoji: "🍇"},
            {english: "Strawberry", arabic: "الفراولة", emoji: "🍓"},
            {english: "Watermelon", arabic: "البطيخ", emoji: "🍉"},
            {english: "Pineapple", arabic: "الأناناس", emoji: "🍍"},
            {english: "Cherry", arabic: "الكرز", emoji: "🍒"},
            {english: "Peach", arabic: "الخوخ", emoji: "🍑"},
            {english: "Pear", arabic: "الإجاص", emoji: "🍐"},
            {english: "Lemon", arabic: "الليمون", emoji: "🍋"},
            {english: "Kiwi", arabic: "الكيوي", emoji: "🥝"}
          ]
        },
        {
          category: "Vegetables",
          items: [
            {english: "Carrot", arabic: "الجزر", emoji: "🥕"},
            {english: "Tomato", arabic: "الطماطم", emoji: "🍅"},
            {english: "Potato", arabic: "البطاطس", emoji: "🥔"},
            {english: "Onion", arabic: "البصل", emoji: "🧅"},
            {english: "Cucumber", arabic: "الخيار", emoji: "🥒"},
            {english: "Lettuce", arabic: "الخس", emoji: "🥬"},
            {english: "Broccoli", arabic: "البروكلي", emoji: "🥦"},
            {english: "Pepper", arabic: "الفلفل", emoji: "🌶️"},
            {english: "Corn", arabic: "الذرة", emoji: "🌽"},
            {english: "Eggplant", arabic: "الباذنجان", emoji: "🍆"},
            {english: "Garlic", arabic: "الثوم", emoji: "🧄"},
            {english: "Spinach", arabic: "السبانخ", emoji: "🌿"}
          ]
        }
      ];
      
      stageContent.innerHTML = `
        <div class="card">
          <h3>🍎 Fruits & Vegetables Learning</h3>
          <p>Learn the names of fruits and vegetables in English and Arabic with colorful emojis.</p>
          <div class="fruits-vegetables-content" style="margin-top:16px;">
            ${fruitsVegetables.map((category, index) => `
              <div class="food-category" style="padding:16px;margin:12px 0;border:2px solid #e5e7eb;border-radius:8px;">
                <h4 style="color:#4a90e2;margin-bottom:12px;">${category.category}</h4>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;">
                  ${category.items.map(item => `
                    <div class="food-item-card" style="padding:12px;background:#f8f9fa;border-radius:6px;text-align:center;">
                      <div style="font-size:48px;margin-bottom:8px;">${item.emoji}</div>
                      <div style="margin-bottom:8px;">
                        <strong style="color:#1976d2;font-size:18px;">${item.english}</strong>
                        <button onclick="speak('${item.english}')" style="padding:4px 8px;background:#4a90e2;color:white;border:none;border-radius:4px;cursor:pointer;margin-left:8px;font-size:12px;">🔊</button>
                      </div>
                      <div class="arabic-text" style="color:#666;font-size:16px;margin-bottom:4px;">${item.arabic}</div>
                    </div>
                  `).join('')}
                </div>
              </div>
            `).join('')}
            
            <div class="food-tips" style="padding:16px;margin:12px 0;border:2px solid #673ab7;border-radius:8px;background:#f3e5f5;">
              <h4 style="color:#673ab7;margin-bottom:8px;">💡 Learning Tips</h4>
              <ul style="margin:0;padding-left:20px;color:#666;">
                <li>Practice with real fruits and vegetables when possible</li>
                <li>Learn the colors of each fruit and vegetable</li>
                <li>Use the pronunciation buttons to hear correct sounds</li>
                <li>Try to describe the taste and texture of each item</li>
                <li>Practice both English and Arabic names</li>
              </ul>
            </div>
          </div>
        </div>
      `;
    }

    // Stage 13 - Colors
    function renderColorsStage(){
      const colors = [
        {
          category: "Primary Colors",
          items: [
            {english: "Red", arabic: "أحمر", emoji: "🔴", hex: "#FF0000"},
            {english: "Blue", arabic: "أزرق", emoji: "🔵", hex: "#0000FF"},
            {english: "Yellow", arabic: "أصفر", emoji: "🟡", hex: "#FFFF00"}
          ]
        },
        {
          category: "Secondary Colors",
          items: [
            {english: "Green", arabic: "أخضر", emoji: "🟢", hex: "#00FF00"},
            {english: "Orange", arabic: "برتقالي", emoji: "🟠", hex: "#FFA500"},
            {english: "Purple", arabic: "بنفسجي", emoji: "🟣", hex: "#800080"}
          ]
        },
        {
          category: "Neutral Colors",
          items: [
            {english: "Black", arabic: "أسود", emoji: "⚫", hex: "#000000"},
            {english: "White", arabic: "أبيض", emoji: "⚪", hex: "#FFFFFF"},
            {english: "Gray", arabic: "رمادي", emoji: "⚫", hex: "#808080"},
            {english: "Brown", arabic: "بني", emoji: "🟤", hex: "#8B4513"}
          ]
        },
        {
          category: "Additional Colors",
          items: [
            {english: "Pink", arabic: "وردي", emoji: "🩷", hex: "#FFC0CB"},
            {english: "Gold", arabic: "ذهبي", emoji: "🟡", hex: "#FFD700"},
            {english: "Silver", arabic: "فضي", emoji: "⚪", hex: "#C0C0C0"},
            {english: "Cyan", arabic: "سماوي", emoji: "🔵", hex: "#00FFFF"}
          ]
        }
      ];
      
      stageContent.innerHTML = `
        <div class="card">
          <h3>🎨 Colors Learning</h3>
          <p>Learn colors in English and Arabic with visual examples and pronunciation.</p>
          <div class="colors-content" style="margin-top:16px;">
            ${colors.map((category, index) => `
              <div class="color-category" style="padding:16px;margin:12px 0;border:2px solid #e5e7eb;border-radius:8px;">
                <h4 style="color:#4a90e2;margin-bottom:12px;">${category.category}</h4>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;">
                  ${category.items.map(color => `
                    <div class="color-item-card" style="padding:12px;background:#f8f9fa;border-radius:6px;text-align:center;border:2px solid ${color.hex};">
                      <div style="width:60px;height:60px;background:${color.hex};border-radius:50%;margin:0 auto 8px;border:2px solid #333;"></div>
                      <div style="margin-bottom:8px;">
                        <strong style="color:#1976d2;font-size:18px;">${color.english}</strong>
                        <button onclick="speak('${color.english}')" style="padding:4px 8px;background:#4a90e2;color:white;border:none;border-radius:4px;cursor:pointer;margin-left:8px;font-size:12px;">🔊</button>
                      </div>
                      <div class="arabic-text" style="color:#666;font-size:16px;margin-bottom:4px;">${color.arabic}</div>
                      <div style="font-size:12px;color:#999;margin-top:4px;">${color.hex}</div>
                    </div>
                  `).join('')}
                </div>
              </div>
            `).join('')}
            
            <div class="color-tips" style="padding:16px;margin:12px 0;border:2px solid #673ab7;border-radius:8px;background:#f3e5f5;">
              <h4 style="color:#673ab7;margin-bottom:8px;">💡 Learning Tips</h4>
              <ul style="margin:0;padding-left:20px;color:#666;">
                <li>Point to objects around you and name their colors</li>
                <li>Practice mixing colors to create new ones</li>
                <li>Use the pronunciation buttons to hear correct sounds</li>
                <li>Try to describe the colors of things you see daily</li>
                <li>Practice both English and Arabic color names</li>
              </ul>
            </div>
          </div>
        </div>
      `;
    }

    // Stage 15 - Date & Time
    function renderDateStage(){
      const dateData = [
        {
          category: "Days of the Week",
          items: [
            {english: "Sunday", arabic: "الأحد", abbreviation: "Sun"},
            {english: "Monday", arabic: "الاثنين", abbreviation: "Mon"},
            {english: "Tuesday", arabic: "الثلاثاء", abbreviation: "Tue"},
            {english: "Wednesday", arabic: "الأربعاء", abbreviation: "Wed"},
            {english: "Thursday", arabic: "الخميس", abbreviation: "Thu"},
            {english: "Friday", arabic: "الجمعة", abbreviation: "Fri"},
            {english: "Saturday", arabic: "السبت", abbreviation: "Sat"}
          ]
        },
        {
          category: "Months of the Year",
          items: [
            {english: "January", arabic: "يناير", number: 1},
            {english: "February", arabic: "فبراير", number: 2},
            {english: "March", arabic: "مارس", number: 3},
            {english: "April", arabic: "أبريل", number: 4},
            {english: "May", arabic: "مايو", number: 5},
            {english: "June", arabic: "يونيو", number: 6},
            {english: "July", arabic: "يوليو", number: 7},
            {english: "August", arabic: "أغسطس", number: 8},
            {english: "September", arabic: "سبتمبر", number: 9},
            {english: "October", arabic: "أكتوبر", number: 10},
            {english: "November", arabic: "نوفمبر", number: 11},
            {english: "December", arabic: "ديسمبر", number: 12}
          ]
        },
        {
          category: "Date Writing Examples",
          items: [
            {english: "January 1st, 2025", arabic: "الأول من يناير 2025", format: "Month Day, Year"},
            {english: "February 2nd, 2025", arabic: "الثاني من فبراير 2025", format: "Month Day, Year"},
            {english: "March 15th, 2025", arabic: "الخامس عشر من مارس 2025", format: "Month Day, Year"},
            {english: "December 25th, 2025", arabic: "الخامس والعشرون من ديسمبر 2025", format: "Month Day, Year"},
            {english: "Today is Monday", arabic: "اليوم هو الاثنين", format: "Today is [Day]"},
            {english: "Tomorrow is Tuesday", arabic: "غداً هو الثلاثاء", format: "Tomorrow is [Day]"},
            {english: "Yesterday was Sunday", arabic: "أمس كان الأحد", format: "Yesterday was [Day]"}
          ]
        }
      ];
      
      stageContent.innerHTML = `
        <div class="card">
          <h3>📅 Date & Time Learning</h3>
          <p>Learn days of the week, months, and how to write dates in English!</p>
        </div>
        
        <div class="date-content">
          ${dateData.map(category => `
            <div class="date-category">
              <h4>${category.category}</h4>
              <div class="date-items">
                ${category.items.map(item => `
                  <div class="date-item-card">
                    <div class="date-main">
                      <div class="date-english">${item.english}</div>
                      <div class="arabic-text">${item.arabic}</div>
                      ${item.abbreviation ? `<div class="date-abbreviation">${item.abbreviation}</div>` : ''}
                      ${item.number ? `<div class="date-number">${item.number}</div>` : ''}
                      ${item.format ? `<div class="date-format">${item.format}</div>` : ''}
                    </div>
                    <button onclick="speakSync('${item.english}')" class="date-speak-btn">🔊 Speak</button>
                  </div>
                `).join('')}
              </div>
            </div>
          `).join('')}
        </div>
        
        <div class="date-tips">
          <h4>📝 Writing Tips</h4>
          <ul>
            <li><strong>Days:</strong> Always capitalize the first letter (Monday, Tuesday)</li>
            <li><strong>Months:</strong> Always capitalize the first letter (January, February)</li>
            <li><strong>Dates:</strong> Use ordinal numbers (1st, 2nd, 3rd, 4th, etc.)</li>
            <li><strong>Format:</strong> Month Day, Year (January 1st, 2025)</li>
            <li><strong>Prepositions:</strong> Use "on" for days (on Monday), "in" for months (in January)</li>
          </ul>
        </div>
      `;
      
    }

    // Stage 16 - Clock Reading
    function renderClockStage(){
      const clockData = [
        {
          category: "Basic Time Reading",
          items: [
            {time: "12:00", english: "Twelve o'clock", arabic: "الساعة الثانية عشرة", type: "noon"},
            {time: "3:00", english: "Three o'clock", arabic: "الساعة الثالثة", type: "hour"},
            {time: "6:00", english: "Six o'clock", arabic: "الساعة السادسة", type: "hour"},
            {time: "9:00", english: "Nine o'clock", arabic: "الساعة التاسعة", type: "hour"},
            {time: "12:00 AM", english: "Midnight", arabic: "منتصف الليل", type: "midnight"}
          ]
        },
        {
          category: "Half Hours",
          items: [
            {time: "1:30", english: "One thirty", arabic: "الساعة الواحدة والنصف", type: "half"},
            {time: "2:30", english: "Two thirty", arabic: "الساعة الثانية والنصف", type: "half"},
            {time: "4:30", english: "Four thirty", arabic: "الساعة الرابعة والنصف", type: "half"},
            {time: "7:30", english: "Seven thirty", arabic: "الساعة السابعة والنصف", type: "half"},
            {time: "10:30", english: "Ten thirty", arabic: "الساعة العاشرة والنصف", type: "half"}
          ]
        },
        {
          category: "Quarter Hours",
          items: [
            {time: "2:15", english: "Two fifteen", arabic: "الساعة الثانية والربع", type: "quarter"},
            {time: "5:15", english: "Five fifteen", arabic: "الساعة الخامسة والربع", type: "quarter"},
            {time: "8:45", english: "Eight forty-five", arabic: "الساعة التاسعة إلا ربع", type: "quarter"},
            {time: "11:45", english: "Eleven forty-five", arabic: "الساعة الثانية عشرة إلا ربع", type: "quarter"}
          ]
        },
        {
          category: "Common Times",
          items: [
            {time: "7:00 AM", english: "Seven in the morning", arabic: "الساعة السابعة صباحاً", type: "morning"},
            {time: "12:00 PM", english: "Twelve noon", arabic: "الساعة الثانية عشرة ظهراً", type: "noon"},
            {time: "3:00 PM", english: "Three in the afternoon", arabic: "الساعة الثالثة بعد الظهر", type: "afternoon"},
            {time: "6:00 PM", english: "Six in the evening", arabic: "الساعة السادسة مساءً", type: "evening"},
            {time: "9:00 PM", english: "Nine at night", arabic: "الساعة التاسعة ليلاً", type: "night"}
          ]
        },
        {
          category: "Minutes Before (To)",
          items: [
            {time: "7:45", english: "Quarter to eight", arabic: "الثامنة إلا ربع", type: "quarter-to"},
            {time: "5:50", english: "Ten to six", arabic: "السادسة إلا عشر دقائق", type: "ten-to"},
            {time: "8:40", english: "Twenty to nine", arabic: "التاسعة إلا عشرون دقيقة", type: "twenty-to"},
            {time: "11:55", english: "Five to twelve", arabic: "الثانية عشرة إلا خمس دقائق", type: "five-to"},
            {time: "2:35", english: "Twenty-five to three", arabic: "الثالثة إلا خمس وعشرون دقيقة", type: "twenty-five-to"},
            {time: "4:30", english: "Half past four", arabic: "الرابعة والنصف", type: "half-past"}
          ]
        },
        {
          category: "Different Ways to Read Time",
          items: [
            {time: "8:15", english: "Quarter past eight / Eight fifteen", arabic: "الثامنة والربع / ثمانية وخمسة عشر", type: "multiple-ways"},
            {time: "9:30", english: "Half past nine / Nine thirty", arabic: "التاسعة والنصف / تسعة وثلاثون", type: "multiple-ways"},
            {time: "10:45", english: "Quarter to eleven / Ten forty-five", arabic: "الحادية عشرة إلا ربع / عشرة وخمسة وأربعون", type: "multiple-ways"},
            {time: "3:20", english: "Twenty past three / Three twenty", arabic: "الثالثة وعشرون / ثلاثة وعشرون", type: "multiple-ways"},
            {time: "6:50", english: "Ten to seven / Six fifty", arabic: "السابعة إلا عشر / ستة وخمسون", type: "multiple-ways"}
          ]
        }
      ];
      
      stageContent.innerHTML = `
        <div class="card">
          <h3>🕐 Clock Reading Learning</h3>
          <p>Learn how to read time and tell the time in English!</p>
        </div>
        
        <div class="clock-content">
          ${clockData.map(category => `
            <div class="clock-category">
              <h4>${category.category}</h4>
              <div class="clock-items">
                ${category.items.map(item => `
                  <div class="clock-item-card">
                    <div class="clock-main">
                      <div class="clock-time">${item.time}</div>
                      <div class="clock-english">${item.english}</div>
                      <div class="arabic-text">${item.arabic}</div>
                      <div class="clock-type">${item.type}</div>
                    </div>
                    <button onclick="speakSync('${item.english}')" class="clock-speak-btn">🔊 Speak</button>
                  </div>
                `).join('')}
              </div>
            </div>
          `).join('')}
        </div>
        
        <div class="clock-tips">
          <h4>⏰ Time Reading Tips</h4>
          <ul>
            <li><strong>O'clock:</strong> Use for exact hours (3:00 = "Three o'clock")</li>
            <li><strong>Half past:</strong> 30 minutes past the hour (2:30 = "Half past two")</li>
            <li><strong>Quarter past:</strong> 15 minutes past (2:15 = "Quarter past two")</li>
            <li><strong>Quarter to:</strong> 15 minutes before (2:45 = "Quarter to three")</li>
            <li><strong>AM/PM:</strong> AM for morning, PM for afternoon/evening</li>
            <li><strong>Military time:</strong> 24-hour format (13:00 = 1:00 PM)</li>
          </ul>
        </div>
      `;
      
    }

    // Stage 17 - Family & Relatives
    function renderFamilyStage(){
      const familyData = [
        {
          category: "Immediate Family",
          items: [
            {english: "Father", arabic: "أب", relationship: "parent", emoji: "👨"},
            {english: "Mother", arabic: "أم", relationship: "parent", emoji: "👩"},
            {english: "Son", arabic: "ابن", relationship: "child", emoji: "👦"},
            {english: "Daughter", arabic: "ابنة", relationship: "child", emoji: "👧"},
            {english: "Brother", arabic: "أخ", relationship: "sibling", emoji: "👨‍👦"},
            {english: "Sister", arabic: "أخت", relationship: "sibling", emoji: "👩‍👧"}
          ]
        },
        {
          category: "Extended Family",
          items: [
            {english: "Grandfather", arabic: "جد", relationship: "grandparent", emoji: "👴"},
            {english: "Grandmother", arabic: "جدة", relationship: "grandparent", emoji: "👵"},
            {english: "Uncle", arabic: "عم / خال", relationship: "uncle", emoji: "👨‍👨‍👦"},
            {english: "Aunt", arabic: "عمة / خالة", relationship: "aunt", emoji: "👩‍👩‍👧"},
            {english: "Cousin", arabic: "ابن عم / ابن خال", relationship: "cousin", emoji: "👨‍👧"},
            {english: "Nephew", arabic: "ابن أخ / ابن أخت", relationship: "nephew", emoji: "👶"},
            {english: "Niece", arabic: "ابنة أخ / ابنة أخت", relationship: "niece", emoji: "👶"}
          ]
        },
        {
          category: "Family Relationships",
          items: [
            {english: "Husband", arabic: "زوج", relationship: "spouse", emoji: "👨‍💼"},
            {english: "Wife", arabic: "زوجة", relationship: "spouse", emoji: "👩‍💼"},
            {english: "Baby", arabic: "طفل رضيع", relationship: "baby", emoji: "👶"},
            {english: "Twin", arabic: "توأم", relationship: "twin", emoji: "👶👶"},
            {english: "Stepfather", arabic: "زوج الأم", relationship: "step-parent", emoji: "👨‍👩‍👧"},
            {english: "Stepmother", arabic: "زوجة الأب", relationship: "step-parent", emoji: "👩‍👨‍👦"}
          ]
        }
      ];
      
      stageContent.innerHTML = `
        <div class="card">
          <h3>👨‍👩‍👧‍👦 Family & Relatives Learning</h3>
          <p>Learn family members and their relationships in English!</p>
        </div>
        
        <div class="family-content">
          ${familyData.map(category => `
            <div class="family-category">
              <h4>${category.category}</h4>
              <div class="family-items">
                ${category.items.map(member => `
                  <div class="family-item-card">
                    <div class="family-main">
                      <div class="family-emoji">${member.emoji}</div>
                      <div class="family-english">${member.english}</div>
                      <div class="arabic-text">${member.arabic}</div>
                      <div class="family-relationship">${member.relationship}</div>
                    </div>
                    <button onclick="speakSync('${member.english}')" class="family-speak-btn">🔊 Speak</button>
                  </div>
                `).join('')}
              </div>
            </div>
          `).join('')}
        </div>
        
        <div class="family-tips">
          <h4>👨‍👩‍👧‍👦 Family Tips</h4>
          <ul>
            <li><strong>Capitalization:</strong> Always capitalize family titles (Father, Mother)</li>
            <li><strong>Possessive:</strong> Use apostrophe + s (Father's car, Mother's house)</li>
            <li><strong>Articles:</strong> Use "the" with family (the father, the mother)</li>
            <li><strong>Plural:</strong> Add -s for multiple (brothers, sisters, cousins)</li>
            <li><strong>Relationships:</strong> Learn both sides (father-son, mother-daughter)</li>
          </ul>
        </div>
      `;
      
    }

    // Stage 18 - Animals
    function renderAnimalsStage(){
      const animalsData = [
        {
          category: "Farm Animals",
          items: [
            {english: "Cow", arabic: "بقرة", sound: "Moo", habitat: "farm", emoji: "🐄"},
            {english: "Pig", arabic: "خنزير", sound: "Oink", habitat: "farm", emoji: "🐷"},
            {english: "Sheep", arabic: "خروف", sound: "Baa", habitat: "farm", emoji: "🐑"},
            {english: "Goat", arabic: "ماعز", sound: "Bleat", habitat: "farm", emoji: "🐐"},
            {english: "Horse", arabic: "حصان", sound: "Neigh", habitat: "farm", emoji: "🐴"},
            {english: "Chicken", arabic: "دجاجة", sound: "Cluck", habitat: "farm", emoji: "🐔"},
            {english: "Duck", arabic: "بطة", sound: "Quack", habitat: "farm", emoji: "🦆"},
            {english: "Rooster", arabic: "ديك", sound: "Cock-a-doodle-doo", habitat: "farm", emoji: "🐓"}
          ]
        },
        {
          category: "Wild Animals",
          items: [
            {english: "Lion", arabic: "أسد", sound: "Roar", habitat: "savanna", emoji: "🦁"},
            {english: "Tiger", arabic: "نمر", sound: "Roar", habitat: "jungle", emoji: "🐅"},
            {english: "Elephant", arabic: "فيل", sound: "Trumpet", habitat: "savanna", emoji: "🐘"},
            {english: "Giraffe", arabic: "زرافة", sound: "Hum", habitat: "savanna", emoji: "🦒"},
            {english: "Monkey", arabic: "قرد", sound: "Chatter", habitat: "jungle", emoji: "🐵"},
            {english: "Bear", arabic: "دب", sound: "Growl", habitat: "forest", emoji: "🐻"},
            {english: "Wolf", arabic: "ذئب", sound: "Howl", habitat: "forest", emoji: "🐺"},
            {english: "Fox", arabic: "ثعلب", sound: "Bark", habitat: "forest", emoji: "🦊"}
          ]
        },
        {
          category: "Pets",
          items: [
            {english: "Dog", arabic: "كلب", sound: "Woof", habitat: "home", emoji: "🐕"},
            {english: "Cat", arabic: "قطة", sound: "Meow", habitat: "home", emoji: "🐱"},
            {english: "Bird", arabic: "طائر", sound: "Tweet", habitat: "home", emoji: "🐦"},
            {english: "Fish", arabic: "سمكة", sound: "Silent", habitat: "aquarium", emoji: "🐠"},
            {english: "Hamster", arabic: "هامستر", sound: "Squeak", habitat: "cage", emoji: "🐹"},
            {english: "Rabbit", arabic: "أرنب", sound: "Squeak", habitat: "home", emoji: "🐰"}
          ]
        },
        {
          category: "Sea Animals",
          items: [
            {english: "Fish", arabic: "سمكة", sound: "Silent", habitat: "ocean", emoji: "🐟"},
            {english: "Shark", arabic: "قرش", sound: "Silent", habitat: "ocean", emoji: "🦈"},
            {english: "Whale", arabic: "حوت", sound: "Sing", habitat: "ocean", emoji: "🐋"},
            {english: "Dolphin", arabic: "دلفين", sound: "Click", habitat: "ocean", emoji: "🐬"},
            {english: "Octopus", arabic: "أخطبوط", sound: "Silent", habitat: "ocean", emoji: "🐙"},
            {english: "Crab", arabic: "سلطعون", sound: "Silent", habitat: "beach", emoji: "🦀"}
          ]
        }
      ];
      
      stageContent.innerHTML = `
        <div class="card">
          <h3>🐾 Animals Learning</h3>
          <p>Learn animals, their sounds, and habitats in English!</p>
        </div>
        
        <div class="animals-content">
          ${animalsData.map(category => `
            <div class="animals-category">
              <h4>${category.category}</h4>
              <div class="animals-items">
                ${category.items.map(animal => `
                  <div class="animals-item-card">
                    <div class="animals-main">
                      <div class="animals-emoji">${animal.emoji}</div>
                      <div class="animals-english">${animal.english}</div>
                      <div class="arabic-text">${animal.arabic}</div>
                      <div class="animals-sound">${animal.sound}</div>
                      <div class="animals-habitat">${animal.habitat}</div>
                    </div>
                    <button onclick="speakSync('${animal.english}')" class="animals-speak-btn">🔊 Speak</button>
                  </div>
                `).join('')}
              </div>
            </div>
          `).join('')}
        </div>
        
        <div class="animals-tips">
          <h4>🐾 Animal Tips</h4>
          <ul>
            <li><strong>Sounds:</strong> Animals make different sounds (cow moos, cat meows)</li>
            <li><strong>Habitats:</strong> Where animals live (farm, forest, ocean)</li>
            <li><strong>Plural:</strong> Most animals add -s (dogs, cats, birds)</li>
            <li><strong>Groups:</strong> Special names for groups (herd of cows, flock of birds)</li>
            <li><strong>Baby Names:</strong> Young animals have special names (puppy, kitten, calf)</li>
          </ul>
        </div>
      `;
      
    }

    // Stage 19 - School & Education
    function renderSchoolStage(){
      const schoolData = [
        {
          category: "School People",
          items: [
            {english: "Teacher", arabic: "معلم", role: "educator", emoji: "👩‍🏫"},
            {english: "Student", arabic: "طالب", role: "learner", emoji: "👨‍🎓"},
            {english: "Principal", arabic: "مدير المدرسة", role: "administrator", emoji: "👨‍💼"},
            {english: "Librarian", arabic: "أمين المكتبة", role: "library staff", emoji: "👩‍💼"},
            {english: "Janitor", arabic: "حارس المدرسة", role: "maintenance", emoji: "👨‍🔧"},
            {english: "Nurse", arabic: "ممرضة", role: "health care", emoji: "👩‍⚕️"}
          ]
        },
        {
          category: "Classroom Objects",
          items: [
            {english: "Desk", arabic: "مكتب", type: "furniture", emoji: "🖥️", image: "desk_icon.svg"},
            {english: "Chair", arabic: "كرسي", type: "furniture", emoji: "🪑"},
            {english: "Blackboard", arabic: "سبورة", type: "teaching tool", emoji: "⬛"},
            {english: "Chalk", arabic: "طباشير", type: "writing tool", emoji: "🖍️", image: "chalk_icon.svg"},
            {english: "Eraser", arabic: "ممحاة", type: "writing tool", emoji: "🧽"},
            {english: "Ruler", arabic: "مسطرة", type: "measuring tool", emoji: "📏"},
            {english: "Pencil", arabic: "قلم رصاص", type: "writing tool", emoji: "✏️"},
            {english: "Pen", arabic: "قلم حبر", type: "writing tool", emoji: "🖊️"},
            {english: "Book", arabic: "كتاب", type: "learning material", emoji: "📚"},
            {english: "Notebook", arabic: "دفتر", type: "learning material", emoji: "📓"},
            {english: "Backpack", arabic: "حقيبة مدرسية", type: "carrying tool", emoji: "🎒"},
            {english: "Calculator", arabic: "آلة حاسبة", type: "math tool", emoji: "🧮"}
          ]
        },
        {
          category: "School Subjects",
          items: [
            {english: "Mathematics", arabic: "الرياضيات", abbreviation: "Math", emoji: "🔢"},
            {english: "English", arabic: "اللغة الإنجليزية", abbreviation: "English", emoji: "📝"},
            {english: "Science", arabic: "العلوم", abbreviation: "Science", emoji: "🔬"},
            {english: "History", arabic: "التاريخ", abbreviation: "History", emoji: "📜"},
            {english: "Geography", arabic: "الجغرافيا", abbreviation: "Geography", emoji: "🌍"},
            {english: "Art", arabic: "الرسم", abbreviation: "Art", emoji: "🎨"},
            {english: "Music", arabic: "الموسيقى", abbreviation: "Music", emoji: "🎵"},
            {english: "Physical Education", arabic: "التربية البدنية", abbreviation: "P.E.", emoji: "⚽"},
            {english: "Computer Science", arabic: "علوم الحاسوب", abbreviation: "CS", emoji: "💻"}
          ]
        },
        {
          category: "School Activities",
          items: [
            {english: "Study", arabic: "دراسة", activity: "learning", emoji: "📖"},
            {english: "Read", arabic: "قراءة", activity: "reading", emoji: "📚"},
            {english: "Write", arabic: "كتابة", activity: "writing", emoji: "✍️"},
            {english: "Draw", arabic: "رسم", activity: "art", emoji: "🎨"},
            {english: "Sing", arabic: "غناء", activity: "music", emoji: "🎤"},
            {english: "Play", arabic: "لعب", activity: "recreation", emoji: "🎮"},
            {english: "Exercise", arabic: "تمرين", activity: "physical", emoji: "🏃‍♂️"},
            {english: "Experiment", arabic: "تجربة", activity: "science", emoji: "🧪"}
          ]
        }
      ];
      
      stageContent.innerHTML = `
        <div class="card">
          <h3>🏫 School & Education Learning</h3>
          <p>Learn school objects, subjects, and activities in English!</p>
        </div>
        
        <div class="school-content">
          ${schoolData.map(category => `
            <div class="school-category">
              <h4>${category.category}</h4>
              <div class="school-items">
                ${category.items.map(item => `
                  <div class="school-item-card">
                    <div class="school-main">
                      ${item.image ? 
                        `<div class="school-image"><img src="${item.image}" alt="${item.english}" style="width: 48px; height: 48px; object-fit: contain;"></div>` : 
                        `<div class="school-emoji">${item.emoji}</div>`
                      }
                      <div class="school-english">${item.english}</div>
                      <div class="arabic-text">${item.arabic}</div>
                      ${item.abbreviation ? `<div class="school-abbreviation">${item.abbreviation}</div>` : ''}
                      ${item.role ? `<div class="school-role">${item.role}</div>` : ''}
                      ${item.type ? `<div class="school-type">${item.type}</div>` : ''}
                      ${item.activity ? `<div class="school-activity">${item.activity}</div>` : ''}
                    </div>
                    <button onclick="speakSync('${item.english}')" class="school-speak-btn">🔊 Speak</button>
                  </div>
                `).join('')}
              </div>
            </div>
          `).join('')}
        </div>
        
        <div class="school-tips">
          <h4>🏫 School Tips</h4>
          <ul>
            <li><strong>Capitalization:</strong> Capitalize school subjects (Mathematics, English)</li>
            <li><strong>Articles:</strong> Use "the" with school objects (the desk, the chair)</li>
            <li><strong>Plural:</strong> Add -s for multiple objects (desks, chairs, books)</li>
            <li><strong>Abbreviations:</strong> Learn common abbreviations (P.E., CS)</li>
            <li><strong>Activities:</strong> Use -ing form for activities (studying, reading)</li>
          </ul>
        </div>
      `;
      
    }

    // Stage 14 - Numbers
    function renderNumbersStage(){
      const numbers = [
        {
          category: "Basic Numbers (1-50)",
          items: [
            {english: "One", arabic: "واحد", number: 1, emoji: ""},
            {english: "Two", arabic: "اثنان", number: 2, emoji: ""},
            {english: "Three", arabic: "ثلاثة", number: 3, emoji: ""},
            {english: "Four", arabic: "أربعة", number: 4, emoji: ""},
            {english: "Five", arabic: "خمسة", number: 5, emoji: ""},
            {english: "Six", arabic: "ستة", number: 6, emoji: ""},
            {english: "Seven", arabic: "سبعة", number: 7, emoji: ""},
            {english: "Eight", arabic: "ثمانية", number: 8, emoji: ""},
            {english: "Nine", arabic: "تسعة", number: 9, emoji: ""},
            {english: "Ten", arabic: "عشرة", number: 10, emoji: ""},
            {english: "Eleven", arabic: "أحد عشر", number: 11, emoji: ""},
            {english: "Twelve", arabic: "اثنا عشر", number: 12, emoji: ""},
            {english: "Thirteen", arabic: "ثلاثة عشر", number: 13, emoji: ""},
            {english: "Fourteen", arabic: "أربعة عشر", number: 14, emoji: ""},
            {english: "Fifteen", arabic: "خمسة عشر", number: 15, emoji: ""},
            {english: "Sixteen", arabic: "ستة عشر", number: 16, emoji: ""},
            {english: "Seventeen", arabic: "سبعة عشر", number: 17, emoji: ""},
            {english: "Eighteen", arabic: "ثمانية عشر", number: 18, emoji: ""},
            {english: "Nineteen", arabic: "تسعة عشر", number: 19, emoji: ""},
            {english: "Twenty", arabic: "عشرون", number: 20, emoji: ""},
            {english: "Twenty-One", arabic: "واحد وعشرون", number: 21, emoji: ""},
            {english: "Twenty-Two", arabic: "اثنان وعشرون", number: 22, emoji: ""},
            {english: "Twenty-Three", arabic: "ثلاثة وعشرون", number: 23, emoji: ""},
            {english: "Twenty-Four", arabic: "أربعة وعشرون", number: 24, emoji: ""},
            {english: "Twenty-Five", arabic: "خمسة وعشرون", number: 25, emoji: ""},
            {english: "Twenty-Six", arabic: "ستة وعشرون", number: 26, emoji: ""},
            {english: "Twenty-Seven", arabic: "سبعة وعشرون", number: 27, emoji: ""},
            {english: "Twenty-Eight", arabic: "ثمانية وعشرون", number: 28, emoji: ""},
            {english: "Twenty-Nine", arabic: "تسعة وعشرون", number: 29, emoji: ""},
            {english: "Thirty", arabic: "ثلاثون", number: 30, emoji: ""},
            {english: "Thirty-One", arabic: "واحد وثلاثون", number: 31, emoji: ""},
            {english: "Thirty-Two", arabic: "اثنان وثلاثون", number: 32, emoji: ""},
            {english: "Thirty-Three", arabic: "ثلاثة وثلاثون", number: 33, emoji: ""},
            {english: "Thirty-Four", arabic: "أربعة وثلاثون", number: 34, emoji: ""},
            {english: "Thirty-Five", arabic: "خمسة وثلاثون", number: 35, emoji: ""},
            {english: "Thirty-Six", arabic: "ستة وثلاثون", number: 36, emoji: ""},
            {english: "Thirty-Seven", arabic: "سبعة وثلاثون", number: 37, emoji: ""},
            {english: "Thirty-Eight", arabic: "ثمانية وثلاثون", number: 38, emoji: ""},
            {english: "Thirty-Nine", arabic: "تسعة وثلاثون", number: 39, emoji: ""},
            {english: "Forty", arabic: "أربعون", number: 40, emoji: ""},
            {english: "Forty-One", arabic: "واحد وأربعون", number: 41, emoji: ""},
            {english: "Forty-Two", arabic: "اثنان وأربعون", number: 42, emoji: ""},
            {english: "Forty-Three", arabic: "ثلاثة وأربعون", number: 43, emoji: ""},
            {english: "Forty-Four", arabic: "أربعة وأربعون", number: 44, emoji: ""},
            {english: "Forty-Five", arabic: "خمسة وأربعون", number: 45, emoji: ""},
            {english: "Forty-Six", arabic: "ستة وأربعون", number: 46, emoji: ""},
            {english: "Forty-Seven", arabic: "سبعة وأربعون", number: 47, emoji: ""},
            {english: "Forty-Eight", arabic: "ثمانية وأربعون", number: 48, emoji: ""},
            {english: "Forty-Nine", arabic: "تسعة وأربعون", number: 49, emoji: ""},
            {english: "Fifty", arabic: "خمسون", number: 50, emoji: ""}
          ]
        },
        {
          category: "Tens (10, 20, 30...)",
          items: [
            {english: "Ten", arabic: "عشرة", number: 10, emoji: ""},
            {english: "Twenty", arabic: "عشرون", number: 20, emoji: ""},
            {english: "Thirty", arabic: "ثلاثون", number: 30, emoji: ""},
            {english: "Forty", arabic: "أربعون", number: 40, emoji: ""},
            {english: "Fifty", arabic: "خمسون", number: 50, emoji: ""},
            {english: "Sixty", arabic: "ستون", number: 60, emoji: ""},
            {english: "Seventy", arabic: "سبعون", number: 70, emoji: ""},
            {english: "Eighty", arabic: "ثمانون", number: 80, emoji: ""},
            {english: "Ninety", arabic: "تسعون", number: 90, emoji: ""},
            {english: "One Hundred", arabic: "مائة", number: 100, emoji: ""}
          ]
        },
        {
          category: "Powers of 10",
          items: [
            {english: "Ten", arabic: "عشرة", number: 10, emoji: ""},
            {english: "One Hundred", arabic: "مائة", number: 100, emoji: ""},
            {english: "One Thousand", arabic: "ألف", number: 1000, emoji: ""},
            {english: "Ten Thousand", arabic: "عشرة آلاف", number: 10000, emoji: ""},
            {english: "One Hundred Thousand", arabic: "مائة ألف", number: 100000, emoji: ""},
            {english: "One Million", arabic: "مليون", number: 1000000, emoji: ""}
          ]
        }
      ];
      
      stageContent.innerHTML = `
        <div class="card">
          <h3>🔢 Numbers Learning</h3>
          <p>Learn numbers from 1 to 100 and powers of 10 in English and Arabic.</p>
          <div class="numbers-content" style="margin-top:16px;">
            ${numbers.map((category, index) => `
              <div class="number-category" style="padding:16px;margin:12px 0;border:2px solid #e5e7eb;border-radius:8px;">
                <h4 style="color:#4a90e2;margin-bottom:12px;">${category.category}</h4>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;">
                  ${category.items.map(number => `
                    <div class="number-item-card" style="padding:12px;background:#f8f9fa;border-radius:6px;text-align:center;">
                      ${number.emoji ? `<div style="font-size:48px;margin-bottom:8px;">${number.emoji}</div>` : ''}
                      <div style="font-size:24px;font-weight:bold;color:#1976d2;margin-bottom:8px;">${number.number}</div>
                      <div style="margin-bottom:8px;">
                        <strong style="color:#1976d2;font-size:16px;">${number.english}</strong>
                        <button onclick="speak('${number.english}')" style="padding:4px 8px;background:#4a90e2;color:white;border:none;border-radius:4px;cursor:pointer;margin-left:8px;font-size:12px;">🔊</button>
                      </div>
                      <div class="arabic-text" style="color:#666;font-size:14px;margin-bottom:4px;">${number.arabic}</div>
                    </div>
                  `).join('')}
                </div>
              </div>
            `).join('')}
            
            <div class="number-tips" style="padding:16px;margin:12px 0;border:2px solid #673ab7;border-radius:8px;background:#f3e5f5;">
              <h4 style="color:#673ab7;margin-bottom:8px;">💡 Learning Tips</h4>
              <ul style="margin:0;padding-left:20px;color:#666;">
                <li>Count objects around you using both languages</li>
                <li>Practice counting by tens (10, 20, 30...)</li>
                <li>Use the pronunciation buttons to hear correct sounds</li>
                <li>Try to write numbers in both English and Arabic</li>
                <li>Practice simple addition and subtraction</li>
              </ul>
            </div>
          </div>
        </div>
      `;
    }

    // Stage 15 - Interactive Games
    function renderInteractiveGamesStage(){
      const games = [
        {
          title: "Memory Game",
          description: "Match words with their pictures to improve vocabulary",
          type: "memory",
          words: [
            {word: "cat", meaning: "A small furry animal that says meow", emoji: "🐱"},
            {word: "dog", meaning: "A loyal pet that says woof", emoji: "🐶"},
            {word: "book", meaning: "Something you read", emoji: "📚"},
            {word: "house", meaning: "A place where you live", emoji: "🏠"},
            {word: "tree", meaning: "A tall plant with leaves", emoji: "🌳"},
            {word: "car", meaning: "A vehicle with four wheels", emoji: "🚗"},
            {word: "ball", meaning: "Something round you play with", emoji: "⚽"},
            {word: "sun", meaning: "The bright star in the sky", emoji: "☀️"},
            {word: "water", meaning: "Clear liquid we drink", emoji: "💧"},
            {word: "food", meaning: "What we eat", emoji: "🍎"},
            {word: "school", meaning: "A place where you learn", emoji: "🏫"},
            {word: "friend", meaning: "Someone you like", emoji: "👫"}
          ]
        },
        {
          title: "Crossword Puzzle",
          description: "Solve crossword puzzles with English words",
          type: "crossword",
          clues: [
            {clue: "A furry pet that says 'meow'", answer: "cat", length: 3},
            {clue: "You read this", answer: "book", length: 4},
            {clue: "Where you live", answer: "house", length: 5},
            {clue: "Big and yellow in the sky", answer: "sun", length: 3},
            {clue: "A loyal pet that says 'woof'", answer: "dog", length: 3},
            {clue: "A place where you learn", answer: "school", length: 6},
            {clue: "Something round you play with", answer: "ball", length: 4},
            {clue: "A tall plant with leaves", answer: "tree", length: 4},
            {clue: "A vehicle with four wheels", answer: "car", length: 3},
            {clue: "Clear liquid we drink", answer: "water", length: 5}
          ]
        },
        {
          title: "Who Am I?",
          description: "Guess the word from clues and descriptions",
          type: "guessing",
          items: [
            {clues: ["I am an animal", "I have four legs", "I say 'woof'", "I am very loyal"], answer: "dog", category: "Animals"},
            {clues: ["I am a place", "You sleep here", "I have a bed", "I am in your house"], answer: "bedroom", category: "Places"},
            {clues: ["I am a color", "I am like grass", "I am bright", "I am nature's color"], answer: "green", category: "Colors"},
            {clues: ["I am an object", "You read me", "I have pages", "I contain stories"], answer: "book", category: "Objects"},
            {clues: ["I am a food", "I am red and round", "I am healthy", "I grow on trees"], answer: "apple", category: "Food"},
            {clues: ["I am a vehicle", "I have four wheels", "I take you places", "I need fuel"], answer: "car", category: "Transportation"},
            {clues: ["I am a season", "I am warm", "I have flowers", "I come after winter"], answer: "spring", category: "Seasons"},
            {clues: ["I am a body part", "I help you see", "I have two", "I are on your face"], answer: "eyes", category: "Body Parts"}
          ]
        },
        {
          title: "Sentence Builder",
          description: "Arrange words to make correct sentences",
          type: "sentence",
          sentences: [
            {words: ["I", "like", "to", "read", "books"], correct: "I like to read books", difficulty: "Easy"},
            {words: ["The", "cat", "is", "sleeping"], correct: "The cat is sleeping", difficulty: "Easy"},
            {words: ["My", "favorite", "color", "is", "blue"], correct: "My favorite color is blue", difficulty: "Easy"},
            {words: ["She", "goes", "to", "school", "every", "day"], correct: "She goes to school every day", difficulty: "Medium"},
            {words: ["We", "are", "learning", "English", "together"], correct: "We are learning English together", difficulty: "Medium"},
            {words: ["The", "weather", "is", "beautiful", "today"], correct: "The weather is beautiful today", difficulty: "Medium"},
            {words: ["I", "would", "like", "to", "visit", "London", "someday"], correct: "I would like to visit London someday", difficulty: "Hard"},
            {words: ["My", "family", "and", "I", "enjoy", "playing", "games"], correct: "My family and I enjoy playing games", difficulty: "Hard"}
          ]
        },
        {
          title: "Word Search",
          description: "Find hidden words in the letter grid",
          type: "wordsearch",
          words: ["cat", "dog", "book", "house", "tree", "car", "ball", "sun"],
          grid: [
            ["C", "A", "T", "B", "O", "O", "K"],
            ["D", "O", "G", "H", "O", "U", "S"],
            ["T", "R", "E", "E", "C", "A", "R"],
            ["B", "A", "L", "L", "S", "U", "N"]
          ]
        },
        {
          title: "Spelling Bee",
          description: "Spell words correctly to win points",
          type: "spelling",
          words: [
            {word: "hello", difficulty: "Easy", points: 10},
            {word: "beautiful", difficulty: "Medium", points: 20},
            {word: "elephant", difficulty: "Medium", points: 20},
            {word: "chocolate", difficulty: "Hard", points: 30},
            {word: "restaurant", difficulty: "Hard", points: 30},
            {word: "adventure", difficulty: "Hard", points: 30}
          ]
        }
      ];
      
      stageContent.innerHTML = `
        <div class="card">
          <h3>Interactive Games</h3>
          <p>Learn English through fun and engaging games! Choose a game to start playing.</p>
          <div class="games-container" style="margin-top:16px;">
            ${games.map((game, index) => `
              <div class="game-card" style="padding:16px;margin:12px 0;border:2px solid #e5e7eb;border-radius:8px;background:linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                <div style="display:flex;align-items:center;margin-bottom:12px;">
                  <div style="font-size:24px;margin-right:12px;">${getGameEmoji(game.type)}</div>
                  <div>
                    <h4 style="color:#4a90e2;margin:0;font-size:18px;">${game.title}</h4>
                    <div style="font-size:12px;color:#666;margin-top:2px;">${getGameDifficulty(game.type)}</div>
                  </div>
                </div>
                <p style="color:#666;margin-bottom:12px;font-size:14px;">${game.description}</p>
                <div style="display:flex;justify-content:space-between;align-items:center;">
                  <div style="font-size:12px;color:#999;">
                    ${game.words ? `${game.words.length} words` : ''}
                    ${game.clues ? `${game.clues.length} clues` : ''}
                    ${game.sentences ? `${game.sentences.length} sentences` : ''}
                  </div>
                  <button onclick="startGame('${game.type}', ${JSON.stringify(game).replace(/"/g, '&quot;')})" 
                          style="padding:8px 16px;background:linear-gradient(135deg, #4a90e2 0%, #357abd 100%);color:white;border:none;border-radius:6px;cursor:pointer;font-weight:bold;box-shadow:0 2px 4px rgba(74,144,226,0.3);transition:all 0.2s ease;">
                    🎮 Play Now
                  </button>
                </div>
              </div>
            `).join('')}
          </div>
          
          <div style="margin-top:24px;padding:16px;background:linear-gradient(135deg, #e3f2fd 0%, #f8f9fa 100%);border-radius:8px;border-left:4px solid #4a90e2;">
            <h4 style="color:#1976d2;margin:0 0 8px 0;">🎯 Game Tips:</h4>
            <ul style="margin:0;padding-left:20px;color:#666;font-size:14px;">
              <li>Start with easier games to build confidence</li>
              <li>Use the audio features to improve pronunciation</li>
              <li>Take your time and don't rush through the games</li>
              <li>Review your mistakes to learn from them</li>
            </ul>
          </div>
        </div>
      `;
    }

    // Stage 13 - Audio Learning
    function renderAudioLearningStage(){
      const audioContent = [
        {
          title: "Pronunciation Practice",
          description: "Listen and repeat words with correct pronunciation",
          type: "pronunciation",
          categories: [
            {
              name: "Basic Greetings",
              words: [
                {word: "hello", phonetic: "/həˈloʊ/", meaning: "مرحبا"},
                {word: "goodbye", phonetic: "/ɡʊdˈbaɪ/", meaning: "وداعا"},
                {word: "thank you", phonetic: "/θæŋk ju/", meaning: "شكرا"},
                {word: "please", phonetic: "/pliːz/", meaning: "من فضلك"},
                {word: "sorry", phonetic: "/ˈsɔːri/", meaning: "آسف"},
                {word: "excuse me", phonetic: "/ɪkˈskjuːz mi/", meaning: "اعذرني"}
              ]
            },
            {
              name: "Numbers",
              words: [
                {word: "one", phonetic: "/wʌn/", meaning: "واحد"},
                {word: "two", phonetic: "/tuː/", meaning: "اثنان"},
                {word: "three", phonetic: "/θriː/", meaning: "ثلاثة"},
                {word: "four", phonetic: "/fɔːr/", meaning: "أربعة"},
                {word: "five", phonetic: "/faɪv/", meaning: "خمسة"},
                {word: "ten", phonetic: "/ten/", meaning: "عشرة"}
              ]
            },
            {
              name: "Colors",
              words: [
                {word: "red", phonetic: "/red/", meaning: "أحمر"},
                {word: "blue", phonetic: "/bluː/", meaning: "أزرق"},
                {word: "green", phonetic: "/ɡriːn/", meaning: "أخضر"},
                {word: "yellow", phonetic: "/ˈjeloʊ/", meaning: "أصفر"},
                {word: "black", phonetic: "/blæk/", meaning: "أسود"},
                {word: "white", phonetic: "/waɪt/", meaning: "أبيض"}
              ]
            }
          ]
        },
        {
          title: "Listening Comprehension",
          description: "Listen to stories and answer questions",
          type: "listening",
          stories: [
            {
              title: "The Little Red Hen",
              text: "Once upon a time, there was a little red hen who lived on a farm. She found some wheat seeds and asked her friends to help her plant them. But the duck, the cat, and the dog were too lazy to help. So the little red hen planted the seeds herself, watered them, and harvested the wheat. When she made bread, her friends wanted to eat it, but she said, 'No, you didn't help me, so you can't have any bread.'",
              level: "Beginner",
              questions: [
                {q: "What color was the hen?", a: "Red", options: ["Red", "Blue", "Green", "Yellow"]},
                {q: "Where did she live?", a: "On a farm", options: ["In a city", "On a farm", "In a forest", "By the sea"]},
                {q: "What did she find?", a: "Wheat seeds", options: ["Corn", "Wheat seeds", "Rice", "Beans"]},
                {q: "Who were her friends?", a: "Duck, cat, and dog", options: ["Duck, cat, and dog", "Mouse and bird", "Fish and frog", "Rabbit and squirrel"]},
                {q: "What did she make at the end?", a: "Bread", options: ["Cake", "Bread", "Cookies", "Pie"]}
              ]
            },
            {
              title: "The Magic Garden",
              text: "In a small village, there was a beautiful garden that belonged to an old woman named Mrs. Green. The garden was famous for its magical flowers that changed colors every season. In spring, the flowers were pink and yellow. In summer, they turned bright red and orange. In autumn, they became golden and brown. In winter, they sparkled like diamonds in the snow. People from all over the village came to see this amazing garden, and Mrs. Green was always happy to show them around.",
              level: "Intermediate",
              questions: [
                {q: "Who owned the magic garden?", a: "Mrs. Green", options: ["Mrs. Green", "Mr. Brown", "Dr. Smith", "Miss White"]},
                {q: "What was special about the flowers?", a: "They changed colors every season", options: ["They were very big", "They changed colors every season", "They smelled wonderful", "They never died"]},
                {q: "What colors were the flowers in spring?", a: "Pink and yellow", options: ["Red and orange", "Pink and yellow", "Golden and brown", "Blue and purple"]},
                {q: "What did the flowers look like in winter?", a: "They sparkled like diamonds", options: ["They were green", "They sparkled like diamonds", "They were invisible", "They were black"]},
                {q: "Why did people visit the garden?", a: "To see the amazing flowers", options: ["To buy flowers", "To see the amazing flowers", "To work there", "To live there"]}
              ]
            }
          ]
        },
        {
          title: "Conversation Practice",
          description: "Listen to conversations and practice speaking",
          type: "conversation",
          dialogues: [
            {
              title: "At the Store",
              level: "Beginner",
              lines: [
                "Shopkeeper: Hello! How can I help you today?",
                "Customer: Hi! I'm looking for some apples.",
                "Shopkeeper: We have fresh red apples over there.",
                "Customer: How much do they cost?",
                "Shopkeeper: They are $2 per pound.",
                "Customer: Perfect! I'll take two pounds, please.",
                "Shopkeeper: That will be $4. Would you like anything else?",
                "Customer: No, thank you. Here's $5.",
                "Shopkeeper: Thank you! Here's your change and your apples.",
                "Customer: Thank you! Have a great day!"
              ]
            },
            {
              title: "At the Restaurant",
              level: "Intermediate",
              lines: [
                "Waiter: Good evening! Welcome to our restaurant. How many people?",
                "Customer: Good evening! We are two people.",
                "Waiter: Right this way, please. Here are your menus.",
                "Customer: Thank you. Could you tell me what you recommend?",
                "Waiter: Our fish is very fresh today, and the pasta is excellent.",
                "Customer: I'll have the fish, please. And my friend will have the pasta.",
                "Waiter: Excellent choices! Would you like anything to drink?",
                "Customer: Yes, we'll have water and coffee, please.",
                "Waiter: Perfect! I'll bring your order right away.",
                "Customer: Thank you very much!"
              ]
            },
            {
              title: "Job Interview",
              level: "Advanced",
              lines: [
                "Interviewer: Good morning! Please have a seat. Tell me about yourself.",
                "Candidate: Good morning! Thank you for this opportunity. I'm a recent graduate with a degree in computer science.",
                "Interviewer: That's great! What experience do you have in programming?",
                "Candidate: I've worked on several projects during my studies, including a mobile app and a website.",
                "Interviewer: Excellent! What are your strengths?",
                "Candidate: I'm a quick learner, I work well in teams, and I'm very organized.",
                "Interviewer: Why do you want to work for our company?",
                "Candidate: I'm impressed by your company's innovative approach and I'd love to contribute to your team.",
                "Interviewer: That's wonderful! Do you have any questions for us?",
                "Candidate: Yes, what opportunities are there for professional development?",
                "Interviewer: We offer training programs and encourage continuous learning. Thank you for coming today!"
              ]
            }
          ]
        },
        {
          title: "Phonetic Drills",
          description: "Practice difficult sounds and pronunciation",
          type: "phonetics",
          sounds: [
            {
              sound: "TH",
              words: ["think", "thank", "three", "through", "bath", "math"],
              description: "Place your tongue between your teeth and blow air out"
            },
            {
              sound: "R",
              words: ["red", "run", "right", "rain", "car", "far"],
              description: "Curl your tongue back without touching the roof of your mouth"
            },
            {
              sound: "L",
              words: ["light", "love", "learn", "long", "ball", "call"],
              description: "Touch the tip of your tongue to the roof of your mouth"
            },
            {
              sound: "V",
              words: ["very", "voice", "visit", "love", "five", "seven"],
              description: "Bite your lower lip gently and make a buzzing sound"
            }
          ]
        }
      ];
      
      stageContent.innerHTML = `
        <div class="card">
          <h3>Audio Learning Center</h3>
          <p>Improve your listening and speaking skills with audio content.</p>
          <div class="audio-content" style="margin-top:16px;">
            ${audioContent.map((section, index) => `
              <div class="audio-section" style="padding:16px;margin:12px 0;border:2px solid #e5e7eb;border-radius:8px;">
                <h4 style="color:#4a90e2;margin-bottom:8px;">${section.title}</h4>
                <p style="color:#666;margin-bottom:12px;">${section.description}</p>
                ${section.words ? `
                  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:8px;margin-bottom:12px;">
                    ${section.words.map(word => `
                      <div style="padding:8px;background:#f8f9fa;border-radius:4px;text-align:center;">
                        <button onclick="speak('${word}')" style="padding:4px 8px;background:#4a90e2;color:white;border:none;border-radius:4px;cursor:pointer;margin-right:8px;">🔊</button>
                        <strong>${word}</strong>
                      </div>
                    `).join('')}
                  </div>
                ` : ''}
                ${section.stories ? `
                  <div class="story-content">
                    ${section.stories.map(story => `
                      <div style="background:#f8f9fa;padding:12px;border-radius:6px;margin-bottom:12px;">
                        <h5 style="color:#1976d2;margin-bottom:8px;">${story.title}</h5>
                        <p style="margin-bottom:12px;">${story.text}</p>
                        <button onclick="speak('${story.text}')" style="padding:8px 16px;background:#4a90e2;color:white;border:none;border-radius:6px;cursor:pointer;margin-right:8px;">🔊 Listen</button>
                        <button onclick="showQuestions('${story.title}')" style="padding:8px 16px;background:#10b981;color:white;border:none;border-radius:6px;cursor:pointer;">❓ Questions</button>
                      </div>
                    `).join('')}
                  </div>
                ` : ''}
                ${section.dialogues ? `
                  <div class="dialogue-content">
                    ${section.dialogues.map(dialogue => `
                      <div style="background:#f8f9fa;padding:12px;border-radius:6px;margin-bottom:12px;">
                        <h5 style="color:#1976d2;margin-bottom:8px;">${dialogue.title}</h5>
                        <div style="margin-bottom:12px;">
                          ${dialogue.lines.map(line => `
                            <div style="margin:4px 0;padding:4px;background:white;border-radius:4px;">${line}</div>
                          `).join('')}
                        </div>
                        <button onclick="speak('${dialogue.lines.join(' ')}')" style="padding:8px 16px;background:#4a90e2;color:white;border:none;border-radius:6px;cursor:pointer;">🔊 Listen to Dialogue</button>
                      </div>
                    `).join('')}
                  </div>
                ` : ''}
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    // Stage 14 - Learning Tools
    function renderLearningToolsStage(){
      const learningTools = [
        {
          title: "Picture Dictionary",
          description: "Visual dictionary with pictures, pronunciations, and translations",
          type: "dictionary",
          categories: [
            {
              name: "Animals",
              words: [
                {word: "cat", emoji: "🐱", phonetic: "/kæt/", meaning: "قط", example: "The cat is sleeping"},
                {word: "dog", emoji: "🐶", phonetic: "/dɔːɡ/", meaning: "كلب", example: "The dog is playing"},
                {word: "bird", emoji: "🐦", phonetic: "/bɜːrd/", meaning: "طائر", example: "The bird is flying"},
                {word: "fish", emoji: "🐟", phonetic: "/fɪʃ/", meaning: "سمكة", example: "The fish is swimming"}
              ]
            },
            {
              name: "Food",
              words: [
                {word: "apple", emoji: "🍎", phonetic: "/ˈæpəl/", meaning: "تفاحة", example: "I eat an apple"},
                {word: "bread", emoji: "🍞", phonetic: "/bred/", meaning: "خبز", example: "The bread is fresh"},
                {word: "milk", emoji: "🥛", phonetic: "/mɪlk/", meaning: "حليب", example: "I drink milk"},
                {word: "water", emoji: "💧", phonetic: "/ˈwɔːtər/", meaning: "ماء", example: "Water is important"}
              ]
            },
            {
              name: "Colors",
              words: [
                {word: "red", emoji: "🔴", phonetic: "/red/", meaning: "أحمر", example: "The apple is red"},
                {word: "blue", emoji: "🔵", phonetic: "/bluː/", meaning: "أزرق", example: "The sky is blue"},
                {word: "green", emoji: "🟢", phonetic: "/ɡriːn/", meaning: "أخضر", example: "The grass is green"},
                {word: "yellow", emoji: "🟡", phonetic: "/ˈjeloʊ/", meaning: "أصفر", example: "The sun is yellow"}
              ]
            }
          ]
        },
        {
          title: "Grammar Checker",
          description: "Check your grammar and get suggestions for improvement",
          type: "grammar",
          features: [
            "Check sentence structure",
            "Find spelling mistakes",
            "Suggest better words",
            "Explain grammar rules"
          ]
        },
        {
          title: "Vocabulary Builder",
          description: "Learn new words with flashcards and quizzes",
          type: "vocabulary",
          levels: [
            {level: "Beginner", words: 50, description: "Basic everyday words"},
            {level: "Intermediate", words: 100, description: "Common conversation words"},
            {level: "Advanced", words: 200, description: "Complex and academic words"}
          ]
        },
        {
          title: "Progress Tracker",
          description: "Track your learning progress and achievements",
          type: "progress",
          stats: [
            {name: "Words Learned", value: "0", total: "500"},
            {name: "Games Played", value: "0", total: "100"},
            {name: "Days Streak", value: "0", total: "365"},
            {name: "Hours Studied", value: "0", total: "1000"}
          ]
        }
      ];
      
      stageContent.innerHTML = `
        <div class="card">
          <h3>Learning Tools</h3>
          <p>Comprehensive tools to enhance your English learning experience.</p>
          <div class="tools-container" style="margin-top:16px;">
            ${learningTools.map((tool, index) => `
              <div class="tool-section" style="padding:16px;margin:12px 0;border:2px solid #e5e7eb;border-radius:8px;">
                <h4 style="color:#4a90e2;margin-bottom:12px;">${tool.title}</h4>
                <p style="color:#666;margin-bottom:12px;">${tool.description}</p>
                
                ${tool.categories ? `
                  <div style="margin-bottom:16px;">
                    ${tool.categories.map(category => `
                      <div style="margin-bottom:16px;">
                        <h5 style="color:#1976d2;margin-bottom:8px;">${category.name}</h5>
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:8px;">
                          ${category.words.map(word => `
                            <div style="padding:12px;background:#f8f9fa;border-radius:6px;text-align:center;">
                              <div style="font-size:24px;margin-bottom:4px;">${word.emoji}</div>
                              <div style="font-size:16px;font-weight:bold;color:#4a90e2;margin-bottom:4px;">${word.word}</div>
                              <div style="font-size:12px;color:#666;margin-bottom:4px;">${word.phonetic}</div>
                              <div style="font-size:12px;color:#666;margin-bottom:8px;">${word.meaning}</div>
                              <div style="font-size:11px;color:#999;margin-bottom:8px;">${word.example}</div>
                              <button onclick="speak('${word.word}')" style="padding:4px 8px;background:#4a90e2;color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px;">🔊</button>
                              <button onclick="addToFavorites('${word.word}')" style="padding:4px 8px;background:#ff9800;color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px;margin-left:4px;">⭐</button>
                            </div>
                          `).join('')}
                        </div>
                      </div>
                    `).join('')}
                  </div>
                ` : ''}
                
                ${tool.features ? `
                  <div style="background:#e3f2fd;padding:12px;border-radius:6px;margin-bottom:12px;">
                    <h5 style="color:#1976d2;margin-bottom:8px;">Features:</h5>
                    <ul style="margin:0;padding-left:20px;color:#666;">
                      ${tool.features.map(feature => `<li>${feature}</li>`).join('')}
                    </ul>
                  </div>
                ` : ''}
                
                ${tool.levels ? `
                  <div style="background:#e8f5e8;padding:12px;border-radius:6px;margin-bottom:12px;">
                    <h5 style="color:#2e7d32;margin-bottom:8px;">Learning Levels:</h5>
                    ${tool.levels.map(level => `
                      <div style="margin:8px 0;padding:8px;background:white;border-radius:4px;">
                        <strong>${level.level}</strong> - ${level.words} words
                        <br><small style="color:#666;">${level.description}</small>
                      </div>
                    `).join('')}
                  </div>
                ` : ''}
                
                ${tool.stats ? `
                  <div style="background:#fff3e0;padding:12px;border-radius:6px;">
                    <h5 style="color:#ff9800;margin-bottom:8px;">Your Progress:</h5>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:8px;">
                      ${tool.stats.map(stat => `
                        <div style="text-align:center;padding:8px;background:white;border-radius:4px;">
                          <div style="font-size:18px;font-weight:bold;color:#4a90e2;">${stat.value}</div>
                          <div style="font-size:12px;color:#666;">${stat.name}</div>
                          <div style="font-size:10px;color:#999;">of ${stat.total}</div>
                        </div>
                      `).join('')}
                    </div>
                  </div>
                ` : ''}
                
                <button onclick="useTool('${tool.type}')" style="padding:8px 16px;background:#4a90e2;color:white;border:none;border-radius:6px;cursor:pointer;margin-top:12px;">Use Tool</button>
              </div>
            `).join('')}
            
            <div class="tool-section" style="padding:16px;margin:12px 0;border:2px solid #e5e7eb;border-radius:8px;">
              <h4 style="color:#4a90e2;margin-bottom:12px;">⭐ My Favorites</h4>
              <p style="color:#666;margin-bottom:12px;">Save words you want to review later</p>
              <div id="favoritesList" style="min-height:100px;background:#f8f9fa;padding:12px;border-radius:6px;border:2px dashed #ccc;">
                <p style="color:#666;text-align:center;margin:20px 0;">No favorite words yet. Click the ⭐ button on any word to add it here!</p>
              </div>
            </div>
            
            <div class="tool-section" style="padding:16px;margin:12px 0;border:2px solid #e5e7eb;border-radius:8px;">
              <h4 style="color:#4a90e2;margin-bottom:12px;">🔄 Spaced Repetition</h4>
              <p style="color:#666;margin-bottom:12px;">Review words at optimal intervals for better retention</p>
              <div style="background:#e8f5e8;padding:12px;border-radius:6px;">
                <h5 style="color:#2e7d32;margin-bottom:8px;">Words to Review Today:</h5>
                <div id="reviewWords" style="margin:8px 0;">
                  <p style="color:#666;">No words scheduled for review today.</p>
                </div>
                <button onclick="startReview()" style="padding:8px 16px;background:#10b981;color:white;border:none;border-radius:6px;cursor:pointer;">Start Review Session</button>
              </div>
            </div>
            
            <div class="tool-section" style="padding:16px;margin:12px 0;border:2px solid #e5e7eb;border-radius:8px;">
              <h4 style="color:#4a90e2;margin-bottom:12px;">🌙 Dark Mode</h4>
              <p style="color:#666;margin-bottom:12px;">Switch to dark mode for comfortable learning</p>
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                <input type="checkbox" id="settingsDarkModeToggle" onchange="toggleDarkMode()" style="transform:scale(1.2);">
                <span>Enable Dark Mode</span>
              </label>
            </div>
          </div>
        </div>
      `;
    }

    // Stage 15 - Assessment & Certification
    function renderAssessmentStage(){
      const assessments = [
        {
          title: "Alphabet Knowledge Test",
          questions: [
            {q: "What letter comes after 'A'?", options: ["B", "C", "D", "Z"], correct: 0},
            {q: "What letter comes before 'M'?", options: ["K", "L", "N", "O"], correct: 1},
            {q: "How many letters are in the English alphabet?", options: ["24", "25", "26", "27"], correct: 2},
            {q: "What is the last letter of the alphabet?", options: ["X", "Y", "Z", "W"], correct: 2},
            {q: "Which letter is a vowel?", options: ["B", "C", "E", "F"], correct: 2}
          ]
        },
        {
          title: "Phonics & Pronunciation Test",
          questions: [
            {q: "What sound does 'B' make?", options: ["/b/", "/p/", "/d/", "/t/"], correct: 0},
            {q: "Which letter makes the /k/ sound?", options: ["C", "S", "Z", "X"], correct: 0},
            {q: "What sound does 'A' make in 'cat'?", options: ["/eɪ/", "/æ/", "/ɑ/", "/ə/"], correct: 1},
            {q: "Which letter is silent in 'knight'?", options: ["K", "N", "G", "H"], correct: 0},
            {q: "What sound does 'TH' make in 'think'?", options: ["/θ/", "/ð/", "/t/", "/d/"], correct: 0}
          ]
        },
        {
          title: "Vocabulary & Spelling Test",
          questions: [
            {q: "How do you spell 'DOG'?", options: ["D-O-G", "D-A-G", "D-U-G", "D-I-G"], correct: 0},
            {q: "What is the correct spelling of 'HOUSE'?", options: ["HOUSE", "HOUS", "HOUSSE", "HOUZE"], correct: 0},
            {q: "Which word means 'a place to read books'?", options: ["School", "Library", "Hospital", "Store"], correct: 1},
            {q: "What is the plural of 'cat'?", options: ["cat", "cats", "cates", "caties"], correct: 1},
            {q: "Which word is a color?", options: ["Book", "Red", "Tree", "Water"], correct: 1}
          ]
        }
      ];
      
      stageContent.innerHTML = `
        <div class="card">
          <h3>Assessment & Certification Center</h3>
          <p>Test your knowledge and earn certificates for your achievements.</p>
          <div class="assessment-content" style="margin-top:16px;">
            ${assessments.map((assessment, index) => `
              <div class="assessment-section" style="padding:16px;margin:12px 0;border:2px solid var(--border, #e5e7eb);border-radius:8px;background: var(--card-bg, white);">
                <h4 style="color: var(--primary-color, #4a90e2);margin-bottom:12px;">${assessment.title}</h4>
                <p style="color: var(--text-secondary, #666);margin-bottom:12px;">Test your knowledge in this area:</p>
                <div class="questions-container">
                  ${assessment.questions.map((question, qIndex) => `
                    <div class="question-card" style="padding:12px;margin:8px 0;background: var(--secondary-bg, #f8f9fa);border-radius:6px;">
                      <div style="margin-bottom:8px;">
                        <strong style="color: var(--text-primary, #333);">${qIndex + 1}. ${question.q}</strong>
                      </div>
                      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;">
                        ${question.options.map((option, oIndex) => `
                          <div style="padding:8px;background: var(--card-bg, white);border:2px solid var(--border, #e5e7eb);border-radius:4px;text-align:center;cursor:pointer;transition:all 0.2s;color: var(--text-primary, #333);" 
                               onmouseover="this.style.borderColor='var(--primary-color, #4a90e2)'; this.style.background='var(--button-bg, #e3f2fd)';" 
                               onmouseout="this.style.borderColor='var(--border, #e5e7eb)'; this.style.background='var(--card-bg, white)';"
                               onclick="this.style.background=this.style.background==='var(--success-bg, #e8f5e8)'?'var(--card-bg, white)':'var(--success-bg, #e8f5e8)'; this.style.borderColor=this.style.borderColor==='#10b981'?'var(--border, #e5e7eb)':'#10b981';">
                            ${option}
                          </div>
                        `).join('')}
                      </div>
                      <div style="margin-top:8px;padding:8px;background: var(--success-bg, #e8f5e8);border-radius:4px;display:none;" id="answer-${index}-${qIndex}">
                        <strong style="color: var(--success-color, #2e7d32);">Correct Answer: ${question.options[question.correct]}</strong>
                      </div>
                      <button onclick="document.getElementById('answer-${index}-${qIndex}').style.display=document.getElementById('answer-${index}-${qIndex}').style.display==='none'?'block':'none'" 
                              style="margin-top:8px;padding:4px 8px;background: var(--success-color, #10b981);color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px;">
                        Show Answer
                      </button>
                    </div>
                  `).join('')}
                </div>
              </div>
            `).join('')}
            
            <div class="progress-summary" style="padding:16px;margin:12px 0;border:2px solid #4a90e2;border-radius:8px;background:#e3f2fd;">
              <h4 style="color:#1976d2;margin-bottom:12px;">📊 Your Progress Summary</h4>
              <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;">
                <div style="text-align:center;padding:12px;background:white;border-radius:6px;">
                  <div class="stat-number" style="font-size:24px;font-weight:bold;color:#4a90e2;">${state.points}</div>
                  <div class="stat-label" style="color:#666;">Total Points</div>
                </div>
                <div style="text-align:center;padding:12px;background:white;border-radius:6px;">
                  <div class="stat-number" style="font-size:24px;font-weight:bold;color:#10b981;">${state.badges.length}</div>
                  <div class="stat-label" style="color:#666;">Badges Earned</div>
                </div>
                <div style="text-align:center;padding:12px;background:white;border-radius:6px;">
                  <div class="stat-number" style="font-size:24px;font-weight:bold;color:#ff9800;">${Object.keys(state.lettersMastered).length}</div>
                  <div class="stat-label" style="color:#666;">Letters Mastered</div>
                </div>
                <div style="text-align:center;padding:12px;background:white;border-radius:6px;">
                  <div class="stat-number" style="font-size:24px;font-weight:bold;color:#9c27b0;">${state.unlockedStages.length}</div>
                  <div class="stat-label" style="color:#666;">Stages Completed</div>
                </div>
              </div>
            </div>
            
            <div class="certificate" style="padding:20px;margin:12px 0;border:3px solid #10b981;border-radius:12px;background:linear-gradient(135deg,#f0fdf4,#e8f5e8);text-align:center;">
              <div style="font-size:48px;margin-bottom:16px;">🎓</div>
              <h3 style="color:#2e7d32;margin-bottom:12px;">Congratulations!</h3>
              <p style="color:#666;margin-bottom:16px;">You have successfully completed the English Alphabet Platform!</p>
              <div style="background:white;padding:16px;border-radius:8px;margin:16px 0;">
                <h4 style="color:#1976d2;margin-bottom:8px;">Certificate of Completion</h4>
                <p style="color:#666;margin-bottom:8px;">This certifies that the student has completed all 15 stages of the English Alphabet Platform, demonstrating proficiency in:</p>
                <ul style="text-align:left;color:#666;margin:8px 0;">
                  <li>Letter recognition and pronunciation</li>
                  <li>Basic vocabulary and spelling</li>
                  <li>Reading comprehension</li>
                  <li>Conversational English</li>
                  <li>Cultural awareness</li>
                </ul>
              </div>
              <button onclick="alert('Certificate download feature coming soon!')" style="padding:12px 24px;background:#10b981;color:white;border:none;border-radius:8px;cursor:pointer;font-size:16px;font-weight:bold;">
                📄 Download Certificate
              </button>
            </div>
            
            <div class="next-steps" style="padding:16px;margin:12px 0;border:2px solid #ff5722;border-radius:8px;background:#fff3e0;">
              <h4 style="color:#ff5722;margin-bottom:8px;">🏆 Next Steps</h4>
              <ul style="margin:0;padding-left:20px;color:#666;">
                <li>Continue practicing with more advanced materials</li>
                <li>Try reading English books and newspapers</li>
                <li>Practice speaking with native speakers</li>
                <li>Consider taking formal English courses</li>
                <li>Keep learning new vocabulary every day</li>
              </ul>
            </div>
          </div>
        </div>
      `;
    }

    // ---------- Game Functions ----------
    function startGame(gameType, gameData) {
      switch(gameType) {
        case 'memory':
          startMemoryGame(gameData.words);
          break;
        case 'crossword':
          startCrosswordGame(gameData.clues);
          break;
        case 'guessing':
          startGuessingGame(gameData.items);
          break;
        case 'sentence':
          startSentenceGame(gameData.sentences);
          break;
        case 'wordsearch':
          startWordSearch();
          break;
        case 'spelling':
          startSpellingBee();
          break;
      }
    }

    function startMemoryGame(words) {
      stageContent.innerHTML = `
        <div class="card">
          <h3>Memory Game</h3>
          <p>Match the words with their meanings!</p>
          <div id="memoryBoard" style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:16px;">
            ${words.map((word, index) => `
              <div class="memory-card" onclick="flipCard(${index})" style="height:80px;background:#f8f9fa;border:2px solid #e5e7eb;border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-weight:bold;">
                ${word}
              </div>
            `).join('')}
          </div>
          <button onclick="renderInteractiveGamesStage()" style="margin-top:16px;padding:8px 16px;background:#4a90e2;color:white;border:none;border-radius:6px;cursor:pointer;">Back to Games</button>
        </div>
      `;
    }

    function startCrosswordGame(clues) {
      stageContent.innerHTML = `
        <div class="card">
          <h3>Crossword Puzzle</h3>
          <p>Solve the crossword by filling in the correct words!</p>
          <div style="margin-top:16px;">
            ${clues.map((clue, index) => `
              <div style="margin:12px 0;padding:12px;background:#f8f9fa;border-radius:6px;">
                <strong>${index + 1}. ${clue.clue}</strong>
                <input type="text" id="answer${index}" style="margin-left:12px;padding:4px 8px;border:1px solid #ccc;border-radius:4px;" placeholder="Your answer">
                <button onclick="checkAnswer(${index}, '${clue.answer}')" style="margin-left:8px;padding:4px 8px;background:#10b981;color:white;border:none;border-radius:4px;cursor:pointer;">Check</button>
              </div>
            `).join('')}
          </div>
          <button onclick="renderInteractiveGamesStage()" style="margin-top:16px;padding:8px 16px;background:#4a90e2;color:white;border:none;border-radius:6px;cursor:pointer;">Back to Games</button>
        </div>
      `;
    }

    function startGuessingGame(items) {
      let currentItem = 0;
      let currentClue = 0;
      
      function showNextClue() {
        if (currentItem < items.length) {
          const item = items[currentItem];
          if (currentClue < item.clues.length) {
            stageContent.innerHTML = `
              <div class="card">
                <h3>Who Am I? Game</h3>
                <p>Guess the word from the clues!</p>
                <div style="margin:20px 0;padding:20px;background:#f8f9fa;border-radius:8px;text-align:center;">
                  <h4>Clue ${currentClue + 1}:</h4>
                  <p style="font-size:18px;margin:16px 0;">${item.clues[currentClue]}</p>
                  <input type="text" id="guessInput" style="padding:8px 16px;font-size:16px;border:2px solid #4a90e2;border-radius:6px;margin:8px;" placeholder="Your guess">
                  <br>
                  <button onclick="checkGuess('${item.answer}')" style="padding:8px 16px;background:#4a90e2;color:white;border:none;border-radius:6px;cursor:pointer;margin:8px;">Guess</button>
                  <button onclick="showNextClue()" style="padding:8px 16px;background:#ff9800;color:white;border:none;border-radius:6px;cursor:pointer;margin:8px;">Next Clue</button>
                </div>
                <button onclick="renderInteractiveGamesStage()" style="padding:8px 16px;background:#666;color:white;border:none;border-radius:6px;cursor:pointer;">Back to Games</button>
              </div>
            `;
          }
        }
      }
      
      showNextClue();
    }

    function startSentenceGame(sentences) {
      let currentSentence = 0;
      
      function showNextSentence() {
        if (currentSentence < sentences.length) {
          const sentence = sentences[currentSentence];
          const shuffledWords = [...sentence.words].sort(() => Math.random() - 0.5);
          
          stageContent.innerHTML = `
            <div class="card">
              <h3>Sentence Builder</h3>
              <p>Arrange the words to make a correct sentence!</p>
              <div style="margin:20px 0;">
                <div id="wordContainer" style="display:flex;flex-wrap:wrap;gap:8px;margin:16px 0;min-height:60px;border:2px dashed #ccc;padding:12px;border-radius:6px;">
                  ${shuffledWords.map((word, index) => `
                    <span class="word-item" onclick="selectWord(this)" style="padding:8px 12px;background:#4a90e2;color:white;border-radius:4px;cursor:pointer;user-select:none;">${word}</span>
                  `).join('')}
                </div>
                <div id="sentenceContainer" style="display:flex;flex-wrap:wrap;gap:8px;margin:16px 0;min-height:60px;border:2px solid #e5e7eb;padding:12px;border-radius:6px;">
                  <p style="color:#666;margin:0;">Arrange words here...</p>
                </div>
                <button onclick="checkSentence('${sentence.correct}')" style="padding:8px 16px;background:#10b981;color:white;border:none;border-radius:6px;cursor:pointer;margin:8px;">Check Answer</button>
                <button onclick="showNextSentence()" style="padding:8px 16px;background:#ff9800;color:white;border:none;border-radius:6px;cursor:pointer;margin:8px;">Next Sentence</button>
              </div>
              <button onclick="renderInteractiveGamesStage()" style="padding:8px 16px;background:#666;color:white;border:none;border-radius:6px;cursor:pointer;">Back to Games</button>
            </div>
          `;
        }
      }
      
      showNextSentence();
    }

    function checkAnswer(index, correctAnswer) {
      const userAnswer = document.getElementById(`answer${index}`).value.toLowerCase();
      if (userAnswer === correctAnswer.toLowerCase()) {
        alert('Correct! 🎉');
        document.getElementById(`answer${index}`).style.background = '#e8f5e8';
      } else {
        alert('Try again! The correct answer is: ' + correctAnswer);
      }
    }

    function checkGuess(correctAnswer) {
      const userGuess = document.getElementById('guessInput').value.toLowerCase();
      if (userGuess === correctAnswer.toLowerCase()) {
        alert('Correct! 🎉 The answer is: ' + correctAnswer);
        currentItem++;
        currentClue = 0;
        if (currentItem < items.length) {
          showNextClue();
        } else {
          alert('Congratulations! You completed the game!');
          renderInteractiveGamesStage();
        }
      } else {
        alert('Try again!');
      }
    }

    function selectWord(element) {
      const sentenceContainer = document.getElementById('sentenceContainer');
      if (sentenceContainer.querySelector('p')) {
        sentenceContainer.innerHTML = '';
      }
      sentenceContainer.appendChild(element);
    }

    function checkSentence(correctSentence) {
      const words = Array.from(document.getElementById('sentenceContainer').children)
        .map(el => el.textContent)
        .join(' ');
      
      if (words.toLowerCase() === correctSentence.toLowerCase()) {
        alert('Correct! 🎉');
        currentSentence++;
        if (currentSentence < sentences.length) {
          showNextSentence();
        } else {
          alert('Congratulations! You completed all sentences!');
          renderInteractiveGamesStage();
        }
      } else {
        alert('Try again! The correct sentence is: ' + correctSentence);
      }
    }

    function flipCard(index) {
      // Simple memory game implementation
      alert('Memory game feature coming soon!');
    }

    function showQuestions(storyTitle) {
      alert('Questions for ' + storyTitle + ' coming soon!');
    }

    function startReview() {
      alert('Review session starting soon!');
    }


    function toggleDarkMode() {
      state.preferences.darkMode = !state.preferences.darkMode;
      document.body.classList.toggle('dark-mode', state.preferences.darkMode);
      document.getElementById('darkModeToggle').textContent = state.preferences.darkMode ? '☀️' : '🌙';
      saveState();
      showNotification(state.preferences.darkMode ? '🌙 Dark mode enabled' : '☀️ Light mode enabled', 'info');
    }

    function addToFavorites(word) {
      const favoritesList = document.getElementById('favoritesList');
      if (favoritesList) {
        const existingFavorites = favoritesList.querySelectorAll('.favorite-word');
        if (existingFavorites.length === 0) {
          favoritesList.innerHTML = '';
        }
        
        const favoriteDiv = document.createElement('div');
        favoriteDiv.className = 'favorite-word';
        favoriteDiv.style.cssText = 'display:inline-block;margin:4px;padding:8px 12px;background:#ff9800;color:white;border-radius:4px;font-size:14px;';
        favoriteDiv.innerHTML = `${word} <button onclick="removeFromFavorites(this)" style="margin-left:8px;background:none;border:none;color:white;cursor:pointer;">×</button>`;
        
        favoritesList.appendChild(favoriteDiv);
      }
    }

    function removeFromFavorites(button) {
      button.parentElement.remove();
      const favoritesList = document.getElementById('favoritesList');
      if (favoritesList && favoritesList.children.length === 0) {
        favoritesList.innerHTML = '<p style="color:#666;text-align:center;margin:20px 0;">No favorite words yet. Click the ⭐ button on any word to add it here!</p>';
      }
    }

    function useTool(toolType) {
      switch(toolType) {
        case 'dictionary':
          alert('Picture Dictionary is now active! Click on any word to see its details.');
          break;
        case 'grammar':
          alert('Grammar Checker is now active! Type a sentence to check its grammar.');
          break;
        case 'vocabulary':
          alert('Vocabulary Builder is now active! Start learning new words with flashcards.');
          break;
        case 'progress':
          alert('Progress Tracker is now active! Your progress is being tracked automatically.');
          break;
      }
    }

    function startWordSearch() {
      stageContent.innerHTML = `
        <div class="card">
          <h3>Word Search Game</h3>
          <p>Find the hidden words in the grid!</p>
          <div style="margin:20px 0;">
            <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px;margin:16px 0;">
              ${["C","A","T","B","O","O","K","D","O","G","H","O","U","S","T","R","E","E","C","A","R","B","A","L","L","S","U","N"].map(letter => 
                `<div style="width:40px;height:40px;border:1px solid #ccc;display:flex;align-items:center;justify-content:center;background:#f8f9fa;font-weight:bold;">${letter}</div>`
              ).join('')}
            </div>
            <div style="margin:16px 0;">
              <h4>Words to find:</h4>
              <div style="display:flex;flex-wrap:wrap;gap:8px;">
                ${["cat", "dog", "book", "house", "tree", "car", "ball", "sun"].map(word => 
                  `<span style="padding:4px 8px;background:#e3f2fd;border-radius:4px;font-weight:bold;">${word}</span>`
                ).join('')}
              </div>
            </div>
            <button onclick="renderInteractiveGamesStage()" style="padding:8px 16px;background:#4a90e2;color:white;border:none;border-radius:6px;cursor:pointer;">Back to Games</button>
          </div>
        </div>
      `;
    }

    function startSpellingBee() {
      let currentWordIndex = 0;
      const words = [
        {word: "hello", difficulty: "Easy", points: 10},
        {word: "beautiful", difficulty: "Medium", points: 20},
        {word: "elephant", difficulty: "Medium", points: 20},
        {word: "chocolate", difficulty: "Hard", points: 30},
        {word: "restaurant", difficulty: "Hard", points: 30},
        {word: "adventure", difficulty: "Hard", points: 30}
      ];
      
      function showNextWord() {
        if (currentWordIndex < words.length) {
          const word = words[currentWordIndex];
          stageContent.innerHTML = `
            <div class="card">
              <h3>Spelling Bee</h3>
              <p>Spell the word correctly to earn points!</p>
              <div style="margin:20px 0;text-align:center;">
                <h4>Word ${currentWordIndex + 1} of ${words.length}</h4>
                <div style="font-size:24px;margin:16px 0;color:#4a90e2;">${word.word}</div>
                <div style="margin:8px 0;">
                  <span style="padding:4px 8px;background:#e3f2fd;border-radius:4px;margin-right:8px;">${word.difficulty}</span>
                  <span style="padding:4px 8px;background:#e8f5e8;border-radius:4px;">${word.points} points</span>
                </div>
                <input type="text" id="spellingInput" style="padding:8px 16px;font-size:18px;border:2px solid #4a90e2;border-radius:6px;margin:16px 0;width:300px;" placeholder="Type the word here">
                <br>
                <button onclick="checkSpelling('${word.word}', ${word.points})" style="padding:8px 16px;background:#10b981;color:white;border:none;border-radius:6px;cursor:pointer;margin:8px;">Check Spelling</button>
                <button onclick="skipWord()" style="padding:8px 16px;background:#ff9800;color:white;border:none;border-radius:6px;cursor:pointer;margin:8px;">Skip Word</button>
              </div>
              <button onclick="renderInteractiveGamesStage()" style="padding:8px 16px;background:#666;color:white;border:none;border-radius:6px;cursor:pointer;">Back to Games</button>
            </div>
          `;
        } else {
          alert('Congratulations! You completed the Spelling Bee!');
          renderInteractiveGamesStage();
        }
      }
      
      showNextWord();
    }

    function checkSpelling(correctWord, points) {
      const userInput = document.getElementById('spellingInput').value.toLowerCase();
      if (userInput === correctWord.toLowerCase()) {
        alert(`Correct! You earned ${points} points! 🎉`);
        currentWordIndex++;
        if (currentWordIndex < words.length) {
          showNextWord();
        } else {
          alert('Congratulations! You completed all words!');
          renderInteractiveGamesStage();
        }
      } else {
        alert(`Incorrect! The correct spelling is: ${correctWord}`);
      }
    }

    function skipWord() {
      currentWordIndex++;
      if (currentWordIndex < words.length) {
        showNextWord();
      } else {
        alert('You completed the Spelling Bee!');
        renderInteractiveGamesStage();
      }
    }

    function getGameEmoji(gameType) {
      const emojis = {
        'memory': '🧠',
        'crossword': '📝',
        'guessing': '🤔',
        'sentence': '📝',
        'wordsearch': '🔍',
        'spelling': '✍️'
      };
      return emojis[gameType] || '🎮';
    }

    function getGameDifficulty(gameType) {
      const difficulties = {
        'memory': 'Easy',
        'crossword': 'Medium',
        'guessing': 'Easy',
        'sentence': 'Medium',
        'wordsearch': 'Easy',
        'spelling': 'Hard'
      };
      return difficulties[gameType] || 'Medium';
    }

    // ---------- Controls ----------
    const playPronounceBtn = document.getElementById('playPronounce');
    if (playPronounceBtn) {
      playPronounceBtn.addEventListener('click', () => { 
        const letter = currentLabel.textContent; 
        speak(letter);
      });
    }
    
    document.getElementById('nextLetter').addEventListener('click', () => { 
      state.currentLetterIndex = (state.currentLetterIndex + 1) % LETTERS.length; 
      saveState(); 
      renderStage(); 
    });
    
    const speakAllBtn = document.getElementById('speakAll');
    if (speakAllBtn) {
      speakAllBtn.addEventListener('click', async () => { 
        for (let i = 0; i < LETTERS.length; i++) {
          const L = LETTERS[i];
          await speakSync(L, {rate: 0.8, pitch: 1.0});
          // Small pause between letters
          await new Promise(resolve => setTimeout(resolve, 200));
        }
        showNotification('🔊 Finished playing all letters!', 'success');
      });
    }
    
    document.getElementById('resetProgress').addEventListener('click', () => { 
      if (confirm('Are you sure you want to reset all progress? This cannot be undone.')) {
        localStorage.removeItem(STORAGE_KEY);
        state = {
          unlockedStages: [1],
          currentStage: 1,
          currentLetterIndex: 0,
          points: 0,
          badges: [],
          lettersMastered: {},
          achievements: [],
          totalTimeSpent: 0,
          sessionStartTime: Date.now(),
          preferences: {
            soundEnabled: true,
            arabicTranslit: false,
            highContrast: false,
            darkMode: false
          },
          progress: {
            stagesCompleted: 0,
            lettersLearned: 0,
            wordsLearned: 0,
            gamesPlayed: 0
          }
        };
        loadState();
        saveState();
        renderStage();
        showNotification('Progress reset successfully!', 'info');
      }
    });
    
    // Dark mode toggle
    document.getElementById('darkModeToggle').addEventListener('click', () => {
      state.preferences.darkMode = !state.preferences.darkMode;
      document.body.classList.toggle('dark-mode', state.preferences.darkMode);
      document.getElementById('darkModeToggle').textContent = state.preferences.darkMode ? '☀️' : '🌙';
      saveState();
      showNotification(state.preferences.darkMode ? '🌙 Dark mode enabled' : '☀️ Light mode enabled', 'info');
    });
    
    // Test sound button
    const testSoundBtn = document.getElementById('testSound');
    if (testSoundBtn) {
      testSoundBtn.addEventListener('click', async () => {
        showNotification('🔊 Testing sound - A', 'info');
        await speakSync('A', {rate: 0.8, pitch: 1.0});
        showNotification('🔊 Sound test completed!', 'success');
      });
    }

    // Audio manager button
    document.getElementById('audioManagerBtn').addEventListener('click', () => {
      showAudioManager();
    });
    
    // Unlock all stages for testing
    document.getElementById('unlockAllStages').addEventListener('click', () => {
      state.unlockedStages = [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20];
      saveState();
      updateUI();
      showNotification('🔓 All stages unlocked for testing!', 'success');
    });
    
    // Also add a global click handler for stage buttons as backup
    document.addEventListener('click', (e) => {
      if (e.target.closest('.stage-button')) {
        const button = e.target.closest('.stage-button');
        const stageId = parseInt(button.dataset.stageId);
        if (stageId && !button.disabled) {
          state.currentStage = stageId;
          state.currentLetterIndex = 0;
          saveState();
          renderSpecificStage(stageId);
        }
      }
    });
    
    // Settings checkboxes
    document.getElementById('translitCheckbox').addEventListener('change', (e) => {
      state.preferences.arabicTranslit = e.target.checked;
      updateTransliteration();
      saveState();
    });
    
    document.getElementById('soundCheckbox').addEventListener('change', (e) => {
      state.preferences.soundEnabled = e.target.checked;
      saveState();
    });
    
    document.getElementById('highContrastCheckbox').addEventListener('change', (e) => {
      state.preferences.highContrast = e.target.checked;
      document.body.classList.toggle('high-contrast', e.target.checked);
      saveState();
    });

    // Enhanced keyboard accessibility
    document.addEventListener('keydown', e => {
      // Arrow keys to navigate letters
      if (e.key === 'ArrowRight') { 
        state.currentLetterIndex = (state.currentLetterIndex + 1) % LETTERS.length; 
        saveState(); 
        renderStage(); 
      }
      if (e.key === 'ArrowLeft') { 
        state.currentLetterIndex = (state.currentLetterIndex - 1 + LETTERS.length) % LETTERS.length; 
        saveState(); 
        renderStage(); 
      }
      
      // Space bar to pronounce current letter
      if (e.key === ' ' && e.target.tagName !== 'INPUT') {
        e.preventDefault();
        const letter = currentLabel.textContent;
        speak(letter);
      }
      
      // Enter key to go to next letter
      if (e.key === 'Enter' && e.target.tagName !== 'INPUT') {
        e.preventDefault();
        document.getElementById('nextLetter').click();
      }
    });

    // Initialize settings from saved preferences
    function initializeSettings() {
      const translitCheckbox = document.getElementById('translitCheckbox');
      const soundCheckbox = document.getElementById('soundCheckbox');
      const highContrastCheckbox = document.getElementById('highContrastCheckbox');
      const settingsDarkModeToggle = document.getElementById('settingsDarkModeToggle');
      
      if (translitCheckbox) translitCheckbox.checked = state.preferences.arabicTranslit;
      if (soundCheckbox) soundCheckbox.checked = state.preferences.soundEnabled;
      if (highContrastCheckbox) highContrastCheckbox.checked = state.preferences.highContrast;
      if (settingsDarkModeToggle) settingsDarkModeToggle.checked = state.preferences.darkMode;
      
      // Apply dark mode if enabled
      if (state.preferences.darkMode) {
        document.body.classList.add('dark-mode');
        document.getElementById('darkModeToggle').textContent = '☀️';
      }
      
      // Apply high contrast if enabled
      if (state.preferences.highContrast) {
        document.body.classList.add('high-contrast');
      }
    }

    // Session time tracking
    function updateSessionTime() {
      const now = Date.now();
      const sessionTime = now - state.sessionStartTime;
      state.totalTimeSpent += sessionTime;
      state.sessionStartTime = now;
      saveState();
    }

    // Initialize the platform
    function initialize() {
      loadState();
      
      // Ensure all stages are unlocked for testing
      const allStages = [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20];
      state.unlockedStages = allStages;
      saveState();
      
      initializeSettings();
      updateUI();
      renderStage();
      
      // Set up periodic saves and time tracking
      setInterval(updateSessionTime, 60000); // Update every minute
      
      // Show welcome message for new users
      if (state.points === 0 && Object.keys(state.lettersMastered).length === 0) {
        setTimeout(() => {
          showNotification('🚀 Welcome to English Learning Journey! Start by clicking on letters to learn them.', 'info');
        }, 1000);
      }
      
      // Debug: Log current state
    }

    // Test available voices
    function testVoices() {
      if ('speechSynthesis' in window) {
        const voices = speechSynthesis.getVoices();
        console.log('Available voices:', voices.length);
        voices.forEach((voice, index) => {
          console.log(`${index + 1}. ${voice.name} (${voice.lang}) - ${voice.voiceURI}`);
        });
        
        // Check for Arabic voices
        const arabicVoices = voices.filter(v => v.lang.startsWith('ar'));
        console.log('Arabic voices found:', arabicVoices.length);
        arabicVoices.forEach(voice => {
          console.log(`Arabic: ${voice.name} (${voice.lang})`);
        });
        
        // Test Arabic pronunciation
        if (arabicVoices.length > 0) {
          showNotification(`✅ Found ${arabicVoices.length} Arabic voice(s). Testing pronunciation...`, 'success');
          speak('مرحبا', {rate: 0.7, pitch: 0.8});
        } else {
          showNotification('⚠️ No Arabic voices found. Arabic text may not be pronounced correctly.', 'warning');
        }
      } else {
        showNotification('❌ Speech synthesis not supported in this browser', 'error');
      }
    }

    // Start the application when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      initialize();
      
      // Auto-enable mobile audio on first user interaction
      const enableAudioOnInteraction = () => {
        if (!state.audioContextInitialized) {
          // Force enable sound
          state.preferences.soundEnabled = true;
          const soundCheckbox = document.getElementById('soundCheckbox');
          if (soundCheckbox) {
            soundCheckbox.checked = true;
          }
          initializeAudioContext();
          showNotification('🔊 Audio enabled! Try any sound button now.', 'success');
        }
        // Remove listeners after first interaction
        document.removeEventListener('click', enableAudioOnInteraction);
        document.removeEventListener('touchstart', enableAudioOnInteraction);
      };
      
      // Add listeners for first user interaction
      document.addEventListener('click', enableAudioOnInteraction, { once: true });
      document.addEventListener('touchstart', enableAudioOnInteraction, { once: true });
      
      // Also try to enable audio on page visibility change (mobile browsers)
      document.addEventListener('visibilitychange', () => {
        if (!document.hidden && !state.audioContextInitialized) {
          enableAudioOnInteraction();
        }
      });
      
      // Check browser support on startup
      checkBrowserSupport();
      
      // Load voices for better Arabic support
      if ('speechSynthesis' in window) {
        speechSynthesis.onvoiceschanged = function() {
          // Voices are now loaded
          testVoices();
        };
        
        // Force load voices
        speechSynthesis.getVoices();
        
        // Test voices after a short delay
        setTimeout(() => {
          testVoices();
          showNotification('🔊 Voice system initialized. Click "Test Voices" to check Arabic support.', 'info');
        }, 1000);
      }
    });

    // ---------- Expandability notes (developer friendly) ----------
    // - Add full WORDS data up to Z, add images for picture cards (use <img> with alt text).
    // - Stage 4+ should use modular renderer functions and content templates; keep state in a small stores + sync to server when available.
    // - For sound recording and speaking evaluation (Stage 6), integrate WebAudio + speech recognition APIs or a lightweight server-based ASR.
    // - For PDF reports, generate with jsPDF on client or server-side for higher quality.
    // - PWA: add manifest.json + service-worker.js to cache assets & enable install.

  </script>
</body>
</html>
